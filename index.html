<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
     <title>WorkSmart - Calorie Tracker</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
  <style>
    :root{
      --bg: #0b0f14;
      --card: #121821;
      --muted: #8aa0b4;
      --text: #e9f0f6;
      --accent: #6ee7b7;
      --accent-2: #60a5fa;
      --danger: #f87171;
      --ring: rgba(110,231,183,.45);
      --radius: 18px;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:ui-sans-serif,system-ui;-webkit-font-smoothing:antialiased;color:var(--text);background:var(--bg);padding:24px}
    .wrap{max-width:880px;margin:0 auto}
    h1,h2,h3{text-align:center}
    .card{background:var(--card);border-radius:var(--radius);padding:18px;margin-bottom:18px}
    .field{margin-bottom:12px;text-align:left}
    .label{font-size:14px;color:var(--muted);margin-bottom:4px;display:block;text-align:left}
    input, select{width:100%;padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,.1);background:#0e141b;color:var(--text)}
    input[type="date"]{box-sizing:border-box;-webkit-appearance:none;-moz-appearance:none;appearance:none}
    button{padding:10px 16px;border-radius:10px;border:none;cursor:pointer;font-weight:600;display:block;margin:8px auto}
    .primary{background:linear-gradient(135deg,var(--accent),var(--accent-2));color:#081018}
    .ghost{background:transparent;color:var(--muted);border:1px solid rgba(255,255,255,.2)}
    .result{margin-top:10px;min-height:38px;text-align:left}
    .math{background:#0c1218;border:1px dashed rgba(255,255,255,.2);padding:8px;border-radius:10px;font-family:monospace;white-space:pre-wrap}
    canvas{background:#0e141b;border-radius:10px;padding:10px}
    .hidden{display:none}
    .menu-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .menu-tile{display:flex;flex-direction:column;align-items:center;gap:8px;padding:16px;border:1px solid rgba(255,255,255,.15);border-radius:14px;background:#0e141b;cursor:pointer}
    .menu-emoji{font-size:28px}
    .row{display:flex;gap:8px;justify-content:flex-start}
    
    /* Modal Styles */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.8);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      padding: 20px;
      overflow-y: auto;
    }
    
    .modal-overlay.hidden {
      display: none;
    }
    
    /* always above slides/titles on mobile */
    .modal-overlay { z-index: 9999 !important; }
    .modal { position: relative; z-index: 10000; }
    .modal {
      background: var(--card);
      border-radius: var(--radius);
      padding: 24px;
      max-width: 400px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
    }
    .modal-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 20px;
    }
    .modal-icon {
      font-size: 24px;
    }
    
    /* Modal Animated Fire Icon */
    .animated-fire-modal {
      display: inline-block;
      width: 24px;
      height: 24px;
    }
    
    .fire-svg-modal {
      width: 100%;
      height: 100%;
      filter: drop-shadow(0 0 8px rgba(255, 100, 0, 0.7)) drop-shadow(0 0 12px rgba(255, 150, 0, 0.3));
    }
    
    .modal-title {
      font-size: 24px;
      font-weight: bold;
      margin: 0;
    }
    .modal-subtitle {
      color: var(--muted);
      font-size: 14px;
      margin: 4px 0 0 0;
    }
    .auth-toggle {
      text-align: center;
      margin-top: 16px;
      color: var(--muted);
    }
    .auth-toggle a {
      color: var(--accent-2);
      text-decoration: none;
      cursor: pointer;
    }
    .error-message {
      color: var(--danger);
      font-size: 14px;
      margin-top: 8px;
      text-align: center;
    }
    .success-message {
      color: var(--accent);
      font-size: 14px;
      margin-top: 8px;
      text-align: center;
    }
    
    /* Profile Setup Styles */
    .profile-setup {
      text-align: center;
      margin-bottom: 20px;
    }
    .profile-setup h3 {
      margin-bottom: 16px;
    }
    
         /* Settings and Logout Section */
     .user-actions {
       display: flex;
       flex-direction: column;
       gap: 8px;
       margin-top: 16px;
       align-items: center;
     }
     .user-actions button {
       margin: 0;
       width: auto;
       min-width: 120px;
       background: linear-gradient(135deg,var(--accent),var(--accent-2));
       color: #081018;
     }
     .settings-btn {
       background: linear-gradient(135deg,var(--accent),var(--accent-2));
       color: #081018;
     }
     .logout-btn {
       background: linear-gradient(135deg,var(--accent),var(--accent-2));
       color: #081018;
     }
     .danger-btn {
       background: var(--danger);
       color: white;
     }
     
     /* Mobile Swipe Navigation */
         .mobile-container {
      display: none;
      overflow: visible;
      position: relative;
      width: 100%;
      height: calc(var(--vh, 1vh) * 100);
      padding-top: 60px; /* Add space for title */
      margin: 0 auto;
      box-sizing: border-box;
     }
     
     .mobile-title {
       position: fixed;
       top: 0;
       left: 0;
       right: 0;
       background: var(--bg);
       padding: 16px;
       text-align: center;
       font-size: 18px;
       font-weight: bold;
       z-index: 200;
       border-bottom: 1px solid rgba(255,255,255,0.1);
       margin: 0 auto;
       box-sizing: border-box;
     }
     
         .mobile-slide {
      position: absolute;
      left: 0;
      right: 0;
      width: 100%;
      height: calc(calc(var(--vh, 1vh) * 100) - 100px);
      transition: transform 0.3s ease-in-out, opacity 0.3s ease-in-out;
      padding: 0 20px 20px 20px; /* Reduced bottom padding */
      box-sizing: border-box;
      display: none;
      flex-direction: column;
      justify-content: flex-start;
      align-items: center;
      overflow-y: auto; /* Enable vertical scrolling */
      overflow-x: hidden; /* Prevent horizontal scrolling */
      -webkit-overflow-scrolling: touch; /* Enable smooth scrolling on iOS */
      will-change: transform, opacity; /* Optimize for animations */
    }
     
     .mobile-slide.active {
       transform: translateX(0);
       z-index: 10;
     }
     
     .mobile-slide.prev {
       transform: translateX(-100%);
       z-index: 5;
     }
     
     .mobile-slide.next {
       transform: translateX(100%);
       z-index: 5;
     }
     
         .mobile-slide-content {
      background: var(--card);
      border-radius: var(--radius);
      padding: 24px 24px 24px 24px;
      margin: 16px auto 8px auto;
      box-shadow: 0 4px 20px rgba(0,0,0,0.3);
      flex: none; /* Don't expand to fill space */
      max-width: 100%;
      width: 100%;
      box-sizing: border-box;
      overflow: visible;
    }

    .mobile-slide-content-streak {
      
      border-radius: var(--radius);
      padding: 35px 24px 0px 24px;
      margin: 16px auto;
      margin-bottom: 0px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.3);
      flex: none; /* Don't expand to fill space */
      max-height: 70vh; /* Limit height to 70% of viewport */
      max-width: 100%;
      width: 100%;
      box-sizing: border-box;
      overflow: visible;
    }
     
     .mobile-slide-content h2 {
       margin-top: 0;
       margin-bottom: 16px;
       text-align: center;
       font-size: 20px;
     }
     
     .mobile-slide-content canvas {
       margin-bottom: 16px;
       max-height: 200px;
     }
     
     .mobile-slide-content .user-actions {
       margin-top: 0;
     }
     
     .mobile-slide-content .user-actions button {
       margin-bottom: 8px;
       width: 100%;
     }
     
     .mobile-slide-content .user-actions button:last-child {
       margin-bottom: 0;
     }
     
         /* Combined Navigation Container */
    .mobile-navigation {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: var(--bg);
      border-top: 1px solid rgba(255,255,255,0.1);
      padding: 12px 20px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 12px;
      z-index: 100;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
    }
    
    .mobile-indicators {
      display: flex;
      gap: 8px;
    }
     
     .mobile-indicator {
       width: 8px;
       height: 8px;
       border-radius: 50%;
       background: var(--muted);
       transition: background 0.3s ease, transform 0.2s ease;
       cursor: pointer;
     }
     
     .mobile-indicator:hover {
       transform: scale(1.2);
     }
     
     .mobile-indicator.active {
       background: var(--accent);
     }
     
     /* Swipe Hint */
     .swipe-hint {
       background: rgba(0, 0, 0, 0.7);
       color: var(--text);
       padding: 8px 16px;
       border-radius: 20px;
       font-size: 12px;
       opacity: 0.8;
             pointer-events: none;
       animation: fadeInOut 3s ease-in-out infinite;
     }
     
     @keyframes fadeInOut {
       0%, 100% { opacity: 0.3; }
       50% { opacity: 0.8; }
     }
     
     /* Desktop styles */
     .desktop-container {
       display: block;
     }
     
     /* Streak Module Styles */
         .streak-module {
      background: linear-gradient(135deg, #1e293b, #334155);
      border-radius: 20px;
      margin: 5px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
      border: 1px solid rgba(255, 255, 255, 0.1);
      overflow: visible;
    }
     
         .streak-header {
      display: flex;
      align-items: center;
      gap: 16px;
      margin-bottom: 12px;
    }
     
         .streak-icon {
      font-size: 40px;
      filter: drop-shadow(0 0 12px rgba(255, 165, 0, 0.6));
    }
    
    /* Animated Fire Icon */
    .animated-fire {
      display: inline-block;
      width: 40px;
      height: 40px;
    }
    
    .fire-svg {
      width: 100%;
      height: 100%;
      filter: drop-shadow(0 0 8px rgba(255, 100, 0, 0.6)) drop-shadow(0 0 16px rgba(255, 150, 0, 0.3)) drop-shadow(0 0 24px rgba(255, 200, 0, 0.2));
    }
    
    .fire-flame-1 {
      animation: fireFlicker1 1.2s ease-in-out infinite alternate;
      transform-origin: bottom center;
    }
    
    .fire-flame-2 {
      animation: fireFlicker2 0.8s ease-in-out infinite alternate;
      transform-origin: bottom center;
    }
    
    .fire-flame-3 {
      animation: fireFlicker3 1.0s ease-in-out infinite alternate;
      transform-origin: bottom center;
    }
    
    @keyframes fireFlicker1 {
      0% { transform: scale(1) rotate(-1deg) translateY(0px); }
      50% { transform: scale(1.05) rotate(1deg) translateY(-1px); }
      100% { transform: scale(0.98) rotate(-0.5deg) translateY(0px); }
    }
    
    @keyframes fireFlicker2 {
      0% { transform: scale(1) rotate(1deg) translateY(0px); }
      50% { transform: scale(1.03) rotate(-1deg) translateY(-1px); }
      100% { transform: scale(1.01) rotate(0.5deg) translateY(0px); }
    }
    
    @keyframes fireFlicker3 {
      0% { transform: scale(1) rotate(0deg) translateY(0px); }
      50% { transform: scale(1.02) rotate(0.5deg) translateY(-1px); }
      100% { transform: scale(0.99) rotate(-0.3deg) translateY(0px); }
    }
     
     .streak-info {
       flex: 1;
     }
     
     .streak-count {
       font-size: 32px;
       font-weight: bold;
       color: #fbbf24;
       text-shadow: 0 0 10px rgba(251, 191, 36, 0.5);
       line-height: 1;
     }
     
     .streak-label {
       font-size: 14px;
       color: var(--muted);
       margin-top: 4px;
     }
     
         .streak-progress {
      height: 8px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 4px;
      margin-bottom: 12px;
      overflow: hidden;
    }
     
     .streak-bar {
       height: 100%;
       background: linear-gradient(90deg, #fbbf24, #f59e0b);
       border-radius: 4px;
       transition: width 0.5s ease;
       width: 0%;
     }
     
     .streak-stats {
       display: flex;
       justify-content: space-around;
       gap: 16px;
     }
     
     .streak-stat {
       text-align: center;
       flex: 1;
     }
     
     .stat-value {
       display: block;
       font-size: 20px;
       font-weight: bold;
       color: var(--accent);
       line-height: 1;
     }
     
     .stat-label {
       font-size: 12px;
       color: var(--muted);
       margin-top: 4px;
     }
     
     /* Desktop Streak Styles */
     .streak-card {
       background: linear-gradient(135deg, #1e293b, #334155);
       border: 1px solid rgba(255, 255, 255, 0.1);
       box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
     }
     
     .streak-container {
       padding: 8px;
     }
     
     .streak-main {
       display: flex;
       align-items: center;
       gap: 24px;
       margin-bottom: 24px;
     }
     
         .streak-icon-large {
      font-size: 56px;
      filter: drop-shadow(0 0 18px rgba(255, 165, 0, 0.8));
    }
    
    /* Large Animated Fire Icon */
    .animated-fire-large {
      display: inline-block;
      width: 56px;
      height: 56px;
    }
    
    .fire-svg-large {
      width: 100%;
      height: 100%;
      filter: drop-shadow(0 0 16px rgba(255, 100, 0, 0.9)) drop-shadow(0 0 24px rgba(255, 150, 0, 0.5));
    }
     
     .streak-details {
       flex: 1;
     }
     
     .streak-count-large {
       font-size: 48px;
       font-weight: bold;
       color: #fbbf24;
       text-shadow: 0 0 15px rgba(251, 191, 36, 0.6);
       line-height: 1;
     }
     
     .streak-label-large {
       font-size: 18px;
       color: var(--text);
       margin-top: 8px;
       font-weight: 600;
     }
     
     .streak-subtitle {
       font-size: 14px;
       color: var(--muted);
       margin-top: 4px;
     }
     
     .streak-progress-large {
       height: 12px;
       background: rgba(255, 255, 255, 0.1);
       border-radius: 6px;
       margin-bottom: 24px;
       overflow: hidden;
     }
     
     .streak-bar-large {
       height: 100%;
       background: linear-gradient(90deg, #fbbf24, #f59e0b);
       border-radius: 6px;
       transition: width 0.5s ease;
       width: 0%;
     }
     
     .streak-stats-large {
       display: grid;
       grid-template-columns: repeat(3, 1fr);
       gap: 24px;
     }
     
     .streak-stat-large {
       text-align: center;
     }
     
     .stat-value-large {
       display: block;
       font-size: 28px;
       font-weight: bold;
       color: var(--accent);
       line-height: 1;
     }
     
     .stat-label-large {
       font-size: 14px;
       color: var(--muted);
       margin-top: 8px;
     }
     
     /* Mobile styles */
     @media (max-width: 768px) {
       .desktop-container {
         display: none;
       }
       
       .mobile-container {
         display: block;
       }
       
       body {
         padding: 0;
         margin: 0;
         overflow: hidden;
         touch-action: pan-y; /* Allow vertical scrolling but optimize for horizontal swipes */
       }
       
       .wrap {
         max-width: none;
         margin: 0;
         padding: 0;
       }
       
       h1 {
         display: none; /* Hide desktop title on mobile */
       }
       
             .mobile-slide.active {
        overflow-y: auto;
        overflow-x: hidden;
        -webkit-overflow-scrolling: touch;
        touch-action: pan-y; /* Allow vertical scrolling within slides */
      }
       
       .modal-overlay {
         overflow-y: auto;
         -webkit-overflow-scrolling: touch;
       }
       
       .streak-module {
         margin: 0;
         padding: 15px 25px 15px 25px;
       }
       
       .streak-count {
         font-size: 28px;
       }
       
             .streak-icon {
        font-size: 10px;
        filter: drop-shadow(0 0 8px rgba(255, 100, 0, 0.6)) drop-shadow(0 0 16px rgba(255, 150, 0, 0.3)) drop-shadow(0 0 24px rgba(255, 200, 0, 0.2));
        margin-top: 12px;
        margin-left: 5px;
        margin-right: 5px;
      }
      
      .animated-fire {
        width: 60px;
        height: 60px;
      }
       
       /* Improve touch responsiveness */
       .mobile-slide-content {
         touch-action: pan-y;
         -webkit-user-select: none;
         user-select: none;
       }

       .mobile-slide-content-streak {
         touch-action: pan-y;
         -webkit-user-select: none;
         user-select: none;
       }
       
       /* Prevent text selection during swipes */
       .mobile-container {
         -webkit-user-select: none;
         user-select: none;
       }
       
       /* Additional centering fixes for edge cases */
       .mobile-slide {
         left: 0 !important;
         right: 0 !important;
         margin-left: 0 !important;
         margin-right: 0 !important;
       }
       
       .mobile-slide-content {
         margin-left: auto !important;
         margin-right: auto !important;
         max-width: 100% !important;
       }

       .mobile-slide-content-streak {
         margin-left: auto !important;
         margin-right: auto !important;
         max-width: 100% !important;
       }
       
       /* Ensure proper centering on very wide screens */
       @media (min-width: 768px) and (max-width: 1024px) {
         .mobile-container {
           max-width: 100vw;
           margin: 0 auto;
         }
       }
       
       /* Handle landscape orientation centering */
       @media (orientation: landscape) {
         .mobile-slide {
           left: 0 !important;
           right: 0 !important;
         }
       }
       
       /* Consistent spacing for all screen sizes */
       .streak-module {
         margin: 0 !important;
       }
       
       /* Additional responsive improvements for very small screens */
       @media (max-width: 360px) {
         .streak-module {
           padding: 12px 20px !important;
           margin: 0 !important;
         }
         
         .mobile-slide {
           padding: 0 16px 16px 16px !important;
         }
       }
     }
  </style>
</head>
<body>
     <div class="wrap">
     <h1>WorkSmart - Calorie Tracker</h1>

     <!-- Mobile Container -->
     <div class="mobile-container">
       <!-- Mobile Title -->
       <div class="mobile-title">Water Data Logger</div>
       
      
       <div class="mobile-slide active" id="mobile-slide-1">

      <!-- Streak Module -->
       <div class="mobile-slide-content-streak" style="display:none";>
         <div class="streak-module">
         <div class="streak-header">
           <div class="streak-icon">
            <div class="animated-fire">
              <svg class="fire-svg" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <g class="fire-flame-1">
                  <path d="M12 2C8 6 6 10 6 14C6 17.3 8.7 20 12 20C15.3 20 18 17.3 18 14C18 10 16 6 12 2Z" fill="url(#fireGradient1)"/>
                </g>
                <g class="fire-flame-2">
                  <path d="M12 4C9 7 7.5 10 7.5 13C7.5 15.5 9.5 17.5 12 17.5C14.5 17.5 16.5 15.5 16.5 13C16.5 10 15 7 12 4Z" fill="url(#fireGradient2)"/>
                </g>
                <g class="fire-flame-3">
                  <path d="M12 6C10 8.5 9 11 9 13C9 14.7 10.3 16 12 16C13.7 16 15 14.7 15 13C15 11 14 8.5 12 6Z" fill="url(#fireGradient3)"/>
                </g>
                <defs>
                  <linearGradient id="fireGradient1" x1="0%" y1="0%" x2="0%" y2="100%">
                    <stop offset="0%" style="stop-color:#ff6b35;stop-opacity:1" />
                    <stop offset="50%" style="stop-color:#f7931e;stop-opacity:1" />
                    <stop offset="100%" style="stop-color:#ffd23f;stop-opacity:1" />
                  </linearGradient>
                  <linearGradient id="fireGradient2" x1="0%" y1="0%" x2="0%" y2="100%">
                    <stop offset="0%" style="stop-color:#ff8c42;stop-opacity:1" />
                    <stop offset="50%" style="stop-color:#ffd23f;stop-opacity:1" />
                    <stop offset="100%" style="stop-color:#fff;stop-opacity:1" />
                  </linearGradient>
                  <linearGradient id="fireGradient3" x1="0%" y1="0%" x2="0%" y2="100%">
                    <stop offset="0%" style="stop-color:#ffd23f;stop-opacity:1" />
                    <stop offset="100%" style="stop-color:#fff;stop-opacity:1" />
                  </linearGradient>
                </defs>
              </svg>
            </div>
          </div>
           <div class="streak-info">
             <div class="streak-count" id="mobileStreakCount">0</div>
             <div class="streak-label">Day Streak</div>
           </div>
         </div>
         <div class="streak-progress">
           <div class="streak-bar" id="mobileStreakBar"></div>
         </div>
         <div class="streak-stats">
           <div class="streak-stat">
             <span class="stat-value" id="mobileBestStreak">0</span>
             <span class="stat-label">Best</span>
           </div>
           <div class="streak-stat">
             <span class="stat-value" id="mobileAverageStreak">0</span>
             <span class="stat-label">Avg Streak</span>
           </div>
         </div>
         </div>
       </div>
       
       <!-- Slide 1: Total Calories Burned -->
       
         <div class="mobile-slide-content">

          <h2>Water Level (ft)</h2>
           <canvas id="mobileWaterLevelChart" height="200"></canvas>
           <button class="ghost" id="mobileToggleWaterLevelLocation">Show More</button>
           <button class="primary" id="mobileShowWaterLevels">Add Water Level</button>

           <br><br>
           <hr style="border: none; height: 1px; background: rgba(255,255,255,0.1); margin: 20px 0;">
           <br>
           
           <h2>Meter Reads (ft)</h2>
           <canvas id="mobileMeterReadsChart" height="200"></canvas>
           <button class="ghost" id="mobileToggleMeterReadsLocation">Show More</button>
           <button class="primary" id="mobileShowMeterReads">Add Meter Read</button>
           
           <br><br>
           <hr style="border: none; height: 1px; background: rgba(255,255,255,0.1); margin: 20px 0;">
           <br>
           
           <h2>Residual Readings (ft)</h2>
           <canvas id="mobileResidualReadingsChart" height="200"></canvas>
           <button class="ghost" id="mobileToggleResidualReadingsLocation">Show More</button>
           <button class="primary" id="mobileShowResidualReadings">Add Residual Reading</button>
           
         </div>
       </div>

       <br><br>
       <!-- Slide 2: Calories Burned With Workouts -->
       <div class="mobile-slide next" id="mobile-slide-2">
         <div class="mobile-slide-content">
          <h2>Total Calorie Deficit</h2>
          <canvas id="mobileTotalChart" height="200"></canvas>
          <button class="ghost" id="mobileToggleFat">Show More</button>
          <button class="primary" id="mobileAddCaloriesBtn">Add Calories</button>
         </div>
       </div>

       <!-- Slide 3: Foods Eaten -->
       <div class="mobile-slide next" id="mobile-slide-3">
         <div class="mobile-slide-content">
           <h2>Foods Eaten</h2>
           <canvas id="mobileFoodChart" height="200"></canvas>
           <button class="ghost" id="mobileToggleFoodDetail">Show More</button>
           <button class="primary" id="mobileShowFoods">Show Foods</button>
         </div>
       </div>


       <!-- Slide 4: User Profile -->
       <div class="mobile-slide next" id="mobile-slide-4">
         <div class="mobile-slide-content">
           <h2>User Profile</h2>
           <div class="user-actions">
             <button class="settings-btn" id="mobileOpenSettings" disabled>Settings</button>
             <button class="ghost" id="mobileFixLayoutBtn" style="display: none;" onclick="emergencyLayoutFix()">Fix Layout</button>
             <button class="danger-btn" id="mobileDeleteAccountBtn">Delete Account</button>
             <button class="logout-btn" id="mobileLogoutBtn">Logout</button>
           </div>
         </div>
       </div>

             <!-- Mobile Navigation -->
      <div class="mobile-navigation">
        <div class="swipe-hint" style="display: none;">
          <span>‚Üê Swipe to navigate ‚Üí</span>
        </div>
        <div class="mobile-indicators">
          <div class="mobile-indicator active"></div>
          <div class="mobile-indicator"></div>
          <div class="mobile-indicator"></div>
          <div class="mobile-indicator"></div>
        </div>
      </div>
     </div> 
     <!-- Desktop Container -->
     <div class="desktop-container">

     <!-- Authentication Modal -->
    <div id="authModal" class="modal-overlay hidden">
      <div class="modal">
        <!-- Login Form -->
        <div id="loginForm">
          <div class="modal-header">
            <div class="modal-icon">üîì</div>
                         <div>
               <h3 class="modal-title">Welcome Back</h3>
               <p class="modal-subtitle">Sign in to access your workout tracker</p>
             </div>
          </div>
          <div class="field">
            <label class="label">EMAIL ADDRESS</label>
            <input id="loginEmail" type="email" placeholder="Enter your email" />
          </div>
          <div class="field">
            <label class="label">PASSWORD</label>
            <input id="loginPassword" type="password" placeholder="Enter your password" />
          </div>
                     <button class="primary" id="loginBtn">Sign In</button>
           <div class="auth-toggle">
             Don't have an account? <a id="showSignup">Create one here</a>
           </div>
                       <div id="loginError" class="error-message hidden"></div>
        </div>

        <!-- Signup Form -->
        <div id="signupForm" class="hidden">
          <div class="modal-header">
            <div class="modal-icon">üöÄ</div>
                         <div>
               <h3 class="modal-title">Create Account</h3>
               <p class="modal-subtitle">Join WorkSmart and track your fitness journey</p>
             </div>
          </div>
          <div class="field">
            <label class="label">EMAIL ADDRESS</label>
            <input id="signupEmail" type="email" placeholder="Enter your email" />
          </div>
          <div class="field">
            <label class="label">PASSWORD</label>
            <input id="signupPassword" type="password" placeholder="Enter your password" />
            <small style="color: var(--muted); font-size: 12px;">Minimum 6 characters</small>
          </div>
          <div class="field">
            <label class="label">CONFIRM PASSWORD</label>
            <input id="confirmPassword" type="password" placeholder="Confirm your password" />
          </div>
          <button class="primary" id="signupBtn">Create Account</button>
          <div class="auth-toggle">
            Already have an account? <a id="showLogin">Sign in here</a>
          </div>
          <div id="signupError" class="error-message hidden"></div>
        </div>
      </div>
    </div>

    <!-- Profile Setup Modal -->
    <div id="profileModal" class="modal-overlay hidden">
      <div class="modal">
        <div class="profile-setup">
          <h3>Complete Your Profile</h3>
          <p>Let's calculate your BMR to get started</p>
        </div>
        <div class="field">
          <label class="label" for="setupAge">Age</label>
          <input id="setupAge" type="number" placeholder="22" />
        </div>
        <div class="field">
          <label class="label">Height</label>
          <div class="row">
            <input id="setupHeightFt" type="number" placeholder="5" />
            <input id="setupHeightIn" type="number" placeholder="9" />
          </div>
        </div>
        <div class="field">
          <label class="label" for="setupWeight">Weight (lb)</label>
          <input id="setupWeight" type="number" placeholder="170" />
        </div>
        <div class="result" id="setupResult"></div>
        <button class="primary" id="saveProfileBtn">Save Profile</button>
        <div id="profileError" class="error-message hidden"></div>
      </div>
    </div>

         <!-- Settings Modal -->
     <div id="settingsModal" class="modal-overlay hidden">
       <div class="modal">
         <div class="modal-header">
           <div class="modal-icon">‚öôÔ∏è</div>
           <div>
             <h3 class="modal-title">User Settings</h3>
             <p class="modal-subtitle">Update your profile information</p>
           </div>
         </div>
         <div class="field">
           <label class="label" for="settingsAge">Age</label>
           <input id="settingsAge" type="number" />
         </div>
         <div class="field">
           <label class="label">Height</label>
           <div class="row">
             <input id="settingsHeightFt" type="number" />
             <input id="settingsHeightIn" type="number" />
           </div>
         </div>
         <div class="field">
           <label class="label" for="settingsWeight">Weight (lb)</label>
           <input id="settingsWeight" type="number" />
         </div>
         <div class="field">
           <label class="label" for="settingsTheme">Theme</label>
           <select id="settingsTheme">
             <option value="dark">Dark Mode</option>
             <option value="light">Light Mode</option>
           </select>
         </div>
         <div class="user-actions">
           <button class="primary" id="saveSettings">Save</button>
           <button class="ghost" id="cancelSettings">Back</button>
         </div>
         <div id="settingsError" class="error-message hidden"></div>
         <div id="settingsSuccess" class="success-message hidden"></div>
       </div>
     </div>

     <!-- Add Calories Modal -->
     <div id="addCaloriesModal" class="modal-overlay hidden">
       <div class="modal">
         <div class="modal-header">
           <div class="modal-icon">
            <div class="animated-fire-modal">
              <svg class="fire-svg-modal" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <g class="fire-flame-1">
                  <path d="M12 2C8 6 6 10 6 14C6 17.3 8.7 20 12 20C15.3 20 18 17.3 18 14C18 10 16 6 12 2Z" fill="url(#fireGradient1)"/>
                </g>
                <g class="fire-flame-2">
                  <path d="M12 4C9 7 7.5 10 7.5 13C7.5 15.5 9.5 17.5 12 17.5C14.5 17.5 16.5 15.5 16.5 13C16.5 10 15 7 12 4Z" fill="url(#fireGradient2)"/>
                </g>
                <g class="fire-flame-3">
                  <path d="M12 6C10 8.5 9 11 9 13C9 14.7 10.3 16 12 16C13.7 16 15 14.7 15 13C15 11 14 8.5 12 6Z" fill="url(#fireGradient3)"/>
                </g>
              </svg>
            </div>
          </div>
           <div>
             <h3 class="modal-title">Add Calories</h3>
             <p class="modal-subtitle">Log your activity calories</p>
           </div>
         </div>
         <div class="field">
           <label class="label" for="caloriesAmount">Calories</label>
           <input id="caloriesAmount" type="number" placeholder="Enter calories (positive or negative)" />
           <small style="color: var(--muted); font-size: 12px;">Use negative values to subtract calories</small>
         </div>
         <div class="field">
           <label class="label" for="caloriesDate">Date</label>
           <input id="caloriesDate" type="date" />
         </div>
         <div class="user-actions">
           <button class="primary" id="submitAddCalories">Submit</button>
           <button class="ghost" id="cancelAddCalories">Cancel</button>
         </div>
         <div id="addCaloriesError" class="error-message hidden"></div>
         <div id="addCaloriesSuccess" class="success-message hidden"></div>
       </div>
     </div>

     <!-- Weight Logging Modal -->
     <div id="weightLoggingModal" class="modal-overlay hidden">
       <div class="modal">
         <div class="modal-header">
           <div class="modal-icon">‚öñÔ∏è</div>
           <div>
             <h3 class="modal-title">Daily Weight Check</h3>
             <p class="modal-subtitle">Have you weighed yourself today?</p>
           </div>
         </div>
         <div class="field">
           <label class="label" for="dailyWeight">Weight (lb)</label>
           <input id="dailyWeight" type="number" step="0.1" placeholder="Enter your weight" />
         </div>
         <div class="user-actions">
           <button class="primary" id="submitDailyWeight">Submit</button>
           <button class="ghost" id="maybeLaterWeight">Maybe Later</button>
           <button class="ghost" id="closeWeightModal">Close</button>
         </div>
         <div id="weightLoggingError" class="error-message hidden"></div>
       </div>
     </div>

     <!-- Add Weight Modal -->
     <div id="addWeightModal" class="modal-overlay hidden">
       <div class="modal">
         <div class="modal-header">
           <div class="modal-icon">‚öñÔ∏è</div>
           <div>
             <h3 class="modal-title">Add Weight</h3>
             <p class="modal-subtitle">Log your weight for a specific date</p>
           </div>
         </div>
         <div class="field">
           <label class="label" for="weightAmount">Weight (lb)</label>
           <input id="weightAmount" type="number" step="0.1" placeholder="Enter your weight" />
         </div>
         <div class="field">
           <label class="label" for="weightDate">Date</label>
           <input id="weightDate" type="date" />
         </div>
         <div class="user-actions">
           <button class="primary" id="submitAddWeight">Submit</button>
           <button class="ghost" id="cancelAddWeight">Cancel</button>
         </div>
         <div id="addWeightError" class="error-message hidden"></div>
         <div id="addWeightSuccess" class="success-message hidden"></div>
       </div>
     </div>

     <!-- Mobile Water Level Menu Modal -->
     <div id="mobileWaterLevelMenuModal" class="modal-overlay hidden">
       <div class="modal">
         <div class="modal-header">
           <div class="modal-icon">üíß</div>
           <div>
             <h3 class="modal-title">Water Level Actions</h3>
             <p class="modal-subtitle">Choose what you want to do</p>
           </div>
         </div>
         <div class="menu-grid" style="margin-bottom: 20px;">
           <div class="menu-tile" id="mobileOpenTreadmill">
             <div class="menu-emoji">üíß</div>
             <div>Add Water Level</div>
           </div>
           <div class="menu-tile" id="mobileOpenStairs">
             <div class="menu-emoji">üìä</div>
             <div>View History</div>
           </div>
         </div>
         <div class="user-actions">
           <button class="ghost" id="closeMobileWaterLevelMenu">Close</button>
         </div>
       </div>
     </div>

     <!-- Mobile Water Level Modal -->
     <div id="mobileWaterLevelModal" class="modal-overlay hidden">
       <div class="modal">
         <div class="modal-header">
           <div class="modal-icon">üíß</div>
           <div>
             <h3 class="modal-title">Water Level Entry</h3>
             <p class="modal-subtitle">Record water level data</p>
           </div>
         </div>
         <div class="field">
           <label class="label" for="mobileWaterLocation">Location</label>
           <select id="mobileWaterLocation">
             <option value="">Select a location</option>
             <option value="lake_erie">Lake Erie</option>
             <option value="lake_ontario">Lake Ontario</option>
             <option value="lake_huron">Lake Huron</option>
             <option value="lake_michigan">Lake Michigan</option>
             <option value="lake_superior">Lake Superior</option>
             <option value="ohio_river">Ohio River</option>
             <option value="mississippi_river">Mississippi River</option>
             <option value="custom">Custom Location</option>
           </select>
         </div>
         <div class="field hidden" id="mobileCustomLocationField">
           <label class="label" for="mobileCustomLocationName">Custom Location Name</label>
           <input id="mobileCustomLocationName" type="text" placeholder="Enter location name" />
         </div>
         <div class="field">
           <label class="label" for="mobileWaterLevel">Water Level (ft)</label>
           <input id="mobileWaterLevel" type="number" step="0.01" placeholder="0.00" />
         </div>
         <div class="field">
           <label class="label" for="mobileWaterDate">Date</label>
           <input id="mobileWaterDate" type="date" />
         </div>
         <button class="ghost" id="mobileManageLocations" style="margin-bottom: 16px;">üìç Edit Locations</button>
         <div class="result" id="mobileWaterResult"></div>
         <div class="user-actions">
           <button class="primary" id="mobileWaterCalc">Log Water Level</button>
           <button class="ghost" id="closeMobileWaterLevel">Close</button>
         </div>
       </div>
     </div>

     <!-- Locations Management Modal -->
     <div id="locationsModal" class="modal-overlay" style="display: none;">
       <div class="modal-content" style="max-width: 500px;">
         <div class="modal-header">
           <div>
             <h3 class="modal-title">Manage Water Level Locations</h3>
             <p class="modal-subtitle">Add or remove custom locations for water level tracking</p>
           </div>
         </div>
         <div class="locations-content" style="padding: 20px;">
           <div class="add-location-section" style="margin-bottom: 24px;">
             <h4 style="color: #f3f4f6; margin-bottom: 12px; font-size: 16px;">Add New Location</h4>
             <div class="field" style="margin-bottom: 12px;">
               <input id="newLocationName" type="text" placeholder="Enter location name (e.g., Lake Tahoe)" style="
                 width: 100%;
                 padding: 10px 12px;
                 background: #374151;
                 border: 1px solid #4b5563;
                 border-radius: 6px;
                 color: #f9fafb;
                 font-size: 14px;
               " />
             </div>
             <button id="addLocationBtn" class="primary" style="width: 100%;" Add Location</button>
           </div>
           
           <div class="existing-locations-section">
             <h4 style="color: #f3f4f6; margin-bottom: 12px; font-size: 16px;">Your Locations</h4>
             <div id="locationsList" style="max-height: 300px; overflow-y: auto;">
               <!-- Locations will be populated here -->
             </div>
           </div>
         </div>
         <div class="user-actions">
           <button class="ghost" id="closeLocationsModal">Close</button>
         </div>
       </div>
     </div>

     <!-- Meter Reads Menu Modal - Created dynamically to avoid mobile visibility issues -->

     <!-- Meter Reads Entry Modal - Created dynamically to avoid mobile visibility issues -->

     <!-- Meter Reads History Modal - Created dynamically to avoid mobile visibility issues -->

     <!-- Meter Reads Locations Management Modal -->
     <div id="meterReadsLocationsModal" class="modal-overlay hidden">
       <div class="modal-content" style="max-width: 500px;">
         <div class="modal-header">
           <div>
             <h3 class="modal-title">Manage Meter Reads Locations</h3>
             <p class="modal-subtitle">Add or remove custom locations for meter reading tracking</p>
           </div>
         </div>
         <div class="locations-content" style="padding: 20px;">
           <div class="add-location-section" style="margin-bottom: 24px;">
             <h4 style="color: #f3f4f6; margin-bottom: 12px; font-size: 16px;">Add New Location</h4>
             <div class="field" style="margin-bottom: 12px;">
               <input id="newMeterReadsLocationName" type="text" placeholder="Enter location name (e.g., Building A)" style="
                 width: 100%;
                 padding: 10px 12px;
                 background: #374151;
                 border: 1px solid #4b5563;
                 border-radius: 6px;
                 color: #f9fafb;
                 font-size: 14px;
               " />
             </div>
             <button id="addMeterReadsLocationBtn" class="primary" style="width: 100%;">‚ûï Add Location</button>
           </div>
           
           <div class="existing-locations-section">
             <h4 style="color: #f3f4f6; margin-bottom: 12px; font-size: 16px;">Your Locations</h4>
             <div id="meterReadsLocationsList" style="max-height: 300px; overflow-y: auto;">
               <!-- Locations will be populated here -->
             </div>
           </div>
         </div>
         <div class="user-actions">
           <button class="ghost" id="closeMeterReadsLocationsModal">Close</button>
         </div>
       </div>
     </div>

     <!-- Mobile Water History Modal -->
     <div id="mobileWaterHistoryModal" class="modal-overlay hidden">
       <div class="modal">
         <div class="modal-header">
           <div class="modal-icon">üìä</div>
           <div>
             <h3 class="modal-title">Water Level History</h3>
             <p class="modal-subtitle">View recorded water level data</p>
           </div>
         </div>
         <div class="filter-controls" style="margin-bottom: 20px;">
           <div class="field" style="margin-bottom: 12px;">
             <label class="label" for="mobileHistoryLocation" style="color: #d1d5db; font-size: 14px; margin-bottom: 4px;">Filter by Location</label>
             <select id="mobileHistoryLocation" style="
               width: 100%;
               padding: 8px 12px;
               background: #374151;
               border: 1px solid #4b5563;
               border-radius: 6px;
               color: #f9fafb;
               font-size: 14px;
             ">
               <option value="">All Locations</option>
               <option value="lake_erie">Lake Erie</option>
               <option value="lake_ontario">Lake Ontario</option>
               <option value="lake_huron">Lake Huron</option>
               <option value="lake_michigan">Lake Michigan</option>
               <option value="lake_superior">Lake Superior</option>
               <option value="ohio_river">Ohio River</option>
               <option value="mississippi_river">Mississippi River</option>
             </select>
         </div>
         <div class="field">
             <label class="label" for="mobileHistoryDateRange" style="color: #d1d5db; font-size: 14px; margin-bottom: 4px;">Date Range</label>
             <select id="mobileHistoryDateRange" style="
               width: 100%;
               padding: 8px 12px;
               background: #374151;
               border: 1px solid #4b5563;
               border-radius: 6px;
               color: #f9fafb;
               font-size: 14px;
             ">
               <option value="7">Last 7 days</option>
               <option value="30" selected>Last 30 days</option>
               <option value="90">Last 90 days</option>
               <option value="365">Last year</option>
               <option value="all">All time</option>
           </select>
         </div>
         </div>
         <div class="result" id="mobileWaterHistoryResult"></div>
         <div class="user-actions">
           <button class="primary" id="exportWaterHistoryBtn" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); border: none; color: white; padding: 12px 24px; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.2s ease;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 8px rgba(16, 185, 129, 0.3)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'">üìä Export to Excel</button>
           <button class="ghost" id="closeMobileWaterHistory">Close</button>
         </div>
       </div>
     </div>

     <!-- Mobile Food Menu Modal -->
     <div id="mobileFoodModal" class="modal-overlay hidden">
       <div class="modal">
         <div class="modal-header">
           <div class="modal-icon">üçΩÔ∏è</div>
           <div>
             <h3 class="modal-title">Choose Food</h3>
             <p class="modal-subtitle">Select your food type</p>
           </div>
         </div>
         <div class="menu-grid" style="margin-bottom: 20px;">
           <div class="menu-tile" id="mobileOpenTacos">
             <div class="menu-emoji">üåÆ</div>
             <div>Tacos</div>
           </div>
           <div class="menu-tile" id="mobileOpenBurger">
             <div class="menu-emoji">üçî</div>
             <div>Burger</div>
           </div>
         </div>
         <div class="user-actions">
           <button class="primary" id="mobileAddCustomFood" style="background: #60a5fa; color: white;">Add Foods</button>
           <button class="ghost" id="closeMobileFoodMenu">Close</button>
         </div>
       </div>
     </div>


     <!-- Mobile Custom Food Modal -->
     <div id="mobileCustomFoodModal" class="modal-overlay hidden">
       <div class="modal">
         <div class="modal-header">
           <div class="modal-icon" id="customFoodIcon">üçΩÔ∏è</div>
           <div>
             <h3 class="modal-title">Add Custom Food</h3>
             <p class="modal-subtitle">Create your own food entry</p>
           </div>
         </div>
         <div class="field">
           <label class="label" for="mobileCustomFoodName">Food Name</label>
           <input id="mobileCustomFoodName" type="text" placeholder="e.g., Chicken Salad" />
         </div>
         <div class="field">
           <label class="label" for="mobileCustomFoodCalories">Calories</label>
           <input id="mobileCustomFoodCalories" type="number" placeholder="350" />
         </div>
         <div class="result" id="mobileCustomFoodResult"></div>
         <div class="user-actions">
           <button class="primary" id="mobileCustomFoodCalc">Add Food</button>
           <button class="danger-btn" id="mobileDeleteCustomFood" style="background: #f87171; color: white;">Delete Food</button>
           <button class="ghost" id="closeMobileCustomFood">Close</button>
         </div>
       </div>
     </div>

         <!-- Main App Content (hidden until authenticated) -->
     <div id="appContent" class="hidden">

      <!-- Streak Module -->
      <section class="card streak-card">
        <div class="streak-container">
          <div class="streak-main">
            <div class="streak-icon-large">
              <div class="animated-fire-large">
                <svg class="fire-svg-large" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <g class="fire-flame-1">
                    <path d="M12 2C8 6 6 10 6 14C6 17.3 8.7 20 12 20C15.3 20 18 17.3 18 14C18 10 16 6 12 2Z" fill="url(#fireGradient1)"/>
                  </g>
                  <g class="fire-flame-2">
                    <path d="M12 4C9 7 7.5 10 7.5 13C7.5 15.5 9.5 17.5 12 17.5C14.5 17.5 16.5 15.5 16.5 13C16.5 10 15 7 12 4Z" fill="url(#fireGradient2)"/>
                  </g>
                  <g class="fire-flame-3">
                    <path d="M12 6C10 8.5 9 11 9 13C9 14.7 10.3 16 12 16C13.7 16 15 14.7 15 13C15 11 14 8.5 12 6Z" fill="url(#fireGradient3)"/>
                  </g>
                </svg>
              </div>
            </div>
            <div class="streak-details">
              <div class="streak-count-large" id="desktopStreakCount">0</div>
              <div class="streak-label-large">Day Workout Streak</div>
              <div class="streak-subtitle">Keep the fire burning! <span class="animated-fire-modal" style="display: inline-block; width: 16px; height: 16px;"><svg class="fire-svg-modal" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="width: 16px; height: 16px;"><g class="fire-flame-1"><path d="M12 2C8 6 6 10 6 14C6 17.3 8.7 20 12 20C15.3 20 18 17.3 18 14C18 10 16 6 12 2Z" fill="url(#fireGradient1)"/></g><g class="fire-flame-2"><path d="M12 4C9 7 7.5 10 7.5 13C7.5 15.5 9.5 17.5 12 17.5C14.5 17.5 16.5 15.5 16.5 13C16.5 10 15 7 12 4Z" fill="url(#fireGradient2)"/></g><g class="fire-flame-3"><path d="M12 6C10 8.5 9 11 9 13C9 14.7 10.3 16 12 16C13.7 16 15 14.7 15 13C15 11 14 8.5 12 6Z" fill="url(#fireGradient3)"/></g></svg></span></div>
            </div>
          </div>
          <div class="streak-progress-large">
            <div class="streak-bar-large" id="desktopStreakBar"></div>
          </div>
          <div class="streak-stats-large">
            <div class="streak-stat-large">
              <span class="stat-value-large" id="desktopBestStreak">0</span>
              <span class="stat-label-large">Best Streak</span>
            </div>
            <div class="streak-stat-large">
              <span class="stat-value-large" id="desktopAverageStreak">0</span>
              <span class="stat-label-large">Avg Streak</span>
            </div>
            <div class="streak-stat-large">
              <span class="stat-value-large" id="desktopCurrentWeek">0</span>
              <span class="stat-label-large">This Week</span>
            </div>
          </div>
        </div>
      </section>

      <!-- Total Burned -->
      <section class="card">
        <h2>Total Calorie Deficit</h2>
        <canvas id="totalChart" height="200"></canvas>
        <button class="ghost" id="toggleFat">Show More</button>
        <button class="primary" id="addCaloriesBtn">Add Calories</button>
      </section>

             <!-- Meter Reads -->
       <section class="card">
         <h2>Meter Reads (ft)</h2>
         <canvas id="meterReadsChart" height="200"></canvas>
         <button class="ghost" id="toggleMeterReadsLocation">Show More</button>
         <button class="primary" id="showMeterReads">Add Meter Read</button>
       </section>

       <hr style="border: none; height: 1px; background: rgba(255,255,255,0.1); margin: 20px 0;">

       <section class="card">
         <h2>Residual Readings (ft)</h2>
         <canvas id="residualReadingsChart" height="200"></canvas>
         <button class="ghost" id="toggleResidualReadingsLocation">Show More</button>
         <button class="primary" id="showResidualReadings">Add Residual Reading</button>
       </section>

      <!-- Workouts Menu (hidden by default) -->
      <section class="card hidden" id="workoutMenu">
        <h2>Choose Water Level Action</h2>
        <div class="menu-grid">
          <div class="menu-tile" id="openTreadmill">
            <div class="menu-emoji">üíß</div>
            <div>Add Water Level</div>
          </div>
          <div class="menu-tile" id="openStairs">
            <div class="menu-emoji">üìä</div>
            <div>View History</div>
          </div>
        </div>
        <button class="ghost" id="hideWorkouts">Hide Water Levels</button>
      </section>

             <!-- Show/Hide Workouts Button -->
       <section class="card" id="waterLevelToggleSection">
         <h2>Water Level (ft)</h2>
         <canvas id="waterLevelChart" height="200"></canvas>
         <button class="ghost" id="toggleWaterLevelLocation">Show More</button>
         <button class="primary" id="showWaterLevels">Add Water Level</button>
       </section>

                            <!-- Water Level Entry Section -->
       <section class="card hidden" id="waterLevelSection">
        <h2>Water Level Entry</h2>
        <div class="field">
          <label class="label" for="waterLocation">Location</label>
          <select id="waterLocation">
            <option value="">Select a location</option>
            <option value="lake_erie">Lake Erie</option>
            <option value="lake_ontario">Lake Ontario</option>
            <option value="lake_huron">Lake Huron</option>
            <option value="lake_michigan">Lake Michigan</option>
            <option value="lake_superior">Lake Superior</option>
            <option value="ohio_river">Ohio River</option>
            <option value="mississippi_river">Mississippi River</option>
            <option value="custom">Custom Location</option>
          </select>
        </div>
        <div class="field hidden" id="customLocationField">
          <label class="label" for="customLocationName">Custom Location Name</label>
          <input id="customLocationName" type="text" placeholder="Enter location name" />
        </div>
        <div class="field">
          <label class="label" for="waterLevel">Water Level (ft)</label>
          <input id="waterLevel" type="number" step="0.01" placeholder="0.00" />
        </div>
        <div class="field">
           <label class="label" for="waterDate">Date</label>
           <input id="waterDate" type="date" />
        </div>
         <button class="ghost" id="manageLocations" style="margin-bottom: 16px;">üìçEdit Locations</button>
        <div class="result" id="waterResult"></div>
        <button class="primary" id="waterCalc">Log Water Level</button>
        <canvas id="waterChart" height="200"></canvas>
        <button class="ghost" id="toggleWaterLocation">Show by Location</button>
        <button class="primary" id="backFromWater">Back</button>
      </section>

      <!-- Water Level History Section -->
      <section class="card hidden" id="waterHistorySection">
        <h2>Water Level History</h2>
        <div class="field">
          <label class="label" for="historyLocation">Filter by Location</label>
          <select id="historyLocation">
            <option value="">All Locations</option>
            <option value="lake_erie">Lake Erie</option>
            <option value="lake_ontario">Lake Ontario</option>
            <option value="lake_huron">Lake Huron</option>
            <option value="lake_michigan">Lake Michigan</option>
            <option value="lake_superior">Lake Superior</option>
            <option value="ohio_river">Ohio River</option>
            <option value="mississippi_river">Mississippi River</option>
          </select>
        </div>
        <div class="field">
          <label class="label" for="historyDateRange">Date Range</label>
          <select id="historyDateRange">
            <option value="7">Last 7 days</option>
            <option value="30" selected>Last 30 days</option>
            <option value="90">Last 90 days</option>
            <option value="365">Last year</option>
            <option value="all">All time</option>
          </select>
        </div>
        <div class="result" id="waterHistoryResult"></div>
        <canvas id="waterHistoryChart" height="200"></canvas>
        <button class="ghost" id="toggleWaterHistoryLocation">Show by Location</button>
        <button class="primary" id="backFromWaterHistory">Back</button>
       </section>

       <!-- Settings and Logout Section -->
       <section class="card">

        <h2>User Profile</h2>

         <div class="user-actions">
           <button class="settings-btn" id="openSettings" disabled>Settings</button>
           <button class="ghost" id="fixLayoutBtn" onclick="emergencyLayoutFix()">Fix Mobile Layout</button>
           <button class="danger-btn" id="deleteAccountBtn">Delete Account</button>
           <button class="logout-btn" id="logoutBtn">Logout</button>
         </div>
       </section>
     </div>
     </div> <!-- Close desktop-container -->
   </div>

  <script>
    // ===== EmailJS Configuration =====
    (function() {
      emailjs.init("WhhwBTfgathw3wOR7");
    })();

    // ===== State Variables =====
    let bmr=0;
    let basalByDate={};     // date -> BMR for that date
    let activityByDate={};  // date -> sum of activity kcal for that date
    let weightByDate={};    // date -> weight for that date
    let waterLevelDataByDate={}; // date -> water level data for that date
    let customLocations = []; // user's custom water level locations
    let meterReadsDataByDate={}; // date -> meter reads data for that date
    let customMeterReadsLocations = []; // user's custom meter reads locations
    let residualReadingsDataByDate={}; // date -> residual readings data for that date
    let customResidualReadingsLocations = []; // user's custom residual readings locations
    let foodDataByDate={};  // date -> food data for that date
    let customFoods={};     // custom food name -> {name, calories, icon}
    let weightLoggingClosed={}; // date -> whether weight logging was closed for that date
    let currentTheme = 'dark'; // current theme setting

    // ===== Firebase Configuration =====
    const firebaseConfig = {
  apiKey: "AIzaSyCMXkAdeC3uqYCl2GtVQAhTQd9zZhuuf2o",
  authDomain: "waterdata-f5be3.firebaseapp.com",
  projectId: "waterdata-f5be3",
  storageBucket: "waterdata-f5be3.firebasestorage.app",
  messagingSenderId: "423248061288",
  appId: "1:423248061288:web:429ceb5b0f542809b82cdd",
  measurementId: "G-1F0GYHGBCC"
};

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

         // ===== Modal Management =====
    function liftModalsToBody() {
      const ids = [
        'authModal',
        'profileModal',
        'settingsModal',
        'addCaloriesModal',
        'weightLoggingModal',
        'addWeightModal',
        'mobileWaterLevelMenuModal',
        'mobileWaterLevelModal',
        'mobileWaterHistoryModal',
        'mobileFoodModal',
        'mobileCustomFoodModal'
      ];
      ids.forEach(id => {
        const el = document.getElementById(id);
        if (el && el.parentElement !== document.body) {
          document.body.appendChild(el);
        }
      });
    }

         // ===== Authentication State Management =====
     let currentUser = null;
     let userProfile = null;
     let authStateInitialized = false;

     auth.onAuthStateChanged(async (user) => {
       console.log('Auth state changed:', user ? 'User logged in' : 'No user');
       
       if (user) {
         currentUser = user;
         console.log('User signed in:', user.email);
         
         // Check if user has profile
         try {
           const profileDoc = await db.collection('users').doc(user.uid).get();
           if (profileDoc.exists) {
             userProfile = profileDoc.data();
             console.log('Profile found, showing app');
             showApp();
             loadUserData();
           } else {
             console.log('No profile found, showing profile setup');
             showProfileSetup();
           }
         } catch (error) {
           console.error('Error checking profile:', error);
           showAuthModal();
         }
       } else {
         currentUser = null;
         userProfile = null;
         console.log('No user, showing auth modal');
         // Ensure all modals are hidden first
         hideAllModals();
         showAuthModal();
       }
       
       // Mark auth state as initialized
       authStateInitialized = true;
     });

     // Show auth modal immediately for first-time users
     setTimeout(() => {
       console.log('Checking auth state - authStateInitialized:', authStateInitialized);
       if (!authStateInitialized) {
         console.log('Showing auth modal for first-time user');
         showAuthModal();
       }
     }, 100);

    // ===== UI State Management =====
         function hideAllModals() {
       console.log('Hiding all modals');
       document.getElementById('authModal').classList.add('hidden');
       document.getElementById('profileModal').classList.add('hidden');
       const settingsModal = document.getElementById('settingsModal');
       settingsModal.classList.add('hidden');
       const addCaloriesModal = document.getElementById('addCaloriesModal');
       addCaloriesModal.classList.add('hidden');
       const addWeightModal = document.getElementById('addWeightModal');
       addWeightModal.classList.add('hidden');
       const weightLoggingModal = document.getElementById('weightLoggingModal');
       weightLoggingModal.classList.add('hidden');
       
       // Hide mobile modals
       const mobileWaterLevelMenuModal = document.getElementById('mobileWaterLevelMenuModal');
       mobileWaterLevelMenuModal.classList.add('hidden');
       const mobileWaterHistoryModal = document.getElementById('mobileWaterHistoryModal');
       mobileWaterHistoryModal.classList.add('hidden');
       
       document.getElementById('appContent').classList.add('hidden');
     }

         function showAuthModal() {
       console.log('showAuthModal called');
       
       // Ensure all other modals are hidden first
       hideAllModals();
       
       const authModal = document.getElementById('authModal');
       authModal.classList.remove('hidden');
       authModal.style.zIndex = '2000';
       showSignupForm(); // Show signup form by default instead of login
     }

    function hideAuthModal() {
      document.getElementById('authModal').classList.add('hidden');
    }

         function showLoginForm() {
       document.getElementById('loginForm').classList.remove('hidden');
       document.getElementById('signupForm').classList.add('hidden');
     }

     function showSignupForm() {
       document.getElementById('loginForm').classList.add('hidden');
       document.getElementById('signupForm').classList.remove('hidden');
     }

    function showSignupForm() {
      document.getElementById('loginForm').classList.add('hidden');
      document.getElementById('signupForm').classList.remove('hidden');
    }

    function showProfileSetup() {
      // Only show profile setup if user is authenticated
      if (!currentUser) {
        console.log('Cannot show profile setup - no authenticated user');
        showAuthModal();
        return;
      }
      
      console.log('Showing profile setup for user:', currentUser.email);
      document.getElementById('authModal').classList.add('hidden');
      const profileModal = document.getElementById('profileModal');
      profileModal.classList.remove('hidden');
      document.getElementById('appContent').classList.add('hidden');
    }

    function hideProfileSetup() {
      document.getElementById('profileModal').classList.add('hidden');
    }

         function showApp() {
       document.getElementById('authModal').classList.add('hidden');
       document.getElementById('profileModal').classList.add('hidden');
       document.getElementById('appContent').classList.remove('hidden');
       
       // Enable settings buttons
       const desk = document.getElementById('openSettings');
       if (desk) desk.disabled = false;
       const mob = document.getElementById('mobileOpenSettings');
       if (mob) mob.disabled = false;  // it was left disabled in HTML
       
       // Initialize mobile layout to prevent breaking
       setTimeout(() => {
         if (typeof reinitializeMobileLayout === 'function') {
           reinitializeMobileLayout();
         }
         // Check for broken layout and fix it
         detectAndFixBrokenLayout();
         // Auto-fix layout on page reload for users with broken layouts
         autoFixLayoutOnReload();
       }, 100);
       
       // Immediate layout fix for users with broken layouts
       setTimeout(() => {
         emergencyLayoutFix();
       }, 200);
     }

     function showAddCaloriesModal() {
       // Set today's date as default
       const today = new Date().toISOString().split('T')[0];
       document.getElementById('caloriesDate').value = today;
       document.getElementById('caloriesAmount').value = '';
       
       // Clear any previous messages
       document.getElementById('addCaloriesError').classList.add('hidden');
       document.getElementById('addCaloriesSuccess').classList.add('hidden');
       
       const addCaloriesModal = document.getElementById('addCaloriesModal');
       addCaloriesModal.classList.remove('hidden');
       
       // Ensure modal is visible on mobile
       addCaloriesModal.style.zIndex = '2000';
     }

     function hideAddCaloriesModal() {
       const addCaloriesModal = document.getElementById('addCaloriesModal');
       addCaloriesModal.classList.add('hidden');
     }

    function showSettings() {
      // Only show settings if user is authenticated
      if (!currentUser || !userProfile) {
        console.log('User not authenticated or profile not loaded');
        return;
      }
      
      // Populate settings with current values
      document.getElementById('settingsAge').value = userProfile.age || '';
      document.getElementById('settingsHeightFt').value = userProfile.heightFt || '';
      document.getElementById('settingsHeightIn').value = userProfile.heightIn || '';
      document.getElementById('settingsWeight').value = userProfile.weight || '';
      document.getElementById('settingsTheme').value = currentTheme || 'dark';
      
      const settingsModal = document.getElementById('settingsModal');
      settingsModal.classList.remove('hidden');
    }

    function hideSettings() {
      const settingsModal = document.getElementById('settingsModal');
      settingsModal.classList.add('hidden');
    }

    // ===== Authentication Event Listeners =====
    document.getElementById('showSignup').addEventListener('click', showSignupForm);
    document.getElementById('showLogin').addEventListener('click', showLoginForm);


    document.getElementById('loginBtn').addEventListener('click', async () => {
      const email = document.getElementById('loginEmail').value;
      const password = document.getElementById('loginPassword').value;
      const errorDiv = document.getElementById('loginError');

      try {
        await auth.signInWithEmailAndPassword(email, password);
        errorDiv.classList.add('hidden');
      } catch (error) {
        errorDiv.textContent = error.message;
        errorDiv.classList.remove('hidden');
      }
    });

    document.getElementById('signupBtn').addEventListener('click', async () => {
      const email = document.getElementById('signupEmail').value;
      const password = document.getElementById('signupPassword').value;
      const confirmPassword = document.getElementById('confirmPassword').value;
      const errorDiv = document.getElementById('signupError');

      if (password !== confirmPassword) {
        errorDiv.textContent = 'Passwords do not match';
        errorDiv.classList.remove('hidden');
        return;
      }

      if (password.length < 6) {
        errorDiv.textContent = 'Password must be at least 6 characters';
        errorDiv.classList.remove('hidden');
        return;
      }

      try {
        await auth.createUserWithEmailAndPassword(email, password);
        errorDiv.classList.add('hidden');
      } catch (error) {
        errorDiv.textContent = error.message;
        errorDiv.classList.remove('hidden');
      }
    });

    // ===== Profile Setup =====
    document.getElementById('saveProfileBtn').addEventListener('click', async () => {
      const age = +document.getElementById('setupAge').value;
      const heightFt = +document.getElementById('setupHeightFt').value;
      const heightIn = +document.getElementById('setupHeightIn').value;
      const weight = +document.getElementById('setupWeight').value;
      const errorDiv = document.getElementById('profileError');

      if (!age || !heightFt || !weight) {
        errorDiv.textContent = 'Please fill in all fields';
        errorDiv.classList.remove('hidden');
        return;
      }

             try {
         const bmr = calcBMR(age, weight, heightFt, heightIn);
         userProfile = { age, heightFt, heightIn, weight, bmr };
         
         await db.collection('users').doc(currentUser.uid).set(userProfile);
         
         // Log initial weight for today
         const today = todayStr();
         weightByDate[today] = weight;
         await saveUserData();
         
         hideProfileSetup();
         showApp();
         loadUserData();
         errorDiv.classList.add('hidden');
       } catch (error) {
         errorDiv.textContent = error.message;
         errorDiv.classList.remove('hidden');
       }
    });

    // ===== Settings Management =====
    document.getElementById('openSettings').addEventListener('click', () => {
      // Double-check authentication before showing settings
      if (!currentUser || !userProfile) {
        console.log('Settings access denied - user not authenticated');
        return;
      }
      showSettings();
    });
    document.getElementById('cancelSettings').addEventListener('click', hideSettings);
    


    document.getElementById('saveSettings').addEventListener('click', async () => {
      // Check if user is authenticated
      if (!currentUser) {
        const errorDiv = document.getElementById('settingsError');
        errorDiv.textContent = 'Please log in to save settings';
        errorDiv.classList.remove('hidden');
        return;
      }

      const age = +document.getElementById('settingsAge').value;
      const heightFt = +document.getElementById('settingsHeightFt').value;
      const heightIn = +document.getElementById('settingsHeightIn').value;
      const weight = +document.getElementById('settingsWeight').value;
      const theme = document.getElementById('settingsTheme').value;
      const errorDiv = document.getElementById('settingsError');
      const successDiv = document.getElementById('settingsSuccess');

      if (!age || !heightFt || !weight) {
        errorDiv.textContent = 'Please fill in all fields';
        errorDiv.classList.remove('hidden');
        successDiv.classList.add('hidden');
        return;
      }

      try {
        const bmr = calcBMR(age, weight, heightFt, heightIn);
        userProfile = { ...userProfile, age, heightFt, heightIn, weight, bmr };
        currentTheme = theme;
        
        await db.collection('users').doc(currentUser.uid).update(userProfile);
        
                 // Update BMR calculation
         renderBMR(age, weight, heightFt, heightIn);
         
        // Apply theme
        applyTheme(theme);
        
        // Reinitialize mobile layout to prevent breaking
        reinitializeMobileLayout();
        
        errorDiv.classList.add('hidden');
        successDiv.textContent = 'Settings saved successfully!';
        successDiv.classList.remove('hidden');
        
        setTimeout(() => {
          successDiv.classList.add('hidden');
          hideSettings();
        }, 2000);
      } catch (error) {
        errorDiv.textContent = error.message;
        errorDiv.classList.remove('hidden');
        successDiv.classList.add('hidden');
      }
    });

         // ===== Logout =====
     document.getElementById('logoutBtn').addEventListener('click', () => {
       auth.signOut();
     });

     // ===== Delete Account =====
     document.getElementById('deleteAccountBtn').addEventListener('click', async () => {
       if (confirm('Are you sure you want to delete your account? This action cannot be undone.')) {
         try {
           await db.collection('users').doc(currentUser.uid).delete();
           await currentUser.delete();
           auth.signOut();
         } catch (error) {
           console.error('Error deleting account:', error);
           alert('Error deleting account. Please try again.');
         }
       }
     });

     // ===== Weight Logging Modal Event Listeners =====
     document.getElementById('submitDailyWeight').addEventListener('click', async () => {
       const weight = Number(document.getElementById('dailyWeight').value);
       const errorDiv = document.getElementById('weightLoggingError');
       
       if (!weight || weight <= 0) {
         errorDiv.textContent = 'Please enter a valid weight';
         errorDiv.classList.remove('hidden');
         return;
       }
       
       try {
         const today = todayStr();
         
         // Update user profile with new weight
         if (userProfile) {
           userProfile.weight = weight;
           userProfile.bmr = calcBMR(userProfile.age, weight, userProfile.heightFt, userProfile.heightIn);
           
           // Save updated profile to Firebase
           await db.collection('users').doc(currentUser.uid).update(userProfile);
           
                    // Update BMR calculation for today
         renderBMR(userProfile.age, weight, userProfile.heightFt, userProfile.heightIn);
         
         // Update settings modal if it's open
         const settingsWeightInput = document.getElementById('settingsWeight');
         if (settingsWeightInput) {
           settingsWeightInput.value = weight;
         }
         }
         
         // Add weight to tracking data
         addWeightForDate(weight, today);
         hideWeightLoggingModal();
         errorDiv.classList.add('hidden');
         
         // Reset mobile container to prevent "pushed up" state
         resetMobileContainer();
       } catch (error) {
         errorDiv.textContent = error.message;
         errorDiv.classList.remove('hidden');
       }
     });

     document.getElementById('maybeLaterWeight').addEventListener('click', () => {
       hideWeightLoggingModal();
     });

     document.getElementById('closeWeightModal').addEventListener('click', () => {
       const today = todayStr();
       weightLoggingClosed[today] = true;
       saveUserData();
       hideWeightLoggingModal();
     });

     // ===== Add Weight Modal Event Listeners =====
     // Removed - weight module replaced with meter reads module

    // ===== Data Management =====
         async function loadUserData() {
       if (!currentUser) return;

       try {
         // Load user's progress data
         const progressDoc = await db.collection('users').doc(currentUser.uid).collection('progress').doc('data').get();
         if (progressDoc.exists) {
           const data = progressDoc.data();
           console.log('Loading user data from Firebase:', data);
           
           basalByDate = data.basalByDate || {};
           activityByDate = data.activityByDate || {};
           weightByDate = data.weightByDate || {};
           waterLevelDataByDate = data.waterLevelDataByDate || {};
           customLocations = data.customLocations || [];
        meterReadsDataByDate = data.meterReadsDataByDate || {};
        customMeterReadsLocations = data.customMeterReadsLocations || [];
        residualReadingsDataByDate = data.residualReadingsDataByDate || {};
        customResidualReadingsLocations = data.customResidualReadingsLocations || [];
           foodDataByDate = data.foodDataByDate || {};
           customFoods = data.customFoods || {};
           weightLoggingClosed = data.weightLoggingClosed || {};
           currentTheme = data.currentTheme || 'dark';
           
           console.log('Loaded waterLevelDataByDate:', waterLevelDataByDate);
           console.log('Loaded customLocations:', customLocations);
           
       // Update location dropdowns with custom locations
       updateLocationDropdowns();
       updateMeterReadsLocationDropdowns();
           
           // Load streak data if it exists
           if (data.streakData) {
             streakData = { ...streakData, ...data.streakData };
             // Convert workoutDates back to Set if it exists
             if (data.streakData.workoutDates) {
               streakData.workoutDates = new Set(data.streakData.workoutDates);
             }
             // Convert waterLevelDates back to Set if it exists
             if (data.streakData.waterLevelDates) {
               streakData.waterLevelDates = new Set(data.streakData.waterLevelDates);
             }
           }
           
           // Recalculate streaks after loading data to ensure accuracy
           console.log('About to recalculate streaks...');
           calculateStreaks();
           console.log('Streaks calculated, updating display...');
           updateStreakDisplay();
           
           // Check if user is new and hide swipe hint if they have workouts
           checkAndHideSwipeHint();
           
           updateCharts();
         }

                  // Calculate and display BMR from user profile
         if (userProfile) {
           renderBMR(userProfile.age, userProfile.weight, userProfile.heightFt, userProfile.heightIn);
         }

         // Load water level charts with saved data
         loadWaterLevelChart();
         
         // Load meter reads chart
         loadMeterReadsChart();
         
         // Load residual readings chart
         loadResidualReadingsChart();
         
         loadWaterLevelHistoryChart();

         // Update food menu with custom foods
         updateFoodMenu();
         
         // Apply current theme
         applyTheme(currentTheme);

         // Check for daily weight logging only if user has a profile
         if (userProfile) {
           checkDailyWeightLogging();
         }
       } catch (error) {
         console.error('Error loading user data:', error);
       }
     }

         async function saveUserData() {
       if (!currentUser) return;

       try {
         // Convert Set to Array for Firebase storage
         const streakDataForStorage = {
           ...streakData,
           workoutDates: Array.from(streakData.workoutDates || []),
           waterLevelDates: Array.from(streakData.waterLevelDates || [])
         };
         
         await db.collection('users').doc(currentUser.uid).collection('progress').doc('data').set({
           basalByDate,
           activityByDate,
           weightByDate,
           waterLevelDataByDate,
           customLocations,
        meterReadsDataByDate,
        customMeterReadsLocations,
        residualReadingsDataByDate,
        customResidualReadingsLocations,
           foodDataByDate,
           customFoods,
           weightLoggingClosed,
           currentTheme,
           streakData: streakDataForStorage,
           lastUpdated: new Date()
         });
       } catch (error) {
         console.error('Error saving user data:', error);
       }
     }

         // ===== Helper Functions =====
     function todayStr(){
       const now = new Date();
       const year = now.getFullYear();
       const month = String(now.getMonth() + 1).padStart(2, '0');
       const day = String(now.getDate()).padStart(2, '0');
       return `${year}-${month}-${day}`;
     }

     function getLocationColor(index, alpha = 1) {
       const colors = [
         '#3b82f6', // blue
         '#10b981', // emerald
         '#f59e0b', // amber
         '#ef4444', // red
         '#8b5cf6', // violet
         '#06b6d4', // cyan
         '#84cc16', // lime
         '#f97316', // orange
         '#ec4899', // pink
         '#6b7280'  // gray
       ];
       
       const color = colors[index % colors.length];
       if (alpha < 1) {
         // Convert hex to rgba
         const r = parseInt(color.slice(1, 3), 16);
         const g = parseInt(color.slice(3, 5), 16);
         const b = parseInt(color.slice(5, 7), 16);
         return `rgba(${r}, ${g}, ${b}, ${alpha})`;
       }
       return color;
     }
     
     // ===== Streak Functions =====
    function calculateStreaks() {
      const today = todayStr();
      console.log('calculateStreaks called, waterLevelDataByDate:', waterLevelDataByDate);
      
      const waterLevelDates = Object.keys(waterLevelDataByDate).filter(date => {
        const day = waterLevelDataByDate[date];
        const hasWaterLevel = day && Object.keys(day).length > 0;
        console.log(`Date ${date}: hasWaterLevel=${hasWaterLevel}`);
        return hasWaterLevel;
      }).sort();
      
      console.log('Filtered water level dates:', waterLevelDates);
      
      if (waterLevelDates.length === 0) {
        streakData.currentStreak = 0;
        streakData.bestStreak = 0;
        streakData.totalWaterLevels = 0;
        streakData.averageStreak = 0;
        streakData.lastWaterLevelDate = null;
        streakData.waterLevelDates = new Set();
        streakData.completedStreaks = [];
        return;
      }
      
      // Calculate total water level entries
      streakData.totalWaterLevels = waterLevelDates.length;
      streakData.lastWaterLevelDate = waterLevelDates[waterLevelDates.length - 1];
      streakData.waterLevelDates = new Set(waterLevelDates);
      
      // Calculate all individual streaks
      const allStreaks = [];
      let tempStreak = 0;
      
      for (let i = 0; i < waterLevelDates.length; i++) {
        if (i === 0) {
          tempStreak = 1;
        } else {
          const prevDate = new Date(waterLevelDates[i - 1]);
          const currDate = new Date(waterLevelDates[i]);
          const diffDays = Math.round((currDate - prevDate) / (1000 * 60 * 60 * 24));
          
          if (diffDays === 1) {
            tempStreak++;
          } else {
            // Streak ended, add to completed streaks if it's > 1 day
            if (tempStreak > 1) {
              allStreaks.push(tempStreak);
            }
            tempStreak = 1;
          }
        }
      }
      
      // Add the last streak if it's > 1 day
      if (tempStreak > 1) {
        allStreaks.push(tempStreak);
      }
      
      // Calculate current streak
      let currentStreak = 0;
      let currentDate = new Date(today);
      
      // Check if user logged water level today
      if (waterLevelDates.includes(today)) {
        currentStreak = 1;
        currentDate.setDate(currentDate.getDate() - 1);
        
        // Count backwards to find consecutive days
        while (true) {
          const checkDate = currentDate.toISOString().split('T')[0];
          if (waterLevelDates.includes(checkDate)) {
            currentStreak++;
            currentDate.setDate(currentDate.getDate() - 1);
          } else {
            break;
          }
        }
      } else {
        // Check if user worked out yesterday
        const yesterday = new Date(today);
        yesterday.setDate(yesterday.getDate() - 1);
        const yesterdayStr = yesterday.toISOString().split('T')[0];
        
        if (waterLevelDates.includes(yesterdayStr)) {
          // Count backwards from yesterday
          currentStreak = 1;
          currentDate.setDate(currentDate.getDate() - 2);
          
          while (true) {
            const checkDate = currentDate.toISOString().split('T')[0];
            if (waterLevelDates.includes(checkDate)) {
              currentStreak++;
              currentDate.setDate(currentDate.getDate() - 1);
            } else {
              break;
            }
          }
        } else {
          currentStreak = 0;
        }
      }
      
      streakData.currentStreak = currentStreak;
      
      // Calculate best streak
      const bestStreak = allStreaks.length > 0 ? Math.max(...allStreaks) : 0;
      streakData.bestStreak = bestStreak;
      
      // Calculate average streak (including current streak if it's > 1 day)
      const streaksForAverage = [...allStreaks];
      if (currentStreak > 1) {
        streaksForAverage.push(currentStreak);
      }
      
      if (streaksForAverage.length > 0) {
        streakData.averageStreak = Math.round((streaksForAverage.reduce((sum, streak) => sum + streak, 0) / streaksForAverage.length) * 10) / 10;
      } else {
        streakData.averageStreak = 0;
      }
      
      // Update completed streaks for Firebase storage
      streakData.completedStreaks = allStreaks;
      
      // Check if a streak just ended and save it
      checkAndSaveCompletedStreak();
    }
    
    // Function to detect when a streak ends and save the completed streak length
    function checkAndSaveCompletedStreak() {
      // This function will be called after calculateStreaks to check if a streak just ended
      // and save the completed streak length to Firebase
      
      // Get the previous streak data from localStorage to compare
      const previousStreakData = JSON.parse(localStorage.getItem('previousStreakData') || '{}');
      
      // If we had a current streak before and now it's 0, a streak just ended
      if (previousStreakData.currentStreak > 0 && streakData.currentStreak === 0) {
        console.log(`Streak ended! Length was: ${previousStreakData.currentStreak} days`);
        
        // Add the completed streak to the completedStreaks array
        if (previousStreakData.currentStreak > 1) {
          streakData.completedStreaks.push(previousStreakData.currentStreak);
          
          // Recalculate average streak
          const streaksForAverage = [...streakData.completedStreaks];
          if (streakData.currentStreak > 1) {
            streaksForAverage.push(streakData.currentStreak);
          }
          
          if (streaksForAverage.length > 0) {
            streakData.averageStreak = Math.round((streaksForAverage.reduce((sum, streak) => sum + streak, 0) / streaksForAverage.length) * 10) / 10;
          }
          
          // Save updated data to Firebase
          saveUserData();
        }
      }
      
      // Save current streak data for next comparison
      localStorage.setItem('previousStreakData', JSON.stringify({
        currentStreak: streakData.currentStreak,
        completedStreaks: [...streakData.completedStreaks]
      }));
    }
     
     function checkAndHideSwipeHint() {
       // Hide swipe hint if user has logged any workouts
       if (streakData.totalWorkouts > 0) {
         const swipeHint = document.querySelector('.swipe-hint');
         if (swipeHint) {
           swipeHint.style.display = 'none';
         }
       }
     }
     
     function updateStreakDisplay() {
       console.log('updateStreakDisplay called, streakData:', streakData);
       
       // Check if user is new (no workouts logged) and hide swipe hint if they have workouts
       checkAndHideSwipeHint();
       
       // Update mobile streak display
       const mobileStreakCount = document.getElementById('mobileStreakCount');
       const mobileBestStreak = document.getElementById('mobileBestStreak');
       const mobileAverageStreak = document.getElementById('mobileAverageStreak');
       const mobileStreakBar = document.getElementById('mobileStreakBar');
       
       console.log('Mobile elements found:', {
         mobileStreakCount: !!mobileStreakCount,
         mobileBestStreak: !!mobileBestStreak,
         mobileAverageStreak: !!mobileAverageStreak,
         mobileStreakBar: !!mobileStreakBar
       });
       
       if (mobileStreakCount) {
         console.log(`Setting mobile streak count to: ${streakData.currentStreak}`);
         mobileStreakCount.textContent = streakData.currentStreak;
         mobileBestStreak.textContent = streakData.bestStreak;
         mobileAverageStreak.textContent = streakData.averageStreak;
         
         // Update progress bar (max at 30 days for visual appeal)
         const progressPercent = Math.min((streakData.currentStreak / 30) * 100, 100);
         mobileStreakBar.style.width = progressPercent + '%';
         
        // Update mobile icons based on streak
        const mobileFireIcon = document.querySelector('.streak-icon .animated-fire');
        
        // Always show the fire icon
        if (mobileFireIcon) mobileFireIcon.style.display = 'block';
       }
       
       // Update desktop streak display
       const desktopStreakCount = document.getElementById('desktopStreakCount');
       const desktopBestStreak = document.getElementById('desktopBestStreak');
       const desktopAverageStreak = document.getElementById('desktopAverageStreak');
       const desktopCurrentWeek = document.getElementById('desktopCurrentWeek');
       const desktopStreakBar = document.getElementById('desktopStreakBar');
       
       console.log('Desktop elements found:', {
         desktopStreakCount: !!desktopStreakCount,
         desktopBestStreak: !!desktopBestStreak,
         desktopAverageStreak: !!desktopAverageStreak,
         desktopCurrentWeek: !!desktopCurrentWeek,
         desktopStreakBar: !!desktopStreakBar
       });
       
       if (desktopStreakCount) {
         console.log(`Setting desktop streak count to: ${streakData.currentStreak}`);
         desktopStreakCount.textContent = streakData.currentStreak;
         desktopBestStreak.textContent = streakData.bestStreak;
         desktopAverageStreak.textContent = streakData.averageStreak;
         
         // Calculate workouts this week
         const today = new Date();
         const weekStart = new Date(today);
         weekStart.setDate(today.getDate() - today.getDay());
         const weekStartStr = weekStart.toISOString().split('T')[0];
         
         let weekWorkouts = 0;
         for (let i = 0; i < 7; i++) {
           const checkDate = new Date(weekStart);
           checkDate.setDate(weekStart.getDate() + i);
           const checkDateStr = checkDate.toISOString().split('T')[0];
           
           if (streakData.waterLevelDates.has(checkDateStr)) {
             weekWorkouts++;
           }
         }
         
         desktopCurrentWeek.textContent = weekWorkouts;
         
         // Update progress bar
         const progressPercent = Math.min((streakData.currentStreak / 30) * 100, 100);
         desktopStreakBar.style.width = progressPercent + '%';
         
        // Update desktop icons based on streak
        const desktopFireIcon = document.querySelector('.streak-icon-large .animated-fire-large');
        
        // Always show the fire icon
        if (desktopFireIcon) desktopFireIcon.style.display = 'block';
       }
     }

     // ===== Weight Tracking Functions =====
     function checkDailyWeightLogging() {
       const today = todayStr();
       
       // Don't show if already logged or closed for today
       if (weightByDate[today] || weightLoggingClosed[today]) {
         return;
       }
       
       // Show weight logging modal
       showWeightLoggingModal();
     }

     function showWeightLoggingModal() {
       const weightLoggingModal = document.getElementById('weightLoggingModal');
       weightLoggingModal.classList.remove('hidden');
     }

     function hideWeightLoggingModal() {
       const weightLoggingModal = document.getElementById('weightLoggingModal');
       weightLoggingModal.classList.add('hidden');
       // Reset mobile container to prevent "pushed up" state
       resetMobileContainer();
     }

     function showAddWeightModal() {
       const today = new Date().toISOString().split('T')[0];
       document.getElementById('weightDate').value = today;
       document.getElementById('weightAmount').value = '';
       
       // Clear any previous messages
       document.getElementById('addWeightError').classList.add('hidden');
       document.getElementById('addWeightSuccess').classList.add('hidden');
       
       const addWeightModal = document.getElementById('addWeightModal');
       addWeightModal.classList.remove('hidden');
     }

     function hideAddWeightModal() {
       const addWeightModal = document.getElementById('addWeightModal');
       addWeightModal.classList.add('hidden');
       // Reset mobile container to prevent "pushed up" state
       resetMobileContainer();
     }

     function showMobileWaterLevelMenu() {
       const mobileWaterLevelMenuModal = document.getElementById('mobileWaterLevelMenuModal');
       mobileWaterLevelMenuModal.classList.remove('hidden');
       mobileWaterLevelMenuModal.style.zIndex = '2000';
     }

     function hideMobileWaterLevelMenu() {
       const mobileWaterLevelMenuModal = document.getElementById('mobileWaterLevelMenuModal');
       mobileWaterLevelMenuModal.classList.add('hidden');
       // Reset mobile container to prevent "pushed up" state
       resetMobileContainer();
     }

     function showMobileWaterLevelModal() {
       const mobileWaterLevelModal = document.getElementById('mobileWaterLevelModal');
       mobileWaterLevelModal.classList.remove('hidden');
       mobileWaterLevelModal.style.zIndex = '2000';
       
       // Set default values
       document.getElementById('mobileWaterLocation').value = '';
       document.getElementById('mobileCustomLocationName').value = '';
       document.getElementById('mobileWaterLevel').value = '';
       document.getElementById('mobileWaterDate').value = todayStr();
       previewMobileWaterLevel();
     }

     function hideMobileTreadmillModal() {
       const mobileTreadmillModal = document.getElementById('mobileTreadmillModal');
       mobileTreadmillModal.classList.add('hidden');
       // Reset mobile container to prevent "pushed up" state
       resetMobileContainer();
     }

     function showMobileWaterHistoryModal() {
       const mobileWaterHistoryModal = document.getElementById('mobileWaterHistoryModal');
       mobileWaterHistoryModal.classList.remove('hidden');
       mobileWaterHistoryModal.style.zIndex = '2000';
       
       // Load water level history data
       loadMobileWaterLevelHistory();
     }

     function hideMobileWaterLevelModal() {
       const mobileWaterLevelModal = document.getElementById('mobileWaterLevelModal');
       mobileWaterLevelModal.classList.add('hidden');
       // Reset mobile container to prevent "pushed up" state
       resetMobileContainer();
     }

     function hideMobileWaterHistoryModal() {
       const mobileWaterHistoryModal = document.getElementById('mobileWaterHistoryModal');
       mobileWaterHistoryModal.classList.add('hidden');
       // Reset mobile container to prevent "pushed up" state
       resetMobileContainer();
     }

     function previewMobileWaterLevel() {
       const location = document.getElementById('mobileWaterLocation').value;
       const customLocation = document.getElementById('mobileCustomLocationName').value;
       const level = document.getElementById('mobileWaterLevel').value;
       const date = document.getElementById('mobileWaterDate').value;
       
       if (location && level > 0 && date) {
         const locationName = location === 'custom' ? customLocation : location;
         document.getElementById('mobileWaterResult').innerHTML = `<div class='math'>Preview: ${locationName} - ${level} ft on ${date}</div>`;
       } else {
         document.getElementById('mobileWaterResult').innerHTML = '';
       }
     }

     function loadMobileWaterLevelHistory() {
       const resultDiv = document.getElementById('mobileWaterHistoryResult');
       const locationFilter = document.getElementById('mobileHistoryLocation').value;
       const dateRangeFilter = document.getElementById('mobileHistoryDateRange').value;
       
       let dates = Object.keys(waterLevelDataByDate).sort();
       
       // Apply date range filter
       if (dateRangeFilter !== 'all') {
         const days = parseInt(dateRangeFilter);
         const cutoffDate = new Date();
         cutoffDate.setDate(cutoffDate.getDate() - days);
         const cutoffDateStr = cutoffDate.toISOString().split('T')[0];
         dates = dates.filter(date => date >= cutoffDateStr);
       }
       
       // Apply location filter
       let filteredData = [];
       dates.forEach(date => {
         const dayData = waterLevelDataByDate[date];
         Object.keys(dayData).forEach(location => {
           if (dayData[location] && dayData[location].level) {
             // Check location filter
             if (!locationFilter || location === locationFilter) {
               filteredData.push({
                 date,
                 location,
                 data: dayData[location]
               });
             }
           }
         });
       });
       
       if (filteredData.length === 0) {
         const noDataMessage = locationFilter || dateRangeFilter !== 'all' 
           ? 'No data found for the selected filters'
           : 'No water level data recorded yet';
         resultDiv.innerHTML = `
           <div style="text-align: center; padding: 40px 20px; color: #9ca3af;">
             <div style="font-size: 48px; margin-bottom: 16px;">üíß</div>
             <h3 style="color: #f9fafb; margin-bottom: 8px; font-size: 18px;">${noDataMessage}</h3>
             <p style="color: #9ca3af; font-size: 14px;">${locationFilter || dateRangeFilter !== 'all' ? 'Try adjusting your filters' : 'Start logging water levels to see your history here'}</p>
           </div>
         `;
         return;
       }
       
       let historyHTML = `
         <div style="margin-bottom: 20px;">
           <h4 style="margin: 0 0 16px 0; color: #f3f4f6; font-size: 18px; font-weight: 600;">Recent Water Level Entries</h4>
           <div style="display: flex; flex-direction: column; gap: 12px;">
       `;
       
       // Show entries in reverse chronological order (most recent first)
       filteredData.reverse().forEach(entry => {
         const formattedDate = new Date(entry.date).toLocaleDateString('en-US', { 
           month: 'short', 
           day: 'numeric', 
           year: 'numeric' 
         });
         
         historyHTML += `
           <div style="
             background: linear-gradient(135deg, #1f2937 0%, #374151 100%);
             border: 1px solid #4b5563;
             border-radius: 12px;
             padding: 16px;
             display: flex;
             justify-content: space-between;
             align-items: center;
             transition: all 0.2s ease;
             box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
           " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 8px rgba(0, 0, 0, 0.2)'" 
             onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 4px rgba(0, 0, 0, 0.1)'">
             <div style="display: flex; flex-direction: column; gap: 4px;">
               <div style="font-weight: 600; color: #f3f4f6; font-size: 16px;">${entry.data.locationName}</div>
               <div style="color: #9ca3af; font-size: 14px;">${formattedDate}</div>
             </div>
             <div style="display: flex; align-items: center; gap: 12px;">
               <div style="
                 background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
                 color: white;
                 padding: 8px 16px;
                 border-radius: 20px;
                 font-weight: 600;
                 font-size: 14px;
                 min-width: 80px;
                 text-align: center;
               ">${entry.data.level} ft</div>
               <button onclick="deleteWaterLevelEntry('${entry.date}', '${entry.data.locationName}')" style="
                 background: #dc2626;
                 color: white;
                 border: none;
                 border-radius: 6px;
                 padding: 8px 12px;
                 font-size: 12px;
                 cursor: pointer;
                 transition: all 0.2s ease;
               " onmouseover="this.style.background='#b91c1c'" onmouseout="this.style.background='#dc2626'">
                 üóëÔ∏è Delete
               </button>
             </div>
           </div>
         `;
       });
       
       historyHTML += `
           </div>
         </div>
       `;
       
       resultDiv.innerHTML = historyHTML;
     }

     function deleteWaterLevelEntry(date, locationName) {
       console.log('Delete button clicked for:', date, locationName);
       if (confirm('Are you sure you want to delete this water level entry?')) {
         console.log('User confirmed deletion');
         
         // Find the entry by locationName (since that's what we're searching for)
         let foundEntry = null;
         let foundKey = null;
         
         if (waterLevelDataByDate[date]) {
           Object.keys(waterLevelDataByDate[date]).forEach(key => {
             if (waterLevelDataByDate[date][key] && waterLevelDataByDate[date][key].locationName === locationName) {
               foundEntry = waterLevelDataByDate[date][key];
               foundKey = key;
             }
           });
         }
         
         if (foundEntry && foundKey) {
           console.log('Found entry to delete:', foundEntry);
           delete waterLevelDataByDate[date][foundKey];
           
           // If no more entries for this date, remove the date entirely
           if (Object.keys(waterLevelDataByDate[date]).length === 0) {
             delete waterLevelDataByDate[date];
           }
           
           // Save to Firebase
           saveUserData();
           
           // Reload the history to reflect changes
           loadMobileWaterLevelHistory();
           
           // Update charts
           updateCharts();
           console.log('Entry deleted successfully');
         } else {
           console.log('Entry not found in data');
         }
       }
     }

     // ===== Excel Export Function =====
     function exportWaterLevelDataToExcel() {
       // Download the file immediately
       downloadWaterLevelCSV();
       
       // Also show email modal
       showWaterLevelEmailModal();
     }

     function downloadWaterLevelCSV() {
       const dates = Object.keys(waterLevelDataByDate).sort();
       const allData = [];
       
       // Add header row
       allData.push(['Date', 'Location', 'Water Level (ft)', 'Timestamp']);
       
       // Add data rows
       dates.forEach(date => {
         const dayData = waterLevelDataByDate[date];
         Object.keys(dayData).forEach(location => {
           if (dayData[location] && dayData[location].level) {
             allData.push([
               date,
               dayData[location].locationName,
               dayData[location].level,
               dayData[location].timestamp || ''
             ]);
           }
         });
       });
       
       // Convert to CSV format
       const csvContent = allData.map(row => 
         row.map(cell => `"${cell}"`).join(',')
       ).join('\n');
       
       // Create and download file
       const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
       const link = document.createElement('a');
       const url = URL.createObjectURL(blob);
       link.setAttribute('href', url);
       link.setAttribute('download', `water_level_data_${todayStr()}.csv`);
       link.style.visibility = 'hidden';
       document.body.appendChild(link);
       link.click();
       document.body.removeChild(link);
     }

     function showWaterLevelEmailModal() {
       console.log('showWaterLevelEmailModal called');
       
       // Create a completely new, simple modal that we know will work
       const existingModal = document.getElementById('waterLevelEmailModal');
       if (existingModal) {
         existingModal.remove();
       }
       
       // Create new modal
       const newModal = document.createElement('div');
       newModal.id = 'waterLevelEmailModal';
       newModal.style.cssText = `
         position: fixed;
         top: 0;
         left: 0;
         width: 100vw;
         height: 100vh;
         background-color: rgba(0, 0, 0, 0.8);
         z-index: 99999;
         display: flex;
         align-items: center;
         justify-content: center;
         padding: 20px;
         box-sizing: border-box;
       `;
       
       // Create modal content
       const modalContent = document.createElement('div');
       modalContent.style.cssText = `
         background-color: #1f2937;
         border-radius: 12px;
         padding: 20px;
         max-width: 90%;
         max-height: 90vh;
         overflow-y: auto;
         color: white;
         width: 100%;
         box-sizing: border-box;
       `;
       
       // Add content
       modalContent.innerHTML = `
         <div style="display: flex; align-items: center; margin-bottom: 20px;">
           <div style="font-size: 24px; margin-right: 12px;">üìß</div>
           <div>
             <h3 style="margin: 0; color: #f3f4f6; font-size: 18px;">Send Data via Email</h3>
             <p style="margin: 4px 0 0 0; color: #9ca3af; font-size: 14px;">Enter email address to receive your water level data</p>
           </div>
         </div>
         
         <div style="margin-bottom: 20px;">
           <label style="display: block; color: #d1d5db; font-size: 14px; margin-bottom: 8px;">Email Address</label>
           <input id="waterLevelEmailAddress" type="email" placeholder="Enter email address" style="
             width: 100%;
             padding: 12px;
             background: #374151;
             border: 1px solid #4b5563;
             border-radius: 6px;
             color: #f9fafb;
             font-size: 14px;
             box-sizing: border-box;
           " />
         </div>
         
         <div id="waterLevelEmailResult" style="margin-bottom: 16px;"></div>
         
         <div style="display: flex; flex-direction: column; gap: 12px;">
           <button id="sendWaterLevelEmailBtn" class="primary" style="width: 100%;">üìß Send Data</button>
           <button id="closeWaterLevelEmailModal" class="ghost" style="width: 100%;">Close</button>
         </div>
       `;
       
       newModal.appendChild(modalContent);
       document.body.appendChild(newModal);
       
       // Add event listeners
       document.getElementById('closeWaterLevelEmailModal').addEventListener('click', hideWaterLevelEmailModal);
       document.getElementById('sendWaterLevelEmailBtn').addEventListener('click', sendWaterLevelDataViaEmail);
       
       console.log('New water level email modal created and should be visible');
     }

     function hideWaterLevelEmailModal() {
       const waterLevelEmailModal = document.getElementById('waterLevelEmailModal');
       if (waterLevelEmailModal) {
         waterLevelEmailModal.remove();
       }
     }

     function sendWaterLevelDataViaEmail() {
       const emailAddress = document.getElementById('waterLevelEmailAddress').value.trim();
       const resultDiv = document.getElementById('waterLevelEmailResult');
       
       if (!emailAddress) {
         resultDiv.innerHTML = '<p style="color: #ef4444; margin: 0;">Please enter an email address</p>';
         return;
       }
       
       if (!emailAddress.includes('@')) {
         resultDiv.innerHTML = '<p style="color: #ef4444; margin: 0;">Please enter a valid email address</p>';
         return;
       }
       
       // Show loading state
       resultDiv.innerHTML = '<p style="color: #3b82f6; margin: 0;">Sending email...</p>';
       document.getElementById('sendWaterLevelEmailBtn').disabled = true;
       document.getElementById('sendWaterLevelEmailBtn').textContent = 'Sending...';
       
       // Prepare data
       const dates = Object.keys(waterLevelDataByDate).sort();
       const allData = [];
       
       // Add header row
       allData.push(['Date', 'Location', 'Water Level (ft)', 'Timestamp']);
       
       // Add data rows
       dates.forEach(date => {
         const dayData = waterLevelDataByDate[date];
         Object.keys(dayData).forEach(location => {
           if (dayData[location] && dayData[location].level) {
             allData.push([
               date,
               dayData[location].locationName,
               dayData[location].level,
               dayData[location].timestamp || ''
             ]);
           }
         });
       });
       
       // Convert to CSV format
       const csvContent = allData.map(row => 
         row.map(cell => `"${cell}"`).join(',')
       ).join('\n');
       
       // Create HTML table for email body - using more email-friendly HTML
       let tableHTML = `
         <table border="1" cellpadding="8" cellspacing="0" style="border-collapse: collapse; width: 100%; font-family: Arial, sans-serif; margin: 20px 0;">
           <tr style="background-color: #f2f2f2;">
             <th style="border: 1px solid #ddd; padding: 8px; text-align: left;">Date</th>
             <th style="border: 1px solid #ddd; padding: 8px; text-align: left;">Location</th>
             <th style="border: 1px solid #ddd; padding: 8px; text-align: left;">Water Level (ft)</th>
             <th style="border: 1px solid #ddd; padding: 8px; text-align: left;">Timestamp</th>
           </tr>
       `;
       
       // Add data rows
       dates.forEach(date => {
         const dayData = waterLevelDataByDate[date];
         Object.keys(dayData).forEach(location => {
           if (dayData[location] && dayData[location].level) {
             const timestamp = dayData[location].timestamp ? 
               new Date(dayData[location].timestamp).toLocaleString() : '';
             tableHTML += `
               <tr>
                 <td style="border: 1px solid #ddd; padding: 8px;">${date}</td>
                 <td style="border: 1px solid #ddd; padding: 8px;">${dayData[location].locationName}</td>
                 <td style="border: 1px solid #ddd; padding: 8px;">${dayData[location].level}</td>
                 <td style="border: 1px solid #ddd; padding: 8px;">${timestamp}</td>
               </tr>
             `;
           }
         });
       });
       
       tableHTML += `
         </table>
       `;
       
       // Create a simple text table as backup
       let textTable = `
Water Level Data
================

Date         | Location | Water Level (ft) | Timestamp
-------------|----------|------------------|------------------
       `;
       
       dates.forEach(date => {
         const dayData = waterLevelDataByDate[date];
         Object.keys(dayData).forEach(location => {
           if (dayData[location] && dayData[location].level) {
             const timestamp = dayData[location].timestamp ? 
               new Date(dayData[location].timestamp).toLocaleString() : '';
             textTable += `${date.padEnd(12)} | ${dayData[location].locationName.padEnd(8)} | ${dayData[location].level.toString().padEnd(16)} | ${timestamp}\n`;
           }
         });
       });
       
       textTable += `
================
       `;
       
       // Send email using EmailJS
       const templateParams = {
         user_email: emailAddress,
         to_email: emailAddress,
         email: emailAddress,
         from_name: 'WaterData App',
         subject: `Water Level Data - ${todayStr()}`,
         message: `Please find your water level data below, exported on ${new Date().toLocaleDateString()}.`,
         table_data: tableHTML,
         text_table: textTable,
         csv_content: csvContent,
         export_date: new Date().toLocaleDateString()
       };
       
       console.log('Sending water level email with params:', templateParams);
       console.log('Email address being sent:', emailAddress);
       console.log('Table HTML being sent:', tableHTML);
       
       emailjs.send('service_tr7srcd', 'template_6er1sgu', templateParams)
         .then(function(response) {
           console.log('Email sent successfully:', response);
           resultDiv.innerHTML = '<p style="color: #10b981; margin: 0;">‚úÖ Email sent successfully!</p>';
           document.getElementById('sendWaterLevelEmailBtn').textContent = 'Email Sent!';
           
           // Close modal after 2 seconds
           setTimeout(() => {
             hideWaterLevelEmailModal();
           }, 2000);
         })
         .catch(function(error) {
           console.error('Email sending failed:', error);
           resultDiv.innerHTML = '<p style="color: #ef4444; margin: 0;">‚ùå Failed to send email. Please try again.</p>';
           document.getElementById('sendWaterLevelEmailBtn').disabled = false;
           document.getElementById('sendWaterLevelEmailBtn').textContent = 'üìß Send Data';
         });
     }

     // ===== Custom Locations Management =====
     function showLocationsModal() {
       console.log('showLocationsModal called');
       
       // Create a completely new, simple modal that we know will work
       const existingModal = document.getElementById('locationsModal');
       if (existingModal) {
         existingModal.remove();
       }
       
       // Create new modal
       const newModal = document.createElement('div');
       newModal.id = 'locationsModal';
       newModal.style.cssText = `
         position: fixed;
         top: 0;
         left: 0;
         width: 100vw;
         height: 100vh;
         background-color: rgba(0, 0, 0, 0.8);
         z-index: 99999;
         display: flex;
         align-items: center;
         justify-content: center;
         padding: 20px;
         box-sizing: border-box;
       `;
       
       // Create modal content
       const modalContent = document.createElement('div');
       modalContent.style.cssText = `
         background-color: #1f2937;
         border-radius: 12px;
         padding: 20px;
         max-width: 90%;
         max-height: 90vh;
         overflow-y: auto;
         color: white;
         width: 100%;
         box-sizing: border-box;
       `;
       
       // Add content
       modalContent.innerHTML = `
         <h3 style="margin: 0 0 16px 0; color: #f3f4f6; font-size: 18px;">Manage Water Level Locations</h3>
         <p style="margin: 0 0 20px 0; color: #9ca3af; font-size: 14px;">Add or remove custom locations for water level tracking</p>
         
         <div style="margin-bottom: 24px;">
           <h4 style="color: #f3f4f6; margin-bottom: 12px; font-size: 16px;">Add New Location</h4>
           <input id="newLocationName" type="text" placeholder="Enter location name (e.g., Lake Tahoe)" style="
             width: 100%;
             padding: 10px 12px;
             background: #374151;
             border: 1px solid #4b5563;
             border-radius: 6px;
             color: #f9fafb;
             font-size: 14px;
             margin-bottom: 12px;
             box-sizing: border-box;
           " />
           <button id="addLocationBtn" class="primary" style="width: 100%;"> Add Location</button>
         </div>
         
         <div>
           <h4 style="color: #f3f4f6; margin-bottom: 12px; font-size: 16px;">Your Locations</h4>
           <div id="locationsList" style="max-height: 200px; overflow-y: auto;">
             <div style="text-align: center; padding: 20px; color: #9ca3af;">
               <div style="font-size: 32px; margin-bottom: 8px;">üìç</div>
               <p style="margin: 0 0 8px 0; font-size: 14px;">No custom locations added yet</p>
               <p style="margin: 0; font-size: 12px; opacity: 0.7;">Add locations above or log water data with custom locations to get started</p>
             </div>
           </div>
         </div>
         
         <div style="margin-top: 20px; text-align: center;">
           <button id="closeLocationsModal" class="ghost">Close</button>
         </div>
       `;
       
       newModal.appendChild(modalContent);
       document.body.appendChild(newModal);
       
       // Add event listeners
       document.getElementById('addLocationBtn').addEventListener('click', addLocation);
       document.getElementById('closeLocationsModal').addEventListener('click', hideLocationsModal);
       document.getElementById('newLocationName').addEventListener('keypress', function(e) {
         if (e.key === 'Enter') {
           addLocation();
         }
       });
       
       // Load locations
       loadLocationsList();
       
       console.log('New modal created and should be visible');
     }

     function hideLocationsModal() {
       const locationsModal = document.getElementById('locationsModal');
       if (locationsModal) {
         locationsModal.remove();
       }
     }

     function loadLocationsList() {
       const locationsList = document.getElementById('locationsList');
       
       if (customLocations.length === 0) {
         locationsList.innerHTML = `
           <div style="text-align: center; padding: 20px; color: #9ca3af;">
             <div style="font-size: 32px; margin-bottom: 8px;">üìç</div>
             <p style="margin: 0; font-size: 14px;">No custom locations added yet</p>
           </div>
         `;
         return;
       }

       let locationsHTML = '';
       customLocations.forEach((location, index) => {
         locationsHTML += `
           <div style="
             background: linear-gradient(135deg, #374151 0%, #4b5563 100%);
             border: 1px solid #4b5563;
             border-radius: 8px;
             padding: 12px 16px;
             margin-bottom: 8px;
             display: flex;
             justify-content: space-between;
             align-items: center;
             transition: all 0.2s ease;
           " onmouseover="this.style.transform='translateY(-1px)'; this.style.boxShadow='0 2px 4px rgba(0, 0, 0, 0.2)'" 
             onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'">
             <span style="color: #f3f4f6; font-weight: 500;">${location}</span>
             <div style="display: flex; gap: 8px;">
               <button onclick="editLocation(${index})" style="
                 background: #3b82f6;
                 color: white;
                 border: none;
                 border-radius: 4px;
                 padding: 4px 8px;
                 font-size: 12px;
                 cursor: pointer;
                 transition: all 0.2s ease;
               " onmouseover="this.style.background='#2563eb'" onmouseout="this.style.background='#3b82f6'">
                 ‚úèÔ∏è Edit
               </button>
               <button onclick="removeLocation(${index})" style="
                 background: #dc2626;
                 color: white;
                 border: none;
                 border-radius: 4px;
                 padding: 4px 8px;
                 font-size: 12px;
                 cursor: pointer;
                 transition: all 0.2s ease;
               " onmouseover="this.style.background='#b91c1c'" onmouseout="this.style.background='#dc2626'">
                 üóëÔ∏è Delete
               </button>
             </div>
           </div>
         `;
       });
       
       locationsList.innerHTML = locationsHTML;
     }

     function addLocation() {
       const newLocationName = document.getElementById('newLocationName').value.trim();
       
       if (!newLocationName) {
         alert('Please enter a location name');
         return;
       }
       
       if (customLocations.includes(newLocationName)) {
         alert('This location already exists');
         return;
       }
       
       customLocations.push(newLocationName);
       document.getElementById('newLocationName').value = '';
       loadLocationsList();
       updateLocationDropdowns();
       saveUserData();
     }

     function editLocation(index) {
       const newName = prompt('Enter new location name:', customLocations[index]);
       if (newName && newName.trim() && newName.trim() !== customLocations[index]) {
         if (customLocations.includes(newName.trim())) {
           alert('This location already exists');
           return;
         }
         customLocations[index] = newName.trim();
         loadLocationsList();
         updateLocationDropdowns();
         saveUserData();
       }
     }

     function removeLocation(index) {
       if (confirm('Are you sure you want to delete this location?')) {
         customLocations.splice(index, 1);
         loadLocationsList();
         updateLocationDropdowns();
         saveUserData();
       }
     }

     function updateLocationDropdowns() {
       // Update desktop water location dropdown
       const waterLocation = document.getElementById('waterLocation');
       const mobileWaterLocation = document.getElementById('mobileWaterLocation');
       
       // Clear all options except the first one (which should be empty)
       [waterLocation, mobileWaterLocation].forEach(dropdown => {
         // Keep only the first option (empty/default)
         while (dropdown.children.length > 1) {
           dropdown.removeChild(dropdown.lastChild);
         }
       });
       
       // Add custom locations first
       customLocations.forEach(location => {
         const option = document.createElement('option');
         option.value = location;
         option.textContent = location;
         option.setAttribute('data-custom', 'true');
         
         [waterLocation, mobileWaterLocation].forEach(dropdown => {
           dropdown.appendChild(option.cloneNode(true));
         });
       });
       
       // Add "Add Custom Location" option at the end
       const customOption = document.createElement('option');
       customOption.value = 'custom';
       customOption.textContent = '+ Add Custom Location';
       customOption.setAttribute('data-custom', 'true');
       
       [waterLocation, mobileWaterLocation].forEach(dropdown => {
         dropdown.appendChild(customOption.cloneNode(true));
       });
     }


     // ===== Meter Reads Functions =====
     function showMeterReadsMenu() {
       console.log('showMeterReadsMenu called');
       
       // Create a completely new, simple modal that we know will work
       const existingModal = document.getElementById('meterReadsMenuModal');
       if (existingModal) {
         existingModal.remove();
       }
       
       // Create new modal
       const newModal = document.createElement('div');
       newModal.id = 'meterReadsMenuModal';
       newModal.style.cssText = `
         position: fixed;
         top: 0;
         left: 0;
         width: 100vw;
         height: 100vh;
         background-color: rgba(0, 0, 0, 0.8);
         z-index: 99999;
         display: flex;
         align-items: center;
         justify-content: center;
         padding: 20px;
         box-sizing: border-box;
       `;
       
       // Create modal content
       const modalContent = document.createElement('div');
       modalContent.style.cssText = `
         background-color: #1f2937;
         border-radius: 12px;
         padding: 20px;
         max-width: 90%;
         max-height: 90vh;
         overflow-y: auto;
         color: white;
         width: 100%;
         box-sizing: border-box;
       `;
       
       // Add content
       modalContent.innerHTML = `
         <div style="display: flex; align-items: center; margin-bottom: 20px;">
           <div style="font-size: 24px; margin-right: 12px;">üìè</div>
           <div>
             <h3 style="margin: 0; color: #f3f4f6; font-size: 18px;">Meter Reads</h3>
             <p style="margin: 4px 0 0 0; color: #9ca3af; font-size: 14px;">Track meter readings at different locations</p>
           </div>
         </div>
         
         <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 20px;">
           <div id="openMeterReadsEntry" style="
             background: linear-gradient(135deg, #374151 0%, #4b5563 100%);
             border: 1px solid #4b5563;
             border-radius: 8px;
             padding: 16px;
             text-align: center;
             cursor: pointer;
             transition: all 0.2s ease;
           " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 8px rgba(0, 0, 0, 0.2)'" 
             onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'">
             <div style="font-size: 24px; margin-bottom: 8px;">üìù</div>
             <div style="color: #f3f4f6; font-weight: 500;">Add Meter Read</div>
           </div>
           <div id="openMeterReadsHistory" style="
             background: linear-gradient(135deg, #374151 0%, #4b5563 100%);
             border: 1px solid #4b5563;
             border-radius: 8px;
             padding: 16px;
             text-align: center;
             cursor: pointer;
             transition: all 0.2s ease;
           " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 8px rgba(0, 0, 0, 0.2)'" 
             onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'">
             <div style="font-size: 24px; margin-bottom: 8px;">üìä</div>
             <div style="color: #f3f4f6; font-weight: 500;">View History</div>
           </div>
         </div>
         
         <div style="text-align: center;">
           <button id="closeMeterReadsMenu" class="ghost">Close</button>
         </div>
       `;
       
       newModal.appendChild(modalContent);
       document.body.appendChild(newModal);
       
       // Add event listeners
       document.getElementById('openMeterReadsEntry').addEventListener('click', showMeterReadsModal);
       document.getElementById('openMeterReadsHistory').addEventListener('click', showMeterReadsHistoryModal);
       document.getElementById('closeMeterReadsMenu').addEventListener('click', hideMeterReadsMenu);
       
       console.log('New meter reads menu modal created and should be visible');
     }

     function hideMeterReadsMenu() {
       const meterReadsMenuModal = document.getElementById('meterReadsMenuModal');
       if (meterReadsMenuModal) {
         meterReadsMenuModal.remove();
       }
     }

     function showMeterReadsModal() {
       console.log('showMeterReadsModal called');
       
       // Create a completely new, simple modal that we know will work
       const existingModal = document.getElementById('meterReadsModal');
       if (existingModal) {
         existingModal.remove();
       }
       
       // Create new modal
       const newModal = document.createElement('div');
       newModal.id = 'meterReadsModal';
       newModal.style.cssText = `
         position: fixed;
         top: 0;
         left: 0;
         width: 100vw;
         height: 100vh;
         background-color: rgba(0, 0, 0, 0.8);
         z-index: 99999;
         display: flex;
         align-items: center;
         justify-content: center;
         padding: 20px;
         box-sizing: border-box;
       `;
       
       // Create modal content
       const modalContent = document.createElement('div');
       modalContent.style.cssText = `
         background-color: #1f2937;
         border-radius: 12px;
         padding: 20px;
         max-width: 90%;
         max-height: 90vh;
         overflow-y: auto;
         color: white;
         width: 100%;
         box-sizing: border-box;
       `;
       
       // Add content
       modalContent.innerHTML = `
         <div style="display: flex; align-items: center; margin-bottom: 20px;">
           <div style="font-size: 24px; margin-right: 12px;">üìù</div>
           <div>
             <h3 style="margin: 0; color: #f3f4f6; font-size: 18px;">Add Meter Read</h3>
             <p style="margin: 4px 0 0 0; color: #9ca3af; font-size: 14px;">Record a new meter reading</p>
           </div>
         </div>
         
         <div style="margin-bottom: 16px;">
           <label style="display: block; color: #d1d5db; font-size: 14px; margin-bottom: 4px;">Location</label>
           <select id="meterReadsLocation" style="
             width: 100%;
             padding: 10px 12px;
             background: #374151;
             border: 1px solid #4b5563;
             border-radius: 6px;
             color: #f9fafb;
             font-size: 14px;
             margin-bottom: 12px;
           ">
             <option value="">Select Location</option>
             <option value="custom">Custom Location</option>
           </select>
         </div>
         
         <div id="customMeterReadsLocationField" style="display: none; margin-bottom: 16px;">
           <label style="display: block; color: #d1d5db; font-size: 14px; margin-bottom: 4px;">Custom Location Name</label>
           <input id="customMeterReadsLocationName" type="text" placeholder="Enter location name" style="
             width: 100%;
             padding: 10px 12px;
             background: #374151;
             border: 1px solid #4b5563;
             border-radius: 6px;
             color: #f9fafb;
             font-size: 14px;
           " />
         </div>
         
         <div style="margin-bottom: 16px;">
           <label style="display: block; color: #d1d5db; font-size: 14px; margin-bottom: 4px;">Meter Read (ft)</label>
           <input id="meterReadsValue" type="number" step="0.01" placeholder="0.00" style="
             width: 100%;
             padding: 10px 12px;
             background: #374151;
             border: 1px solid #4b5563;
             border-radius: 6px;
             color: #f9fafb;
             font-size: 14px;
           " />
         </div>
         
         <div style="margin-bottom: 16px;">
           <label style="display: block; color: #d1d5db; font-size: 14px; margin-bottom: 4px;">Date</label>
           <input id="meterReadsDate" type="date" style="
             width: 100%;
             padding: 10px 12px;
             background: #374151;
             border: 1px solid #4b5563;
             border-radius: 6px;
             color: #f9fafb;
             font-size: 14px;
             box-sizing: border-box;
             -webkit-appearance: none;
             -moz-appearance: none;
             appearance: none;
           " />
         </div>
         
         <button id="manageMeterReadsLocations" class="ghost" style="
           width: 100%;
           margin-bottom: 16px;
           padding: 10px 12px;
           background: #374151;
           border: 1px solid #4b5563;
           border-radius: 6px;
           color: #f9fafb;
           font-size: 14px;
           cursor: pointer;
         ">üìç Add Locations</button>
         
         <div id="meterReadsResult" style="margin-bottom: 16px;"></div>
         
         <div style="display: flex; flex-direction: column; gap: 12px;">
           <button id="meterReadsCalc" class="primary" style="width: 100%;">Log Meter Read</button>
           <button id="closeMeterReads" class="ghost" style="width: 100%;">Close</button>
         </div>
       `;
       
       newModal.appendChild(modalContent);
       document.body.appendChild(newModal);
       
       // Set default values
       document.getElementById('meterReadsLocation').value = '';
       document.getElementById('customMeterReadsLocationName').value = '';
       document.getElementById('meterReadsValue').value = '';
       document.getElementById('meterReadsDate').value = todayStr();
       
       // Populate location dropdown with custom locations
       const locationDropdown = document.getElementById('meterReadsLocation');
       customMeterReadsLocations.forEach(location => {
         const option = document.createElement('option');
         option.value = location;
         option.textContent = location;
         option.setAttribute('data-custom', 'true');
         locationDropdown.appendChild(option);
       });
       
       previewMeterReads();
       
       // Add event listeners
       document.getElementById('closeMeterReads').addEventListener('click', hideMeterReadsModal);
       document.getElementById('manageMeterReadsLocations').addEventListener('click', showMeterReadsLocationsModal);
       document.getElementById('meterReadsCalc').addEventListener('click', function() {
         const { location, customLocation, value, date } = meterReadsInputs();
         if (!location || !value || !date) {
           document.getElementById('meterReadsResult').innerHTML = '<p style="color: #ef4444;">Please enter all values</p>';
           return;
         }
         if (location === 'custom' && !customLocation) {
           document.getElementById('meterReadsResult').innerHTML = '<p style="color: #ef4444;">Please enter custom location name</p>';
           return;
         }
         renderMeterReads(location, customLocation, value, date);
         // Close both the entry modal and the menu after logging
         hideMeterReadsModal();
         hideMeterReadsMenu();
       });
       
       // Input change listeners
       document.getElementById('meterReadsLocation').addEventListener('change', function() {
         const customField = document.getElementById('customMeterReadsLocationField');
         if (this.value === 'custom') {
           customField.style.display = 'block';
         } else {
           customField.style.display = 'none';
         }
         previewMeterReads();
       });
       document.getElementById('meterReadsValue').addEventListener('input', previewMeterReads);
       document.getElementById('meterReadsDate').addEventListener('change', previewMeterReads);
       document.getElementById('customMeterReadsLocationName').addEventListener('input', previewMeterReads);
       
       console.log('New meter reads entry modal created and should be visible');
     }

     function hideMeterReadsModal() {
       const meterReadsModal = document.getElementById('meterReadsModal');
       if (meterReadsModal) {
         meterReadsModal.remove();
       }
     }

     function showMeterReadsHistoryModal() {
       console.log('showMeterReadsHistoryModal called');
       
       // Create a completely new, simple modal that we know will work
       const existingModal = document.getElementById('meterReadsHistoryModal');
       if (existingModal) {
         existingModal.remove();
       }
       
       // Create new modal
       const newModal = document.createElement('div');
       newModal.id = 'meterReadsHistoryModal';
       newModal.style.cssText = `
         position: fixed;
         top: 0;
         left: 0;
         width: 100vw;
         height: 100vh;
         background-color: rgba(0, 0, 0, 0.8);
         z-index: 99999;
         display: flex;
         align-items: center;
         justify-content: center;
         padding: 20px;
         box-sizing: border-box;
       `;
       
       // Create modal content
       const modalContent = document.createElement('div');
       modalContent.style.cssText = `
         background-color: #1f2937;
         border-radius: 12px;
         padding: 20px;
         max-width: 90%;
         max-height: 90vh;
         overflow-y: auto;
         color: white;
         width: 100%;
         box-sizing: border-box;
       `;
       
       // Add content
       modalContent.innerHTML = `
         <div style="display: flex; align-items: center; margin-bottom: 20px;">
           <div style="font-size: 24px; margin-right: 12px;">üìä</div>
           <div>
             <h3 style="margin: 0; color: #f3f4f6; font-size: 18px;">Meter Reads History</h3>
             <p style="margin: 4px 0 0 0; color: #9ca3af; font-size: 14px;">View recorded meter reading data</p>
           </div>
         </div>
         
         <div style="margin-bottom: 20px;">
           <div style="margin-bottom: 12px;">
             <label style="display: block; color: #d1d5db; font-size: 14px; margin-bottom: 4px;">Filter by Location</label>
             <select id="meterReadsHistoryLocation" style="
               width: 100%;
               padding: 8px 12px;
               background: #374151;
               border: 1px solid #4b5563;
               border-radius: 6px;
               color: #f9fafb;
               font-size: 14px;
             ">
               <option value="">All Locations</option>
             </select>
           </div>
           <div>
             <label style="display: block; color: #d1d5db; font-size: 14px; margin-bottom: 4px;">Date Range</label>
             <select id="meterReadsHistoryDateRange" style="
               width: 100%;
               padding: 8px 12px;
               background: #374151;
               border: 1px solid #4b5563;
               border-radius: 6px;
               color: #f9fafb;
               font-size: 14px;
             ">
               <option value="7">Last 7 days</option>
               <option value="30" selected>Last 30 days</option>
               <option value="90">Last 90 days</option>
               <option value="365">Last year</option>
               <option value="all">All time</option>
             </select>
           </div>
         </div>
         
         <div id="meterReadsHistoryResult" style="margin-bottom: 20px;"></div>
         
         <div style="display: flex; flex-direction: column; gap: 12px;">
           <button id="exportMeterReadsHistoryBtn" style="
             background: linear-gradient(135deg, #10b981 0%, #059669 100%);
             border: none;
             color: white;
             padding: 12px 24px;
             border-radius: 8px;
             font-weight: 600;
             cursor: pointer;
             transition: all 0.2s ease;
           " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 8px rgba(16, 185, 129, 0.3)'" 
             onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'">üìä Export to Excel</button>
           <button id="closeMeterReadsHistory" class="ghost" style="width: 100%;">Close</button>
         </div>
       `;
       
       newModal.appendChild(modalContent);
       document.body.appendChild(newModal);
       
       // Populate location dropdown with custom locations
       const locationDropdown = document.getElementById('meterReadsHistoryLocation');
       customMeterReadsLocations.forEach(location => {
         const option = document.createElement('option');
         option.value = location;
         option.textContent = location;
         option.setAttribute('data-custom', 'true');
         locationDropdown.appendChild(option);
       });
       
       // Add event listeners
       document.getElementById('closeMeterReadsHistory').addEventListener('click', hideMeterReadsHistoryModal);
       document.getElementById('exportMeterReadsHistoryBtn').addEventListener('click', exportMeterReadsDataToExcel);
       document.getElementById('meterReadsHistoryLocation').addEventListener('change', loadMeterReadsHistory);
       document.getElementById('meterReadsHistoryDateRange').addEventListener('change', loadMeterReadsHistory);
       
       // Load meter reads history data
       loadMeterReadsHistory();
       
       console.log('New meter reads history modal created and should be visible');
     }

     function hideMeterReadsHistoryModal() {
       const meterReadsHistoryModal = document.getElementById('meterReadsHistoryModal');
       if (meterReadsHistoryModal) {
         meterReadsHistoryModal.remove();
       }
     }

     function meterReadsInputs() {
       const location = document.getElementById('meterReadsLocation').value;
       const customLocation = document.getElementById('customMeterReadsLocationName').value;
       const value = document.getElementById('meterReadsValue').value;
       const date = document.getElementById('meterReadsDate').value;
       return { location, customLocation, value, date };
     }

     function previewMeterReads() {
       const { location, customLocation, value, date } = meterReadsInputs();
       
       if (location && value > 0 && date) {
         const locationName = location === 'custom' ? customLocation : location;
         document.getElementById('meterReadsResult').innerHTML = `<div class='math'>Preview: ${locationName} - ${value} ft on ${date}</div>`;
       } else {
         document.getElementById('meterReadsResult').innerHTML = '';
       }
     }

     function renderMeterReads(location, customLocation, value, date) {
       const locationName = location === 'custom' ? customLocation : location;
       document.getElementById('meterReadsResult').innerHTML = `<div class='math'>Logged: ${locationName} - ${value} ft on ${date}</div>`;
       
       // If it's a custom location, add it to the custom locations list
       if (location === 'custom' && customLocation && !customMeterReadsLocations.includes(customLocation)) {
         customMeterReadsLocations.push(customLocation);
         updateMeterReadsLocationDropdowns();
       }
       
       // Save meter reads data to Firebase
       if (!meterReadsDataByDate[date]) {
         meterReadsDataByDate[date] = {};
       }
       
       // Store meter reads data by location (use locationName as key to avoid duplicates)
       meterReadsDataByDate[date][locationName] = {
         value: value,
         locationName: locationName,
         timestamp: new Date().toISOString()
       };
       
       saveUserData();
       
       // Update meter reads chart
       loadMeterReadsChart();
       
       // Update overall meter reads chart
       updateMeterReadsCharts();
       
       // Update streaks
       calculateStreaks();
       updateStreakDisplay();
     }

     function loadMeterReadsChart() {
       updateMeterReadsCharts();
     }

     function updateMeterReadsCharts() {
       const dates = Object.keys(meterReadsDataByDate).sort();
       
       // First check if there's any data at all
       if (dates.length === 0) {
         // Show "no data" message for desktop chart
         if (typeof meterReadsChart !== 'undefined') {
           meterReadsChart.data.labels = ['No data to display yet'];
           meterReadsChart.data.datasets = [{
             label: 'No Data',
             data: [0],
             borderColor: 'transparent',
             backgroundColor: 'transparent',
             pointRadius: 0,
             pointHoverRadius: 0
           }];
           meterReadsChart.update();
         }
         
         // Show "no data" message for mobile chart
         if (typeof mobileMeterReadsChart !== 'undefined') {
           mobileMeterReadsChart.data.labels = ['No data to display yet'];
           mobileMeterReadsChart.data.datasets = [{
             label: 'No Data',
             data: [0],
             borderColor: 'transparent',
             backgroundColor: 'transparent',
             pointRadius: 0,
             pointHoverRadius: 0
           }];
           mobileMeterReadsChart.update();
         }
         return;
       }
       
       const twoMonthsAgo = new Date();
       twoMonthsAgo.setMonth(twoMonthsAgo.getMonth() - 2);
       const twoMonthsAgoStr = twoMonthsAgo.toISOString().split('T')[0];
       
       const filteredDates = dates.filter(date => date >= twoMonthsAgoStr);
       const filteredLabels = filteredDates.map(date => {
         const d = new Date(date + 'T00:00:00'); // Add time to avoid timezone issues
         return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
       });
       
       // Group data by location
       const locationData = {};
       filteredDates.forEach(date => {
         const dayData = meterReadsDataByDate[date];
         Object.keys(dayData).forEach(locationName => {
           if (dayData[locationName] && dayData[locationName].value) {
             if (!locationData[locationName]) {
               locationData[locationName] = {
                 label: dayData[locationName].locationName,
                 data: [],
                 borderColor: getLocationColor(Object.keys(locationData).length),
                 backgroundColor: getLocationColor(Object.keys(locationData).length, 0.1),
                 tension: 0.25,
                 pointRadius: 6,
                 pointHoverRadius: 9
               };
             }
             locationData[locationName].data.push(dayData[locationName].value);
           }
         });
       });
       
       const datasets = Object.values(locationData);
       
       // Check if there's no data
       if (datasets.length === 0) {
         // Show "no data" message for desktop chart
         if (typeof meterReadsChart !== 'undefined') {
           meterReadsChart.data.labels = ['No data to display yet'];
           meterReadsChart.data.datasets = [{
             label: 'No Data',
             data: [0],
             borderColor: 'transparent',
             backgroundColor: 'transparent',
             pointRadius: 0,
             pointHoverRadius: 0
           }];
           meterReadsChart.update();
         }
         
         // Show "no data" message for mobile chart
         if (typeof mobileMeterReadsChart !== 'undefined') {
           mobileMeterReadsChart.data.labels = ['No data to display yet'];
           mobileMeterReadsChart.data.datasets = [{
             label: 'No Data',
             data: [0],
             borderColor: 'transparent',
             backgroundColor: 'transparent',
             pointRadius: 0,
             pointHoverRadius: 0
           }];
           mobileMeterReadsChart.update();
         }
       } else {
         // Update desktop chart with data
         if (typeof meterReadsChart !== 'undefined') {
           meterReadsChart.data.labels = filteredLabels;
           meterReadsChart.data.datasets = datasets;
           meterReadsChart.update();
         }
         
         // Update mobile chart with data
         if (typeof mobileMeterReadsChart !== 'undefined') {
           mobileMeterReadsChart.data.labels = filteredLabels;
           mobileMeterReadsChart.data.datasets = datasets;
           mobileMeterReadsChart.update();
         }
       }
     }

     function updateMeterReadsChartsFullYear() {
       const dates = Object.keys(meterReadsDataByDate).sort();
       const filteredLabels = dates.map(date => {
         const d = new Date(date + 'T00:00:00'); // Add time to avoid timezone issues
         return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
       });
       
       // Group data by location
       const locationData = {};
       dates.forEach(date => {
         const dayData = meterReadsDataByDate[date];
         Object.keys(dayData).forEach(locationName => {
           if (dayData[locationName] && dayData[locationName].value) {
             if (!locationData[locationName]) {
               locationData[locationName] = {
                 label: dayData[locationName].locationName,
                 data: [],
                 borderColor: getLocationColor(Object.keys(locationData).length),
                 backgroundColor: getLocationColor(Object.keys(locationData).length, 0.1),
                 tension: 0.25,
                 pointRadius: 6,
                 pointHoverRadius: 9
               };
             }
             locationData[locationName].data.push(dayData[locationName].value);
           }
         });
       });
       
       const datasets = Object.values(locationData);
       
       // Check if there's no data
       if (datasets.length === 0) {
         // Show "no data" message for desktop chart
         if (typeof meterReadsChart !== 'undefined') {
           meterReadsChart.data.labels = ['No data to display yet'];
           meterReadsChart.data.datasets = [{
             label: 'No Data',
             data: [0],
             borderColor: 'transparent',
             backgroundColor: 'transparent',
             pointRadius: 0,
             pointHoverRadius: 0
           }];
           meterReadsChart.update();
         }
         
         // Show "no data" message for mobile chart
         if (typeof mobileMeterReadsChart !== 'undefined') {
           mobileMeterReadsChart.data.labels = ['No data to display yet'];
           mobileMeterReadsChart.data.datasets = [{
             label: 'No Data',
             data: [0],
             borderColor: 'transparent',
             backgroundColor: 'transparent',
             pointRadius: 0,
             pointHoverRadius: 0
           }];
           mobileMeterReadsChart.update();
         }
       } else {
         // Update desktop chart with data
         if (typeof meterReadsChart !== 'undefined') {
           meterReadsChart.data.labels = filteredLabels;
           meterReadsChart.data.datasets = datasets;
           meterReadsChart.update();
         }
         
         // Update mobile chart with data
         if (typeof mobileMeterReadsChart !== 'undefined') {
           mobileMeterReadsChart.data.labels = filteredLabels;
           mobileMeterReadsChart.data.datasets = datasets;
           mobileMeterReadsChart.update();
         }
       }
     }

     function loadMeterReadsHistory() {
       const resultDiv = document.getElementById('meterReadsHistoryResult');
       const locationFilter = document.getElementById('meterReadsHistoryLocation').value;
       const dateRangeFilter = document.getElementById('meterReadsHistoryDateRange').value;
       
       let dates = Object.keys(meterReadsDataByDate).sort();
       
       // Apply date range filter
       if (dateRangeFilter !== 'all') {
         const days = parseInt(dateRangeFilter);
         const cutoffDate = new Date();
         cutoffDate.setDate(cutoffDate.getDate() - days);
         const cutoffDateStr = cutoffDate.toISOString().split('T')[0];
         dates = dates.filter(date => date >= cutoffDateStr);
       }
       
       // Apply location filter
       let filteredData = [];
       dates.forEach(date => {
         const dayData = meterReadsDataByDate[date];
         Object.keys(dayData).forEach(locationName => {
           if (dayData[locationName] && dayData[locationName].value) {
             // Check location filter
             if (!locationFilter || locationName === locationFilter) {
               filteredData.push({
                 date,
                 location: locationName,
                 data: dayData[locationName]
               });
             }
           }
         });
       });
       
       if (filteredData.length === 0) {
         const noDataMessage = locationFilter || dateRangeFilter !== 'all' 
           ? 'No data found for the selected filters'
           : 'No meter reads data recorded yet';
         resultDiv.innerHTML = `
           <div style="text-align: center; padding: 40px 20px; color: #9ca3af;">
             <div style="font-size: 48px; margin-bottom: 16px;">üìè</div>
             <h3 style="color: #f9fafb; margin-bottom: 8px; font-size: 18px;">${noDataMessage}</h3>
             <p style="color: #9ca3af; font-size: 14px;">${locationFilter || dateRangeFilter !== 'all' ? 'Try adjusting your filters' : 'Start logging meter reads to see your history here'}</p>
           </div>
         `;
         return;
       }
       
       let historyHTML = `
         <div style="margin-bottom: 20px;">
           <h4 style="margin: 0 0 16px 0; color: #f3f4f6; font-size: 18px; font-weight: 600;">Recent Meter Reads Entries</h4>
           <div style="display: flex; flex-direction: column; gap: 12px;">
       `;
       
       // Show entries in reverse chronological order (most recent first)
       filteredData.reverse().forEach(entry => {
         const formattedDate = new Date(entry.date).toLocaleDateString('en-US', { 
           month: 'short', 
           day: 'numeric', 
           year: 'numeric' 
         });
         
         historyHTML += `
           <div style="
             background: linear-gradient(135deg, #1f2937 0%, #374151 100%);
             border: 1px solid #4b5563;
             border-radius: 12px;
             padding: 16px;
             display: flex;
             justify-content: space-between;
             align-items: center;
             transition: all 0.2s ease;
             box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
           " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 8px rgba(0, 0, 0, 0.2)'" 
             onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 4px rgba(0, 0, 0, 0.1)'">
             <div style="display: flex; flex-direction: column; gap: 4px;">
               <div style="font-weight: 600; color: #f3f4f6; font-size: 16px;">${entry.data.locationName}</div>
               <div style="color: #9ca3af; font-size: 14px;">${formattedDate}</div>
             </div>
             <div style="display: flex; align-items: center; gap: 12px;">
               <div style="
                 background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
                 color: white;
                 padding: 8px 16px;
                 border-radius: 20px;
                 font-weight: 600;
                 font-size: 14px;
                 min-width: 80px;
                 text-align: center;
               ">${entry.data.value} ft</div>
               <button onclick="deleteMeterReadsEntry('${entry.date}', '${entry.data.locationName}')" style="
                 background: #dc2626;
                 color: white;
                 border: none;
                 border-radius: 6px;
                 padding: 8px 12px;
                 font-size: 12px;
                 cursor: pointer;
                 transition: all 0.2s ease;
               " onmouseover="this.style.background='#b91c1c'" onmouseout="this.style.background='#dc2626'">
                 üóëÔ∏è Delete
               </button>
             </div>
           </div>
         `;
       });
       
       historyHTML += `
           </div>
         </div>
       `;
       
       resultDiv.innerHTML = historyHTML;
     }

     function deleteMeterReadsEntry(date, locationName) {
       if (confirm('Are you sure you want to delete this meter reading entry?')) {
         // Remove the entry from the data
         if (meterReadsDataByDate[date] && meterReadsDataByDate[date][locationName]) {
           delete meterReadsDataByDate[date][locationName];
           
           // If no more entries for this date, remove the date entirely
           if (Object.keys(meterReadsDataByDate[date]).length === 0) {
             delete meterReadsDataByDate[date];
           }
           
           // Save to Firebase
           saveUserData();
           
           // Reload the history to reflect changes
           loadMeterReadsHistory();
           
           // Update charts
           updateMeterReadsCharts();
         }
       }
     }

     function showEmailModal() {
       console.log('showEmailModal called');
       
       // Create a completely new, simple modal that we know will work
       const existingModal = document.getElementById('emailModal');
       if (existingModal) {
         existingModal.remove();
       }
       
       // Create new modal
       const newModal = document.createElement('div');
       newModal.id = 'emailModal';
       newModal.style.cssText = `
         position: fixed;
         top: 0;
         left: 0;
         width: 100vw;
         height: 100vh;
         background-color: rgba(0, 0, 0, 0.8);
         z-index: 99999;
         display: flex;
         align-items: center;
         justify-content: center;
         padding: 20px;
         box-sizing: border-box;
       `;
       
       // Create modal content
       const modalContent = document.createElement('div');
       modalContent.style.cssText = `
         background-color: #1f2937;
         border-radius: 12px;
         padding: 20px;
         max-width: 90%;
         max-height: 90vh;
         overflow-y: auto;
         color: white;
         width: 100%;
         box-sizing: border-box;
       `;
       
       // Add content
       modalContent.innerHTML = `
         <div style="display: flex; align-items: center; margin-bottom: 20px;">
           <div style="font-size: 24px; margin-right: 12px;">üìß</div>
           <div>
             <h3 style="margin: 0; color: #f3f4f6; font-size: 18px;">Send Data via Email</h3>
             <p style="margin: 4px 0 0 0; color: #9ca3af; font-size: 14px;">Enter email address to receive your meter reads data</p>
           </div>
         </div>
         
         <div style="margin-bottom: 20px;">
           <label style="display: block; color: #d1d5db; font-size: 14px; margin-bottom: 8px;">Email Address</label>
           <input id="emailAddress" type="email" placeholder="Enter email address" style="
             width: 100%;
             padding: 12px;
             background: #374151;
             border: 1px solid #4b5563;
             border-radius: 6px;
             color: #f9fafb;
             font-size: 14px;
             box-sizing: border-box;
           " />
         </div>
         
         <div id="emailResult" style="margin-bottom: 16px;"></div>
         
         <div style="display: flex; flex-direction: column; gap: 12px;">
           <button id="sendEmailBtn" class="primary" style="width: 100%;">üìß Send Data</button>
           <button id="closeEmailModal" class="ghost" style="width: 100%;">Close</button>
         </div>
       `;
       
       newModal.appendChild(modalContent);
       document.body.appendChild(newModal);
       
       // Add event listeners
       document.getElementById('closeEmailModal').addEventListener('click', hideEmailModal);
       document.getElementById('sendEmailBtn').addEventListener('click', sendMeterReadsDataViaEmail);
       
       console.log('New email modal created and should be visible');
     }

     function hideEmailModal() {
       const emailModal = document.getElementById('emailModal');
       if (emailModal) {
         emailModal.remove();
       }
     }

     function sendMeterReadsDataViaEmail() {
       const emailAddress = document.getElementById('emailAddress').value.trim();
       const resultDiv = document.getElementById('emailResult');
       
       if (!emailAddress) {
         resultDiv.innerHTML = '<p style="color: #ef4444; margin: 0;">Please enter an email address</p>';
         return;
       }
       
       if (!emailAddress.includes('@')) {
         resultDiv.innerHTML = '<p style="color: #ef4444; margin: 0;">Please enter a valid email address</p>';
         return;
       }
       
       // Show loading state
       resultDiv.innerHTML = '<p style="color: #3b82f6; margin: 0;">Sending email...</p>';
       document.getElementById('sendEmailBtn').disabled = true;
       document.getElementById('sendEmailBtn').textContent = 'Sending...';
       
       // Prepare data
       const dates = Object.keys(meterReadsDataByDate).sort();
       const allData = [];
       
       // Add header row
       allData.push(['Date', 'Location', 'Meter Read (ft)', 'Timestamp']);
       
       // Add data rows
       dates.forEach(date => {
         const dayData = meterReadsDataByDate[date];
         Object.keys(dayData).forEach(locationName => {
           if (dayData[locationName] && dayData[locationName].value) {
             allData.push([
               date,
               dayData[locationName].locationName,
               dayData[locationName].value,
               dayData[locationName].timestamp || ''
             ]);
           }
         });
       });
       
       // Convert to CSV format
       const csvContent = allData.map(row => 
         row.map(cell => `"${cell}"`).join(',')
       ).join('\n');
       
       // Create HTML table for email body - using more email-friendly HTML
       let tableHTML = `
         <table border="1" cellpadding="8" cellspacing="0" style="border-collapse: collapse; width: 100%; font-family: Arial, sans-serif; margin: 20px 0;">
           <tr style="background-color: #f2f2f2;">
             <th style="border: 1px solid #ddd; padding: 8px; text-align: left;">Date</th>
             <th style="border: 1px solid #ddd; padding: 8px; text-align: left;">Location</th>
             <th style="border: 1px solid #ddd; padding: 8px; text-align: left;">Meter Read (ft)</th>
             <th style="border: 1px solid #ddd; padding: 8px; text-align: left;">Timestamp</th>
           </tr>
       `;
       
       // Add data rows
       dates.forEach(date => {
         const dayData = meterReadsDataByDate[date];
         Object.keys(dayData).forEach(locationName => {
           if (dayData[locationName] && dayData[locationName].value) {
             const timestamp = dayData[locationName].timestamp ? 
               new Date(dayData[locationName].timestamp).toLocaleString() : '';
             tableHTML += `
               <tr>
                 <td style="border: 1px solid #ddd; padding: 8px;">${date}</td>
                 <td style="border: 1px solid #ddd; padding: 8px;">${dayData[locationName].locationName}</td>
                 <td style="border: 1px solid #ddd; padding: 8px;">${dayData[locationName].value}</td>
                 <td style="border: 1px solid #ddd; padding: 8px;">${timestamp}</td>
               </tr>
             `;
           }
         });
       });
       
       tableHTML += `
         </table>
       `;
       
       // Create a simple text table as backup
       let textTable = `
Date         | Location | Meter Read (ft) | Timestamp
-------------|----------|-----------------|------------------
       `;
       
       dates.forEach(date => {
         const dayData = meterReadsDataByDate[date];
         Object.keys(dayData).forEach(locationName => {
           if (dayData[locationName] && dayData[locationName].value) {
             const timestamp = dayData[locationName].timestamp ? 
               new Date(dayData[locationName].timestamp).toLocaleString() : '';
             textTable += `${date.padEnd(12)} | ${locationName.padEnd(8)} | ${dayData[locationName].value.toString().padEnd(15)} | ${timestamp}\n`;
           }
         });
       });
       
       // Send email using EmailJS
       const templateParams = {
         user_email: emailAddress,
         to_email: emailAddress,
         email: emailAddress,
         from_name: 'WaterData App',
         subject: `Meter Reads Data - ${todayStr()}`,
         message: `Please find your meter reads data below, exported on ${new Date().toLocaleDateString()}.`,
         table_data: tableHTML,
         text_table: textTable,
         csv_content: csvContent,
         export_date: new Date().toLocaleDateString()
       };
       
       console.log('Sending email with params:', templateParams);
       console.log('Email address being sent:', emailAddress);
       console.log('Table HTML being sent:', tableHTML);
       
       emailjs.send('service_tr7srcd', 'template_6er1sgu', templateParams)
         .then(function(response) {
           console.log('Email sent successfully:', response);
           resultDiv.innerHTML = '<p style="color: #10b981; margin: 0;">‚úÖ Email sent successfully!</p>';
           document.getElementById('sendEmailBtn').textContent = 'Email Sent!';
           
           // Close modal after 2 seconds
           setTimeout(() => {
             hideEmailModal();
           }, 2000);
         })
         .catch(function(error) {
           console.error('Email sending failed:', error);
           resultDiv.innerHTML = '<p style="color: #ef4444; margin: 0;">‚ùå Failed to send email. Please try again.</p>';
           document.getElementById('sendEmailBtn').disabled = false;
           document.getElementById('sendEmailBtn').textContent = 'üìß Send Data';
         });
     }

     function exportMeterReadsDataToExcel() {
       // Download the file immediately
       downloadMeterReadsCSV();
       
       // Also show email modal
       showEmailModal();
     }

     function downloadMeterReadsCSV() {
       const dates = Object.keys(meterReadsDataByDate).sort();
       const allData = [];
       
       // Add header row
       allData.push(['Date', 'Location', 'Meter Read (ft)', 'Timestamp']);
       
       // Add data rows
       dates.forEach(date => {
         const dayData = meterReadsDataByDate[date];
         Object.keys(dayData).forEach(locationName => {
           if (dayData[locationName] && dayData[locationName].value) {
             allData.push([
               date,
               dayData[locationName].locationName,
               dayData[locationName].value,
               dayData[locationName].timestamp || ''
             ]);
           }
         });
       });
       
       // Convert to CSV format
       const csvContent = allData.map(row => 
         row.map(cell => `"${cell}"`).join(',')
       ).join('\n');
       
       // Create and download file
       const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
       const link = document.createElement('a');
       const url = URL.createObjectURL(blob);
       link.setAttribute('href', url);
       link.setAttribute('download', `meter_reads_data_${todayStr()}.csv`);
       link.style.visibility = 'hidden';
       document.body.appendChild(link);
       link.click();
       document.body.removeChild(link);
     }

     // ===== Meter Reads Locations Management =====
     function showMeterReadsLocationsModal() {
       console.log('showMeterReadsLocationsModal called');
       
       // Create a completely new, simple modal that we know will work
       const existingModal = document.getElementById('meterReadsLocationsModal');
       if (existingModal) {
         existingModal.remove();
       }
       
       // Create new modal
       const newModal = document.createElement('div');
       newModal.id = 'meterReadsLocationsModal';
       newModal.style.cssText = `
         position: fixed;
         top: 0;
         left: 0;
         width: 100vw;
         height: 100vh;
         background-color: rgba(0, 0, 0, 0.8);
         z-index: 99999;
         display: flex;
         align-items: center;
         justify-content: center;
         padding: 20px;
         box-sizing: border-box;
       `;
       
       // Create modal content
       const modalContent = document.createElement('div');
       modalContent.style.cssText = `
         background-color: #1f2937;
         border-radius: 12px;
         padding: 20px;
         max-width: 90%;
         max-height: 90vh;
         overflow-y: auto;
         color: white;
         width: 100%;
         box-sizing: border-box;
       `;
       
       // Add content
       modalContent.innerHTML = `
         <h3 style="margin: 0 0 16px 0; color: #f3f4f6; font-size: 18px;">Manage Meter Reads Locations</h3>
         <p style="margin: 0 0 20px 0; color: #9ca3af; font-size: 14px;">Add or remove custom locations for meter reading tracking</p>
         
         <div style="margin-bottom: 24px;">
           <h4 style="color: #f3f4f6; margin-bottom: 12px; font-size: 16px;">Add New Location</h4>
           <input id="newMeterReadsLocationName" type="text" placeholder="Enter location name (e.g., Building A)" style="
             width: 100%;
             padding: 10px 12px;
             background: #374151;
             border: 1px solid #4b5563;
             border-radius: 6px;
             color: #f9fafb;
             font-size: 14px;
             margin-bottom: 12px;
             box-sizing: border-box;
           " />
           <button id="addMeterReadsLocationBtn" class="primary" style="width: 100%;">‚ûï Add Location</button>
         </div>
         
         <div>
           <h4 style="color: #f3f4f6; margin-bottom: 12px; font-size: 16px;">Your Locations</h4>
           <div id="meterReadsLocationsList" style="max-height: 200px; overflow-y: auto;">
             <div style="text-align: center; padding: 20px; color: #9ca3af;">
               <div style="font-size: 32px; margin-bottom: 8px;">üìç</div>
               <p style="margin: 0 0 8px 0; font-size: 14px;">No custom locations added yet</p>
               <p style="margin: 0; font-size: 12px; opacity: 0.7;">Add locations above or log meter data with custom locations to get started</p>
             </div>
           </div>
         </div>
         
         <div style="margin-top: 20px; text-align: center;">
           <button id="closeMeterReadsLocationsModal" class="ghost">Close</button>
         </div>
       `;
       
       newModal.appendChild(modalContent);
       document.body.appendChild(newModal);
       
       // Add event listeners
       document.getElementById('addMeterReadsLocationBtn').addEventListener('click', addMeterReadsLocation);
       document.getElementById('closeMeterReadsLocationsModal').addEventListener('click', hideMeterReadsLocationsModal);
       document.getElementById('newMeterReadsLocationName').addEventListener('keypress', function(e) {
         if (e.key === 'Enter') {
           addMeterReadsLocation();
         }
       });
       
       // Load locations
       loadMeterReadsLocationsList();
       
       console.log('New meter reads locations modal created and should be visible');
     }

     function hideMeterReadsLocationsModal() {
       const meterReadsLocationsModal = document.getElementById('meterReadsLocationsModal');
       if (meterReadsLocationsModal) {
         meterReadsLocationsModal.remove();
       }
     }

     function loadMeterReadsLocationsList() {
       const locationsList = document.getElementById('meterReadsLocationsList');
       
       if (customMeterReadsLocations.length === 0) {
         locationsList.innerHTML = `
           <div style="text-align: center; padding: 20px; color: #9ca3af;">
             <div style="font-size: 32px; margin-bottom: 8px;">üìç</div>
             <p style="margin: 0; font-size: 14px;">No custom locations added yet</p>
           </div>
         `;
         return;
       }

       let locationsHTML = '';
       customMeterReadsLocations.forEach((location, index) => {
         locationsHTML += `
           <div style="
             background: linear-gradient(135deg, #374151 0%, #4b5563 100%);
             border: 1px solid #4b5563;
             border-radius: 8px;
             padding: 12px 16px;
             margin-bottom: 8px;
             display: flex;
             justify-content: space-between;
             align-items: center;
             transition: all 0.2s ease;
           " onmouseover="this.style.transform='translateY(-1px)'; this.style.boxShadow='0 2px 4px rgba(0, 0, 0, 0.2)'" 
             onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'">
             <span style="color: #f3f4f6; font-weight: 500;">${location}</span>
             <div style="display: flex; gap: 8px;">
               <button onclick="editMeterReadsLocation(${index})" style="
                 background: #3b82f6;
                 color: white;
                 border: none;
                 border-radius: 4px;
                 padding: 4px 8px;
                 font-size: 12px;
                 cursor: pointer;
                 transition: all 0.2s ease;
               " onmouseover="this.style.background='#2563eb'" onmouseout="this.style.background='#3b82f6'">
                 ‚úèÔ∏è Edit
               </button>
               <button onclick="removeMeterReadsLocation(${index})" style="
                 background: #dc2626;
                 color: white;
                 border: none;
                 border-radius: 4px;
                 padding: 4px 8px;
                 font-size: 12px;
                 cursor: pointer;
                 transition: all 0.2s ease;
               " onmouseover="this.style.background='#b91c1c'" onmouseout="this.style.background='#dc2626'">
                 üóëÔ∏è Delete
               </button>
             </div>
           </div>
         `;
       });
       
       locationsList.innerHTML = locationsHTML;
     }

     function addMeterReadsLocation() {
       const newLocationName = document.getElementById('newMeterReadsLocationName').value.trim();
       
       if (!newLocationName) {
         alert('Please enter a location name');
         return;
       }
       
       if (customMeterReadsLocations.includes(newLocationName)) {
         alert('This location already exists');
         return;
       }
       
       customMeterReadsLocations.push(newLocationName);
       document.getElementById('newMeterReadsLocationName').value = '';
       loadMeterReadsLocationsList();
       updateMeterReadsLocationDropdowns();
       saveUserData();
     }

     function editMeterReadsLocation(index) {
       const newName = prompt('Enter new location name:', customMeterReadsLocations[index]);
       if (newName && newName.trim() && newName.trim() !== customMeterReadsLocations[index]) {
         if (customMeterReadsLocations.includes(newName.trim())) {
           alert('This location already exists');
           return;
         }
         customMeterReadsLocations[index] = newName.trim();
         loadMeterReadsLocationsList();
         updateMeterReadsLocationDropdowns();
         saveUserData();
       }
     }

     function removeMeterReadsLocation(index) {
       if (confirm('Are you sure you want to delete this location?')) {
         customMeterReadsLocations.splice(index, 1);
         loadMeterReadsLocationsList();
         updateMeterReadsLocationDropdowns();
         saveUserData();
       }
     }

     function updateMeterReadsLocationDropdowns() {
       // Update desktop meter reads location dropdown
       const meterReadsLocation = document.getElementById('meterReadsLocation');
       const meterReadsHistoryLocation = document.getElementById('meterReadsHistoryLocation');
       
       // Only update dropdowns that exist (meterReadsLocation is created dynamically)
       const dropdowns = [meterReadsHistoryLocation].filter(dropdown => dropdown !== null);
       
       // Clear all options except the first one (which should be empty)
       dropdowns.forEach(dropdown => {
         // Keep only the first option (empty/default)
         while (dropdown.children.length > 1) {
           dropdown.removeChild(dropdown.lastChild);
         }
       });
       
       // Add custom locations first
       customMeterReadsLocations.forEach(location => {
         const option = document.createElement('option');
         option.value = location;
         option.textContent = location;
         option.setAttribute('data-custom', 'true');
         
         dropdowns.forEach(dropdown => {
           dropdown.appendChild(option.cloneNode(true));
         });
       });
       
       // Add "Add Custom Location" option at the end (only to history dropdown since entry dropdown is dynamic)
       if (meterReadsHistoryLocation) {
         const customOption = document.createElement('option');
         customOption.value = 'custom';
         customOption.textContent = '+ Add Custom Location';
         customOption.setAttribute('data-custom', 'true');
         meterReadsHistoryLocation.appendChild(customOption);
       }
     }

     function showMobileFoodMenu() {
       const mobileFoodModal = document.getElementById('mobileFoodModal');
       mobileFoodModal.classList.remove('hidden');
       mobileFoodModal.style.zIndex = '2000';
     }

     function hideMobileFoodMenu() {
       const mobileFoodModal = document.getElementById('mobileFoodModal');
       mobileFoodModal.classList.add('hidden');
     }



     function showMobileCustomFoodModal(existingFood = null) {
       const mobileCustomFoodModal = document.getElementById('mobileCustomFoodModal');
       mobileCustomFoodModal.classList.remove('hidden');
       mobileCustomFoodModal.style.zIndex = '2000';
       
       if (existingFood) {
         // Editing existing food
         document.getElementById('mobileCustomFoodName').value = existingFood.name;
         document.getElementById('mobileCustomFoodCalories').value = existingFood.calories;
         document.getElementById('customFoodIcon').textContent = existingFood.icon;
         document.getElementById('mobileCustomFoodCalc').textContent = 'Add Food Calories';
         
         // Store the original food name for updating
         mobileCustomFoodModal.dataset.originalName = existingFood.name;
       } else {
         // Adding new food
         document.getElementById('mobileCustomFoodName').value = '';
         document.getElementById('mobileCustomFoodCalories').value = '';
         document.getElementById('customFoodIcon').textContent = 'üçΩÔ∏è';
         document.getElementById('mobileCustomFoodCalc').textContent = 'Add Food';
         delete mobileCustomFoodModal.dataset.originalName;
       }
       document.getElementById('mobileCustomFoodResult').innerHTML = '';
     }

     function hideMobileCustomFoodModal() {
       const mobileCustomFoodModal = document.getElementById('mobileCustomFoodModal');
       mobileCustomFoodModal.classList.add('hidden');
     }

     function updateCustomFoodIcon() {
       const foodName = document.getElementById('mobileCustomFoodName').value;
       const icon = pickEmoji(foodName);
       document.getElementById('customFoodIcon').textContent = icon;
     }

     function updateFoodMenu() {
       const foodMenu = document.getElementById('mobileFoodModal');
       const menuGrid = foodMenu.querySelector('.menu-grid');
       
       // Check if user has any custom foods
       const customFoodsArray = Object.values(customFoods);
       
       if (customFoodsArray.length === 0) {
         // Show empty state message
         menuGrid.innerHTML = `
           <div style="grid-column: 1 / -1; text-align: center; padding: 40px 20px; color: var(--muted);">
             <div style="font-size: 48px; margin-bottom: 16px;">üçΩÔ∏è</div>
             <div style="font-size: 16px; margin-bottom: 8px;">You have no recorded food items</div>
             <div style="font-size: 14px;">Add some below!</div>
           </div>
         `;
       } else {
         // Show custom foods
         let menuHTML = '';
         customFoodsArray.forEach(food => {
           menuHTML += `
             <div class="menu-tile" id="mobileOpenCustom_${food.name.replace(/\s+/g, '_')}">
               <div class="menu-emoji">${food.icon}</div>
               <div>${food.name}</div>
             </div>
           `;
         });
         
         menuGrid.innerHTML = menuHTML;
         
         // Re-attach event listeners for custom foods
         customFoodsArray.forEach(food => {
           const elementId = `mobileOpenCustom_${food.name.replace(/\s+/g, '_')}`;
           const element = document.getElementById(elementId);
           if (element) {
             element.addEventListener('click', () => {
               hideMobileFoodMenu();
               showMobileCustomFoodModal(food);
             });
           }
         });
       }
     }



    // Old previewMobileTreadmill function removed - replaced with water level functionality

     function addWeightForDate(weight, date) {
       weightByDate[date] = weight;
       console.log('Weight added for date:', date, 'weight:', weight);
       console.log('Current weightByDate:', weightByDate);
       updateCharts();
       saveUserData();
     }
    // Old calorie calculation functions removed - no longer needed for water level tracking

         // ===== State =====
     // State variables moved to top of script for proper scope
     
     // ===== Streak Tracking =====
    let streakData = {
      currentStreak: 0,
      bestStreak: 0,
        totalWaterLevels: 0,
      averageStreak: 0,
      lastWaterLevelDate: null,
      waterLevelDates: new Set(),
      completedStreaks: [] // Array to store individual streak lengths
    };

         // ===== Theme Management =====
     function applyTheme(theme) {
       const root = document.documentElement;
       if (theme === 'light') {
         root.style.setProperty('--bg', '#ffffff');
         root.style.setProperty('--card', '#f8f9fa');
         root.style.setProperty('--muted', '#6c757d');
         root.style.setProperty('--text', '#212529');
       } else {
         root.style.setProperty('--bg', '#0b0f14');
         root.style.setProperty('--card', '#121821');
         root.style.setProperty('--muted', '#8aa0b4');
         root.style.setProperty('--text', '#e9f0f6');
       }
     }

    // ===== BMR =====
    function toKg(lbs){return lbs/2.2046}
    function toCm(ft,inch){return ft*30.48+inch*2.54}
    function calcBMR(age,lbs,ft,inch){
      const kg=toKg(lbs),cm=toCm(ft,inch);
      return 10*kg+6.25*cm-5*age+5;
    }
    function setBasalForToday(value){
      basalByDate[todayStr()]=Math.round(value);
      updateCharts();
      saveUserData();
    }
    function addActivityForToday(value){
      const d=todayStr();
      if(!activityByDate[d]) activityByDate[d]=0;
      activityByDate[d]+=Math.round(value);
      updateCharts();
      saveUserData();
    }
         function renderBMR(age,lbs,ft,inch){
       bmr=Math.round(calcBMR(age,lbs,ft,inch));
       setBasalForToday(bmr); // auto include BMR in daily total for the day
     }

         // BMR calculation is now handled automatically from user profile

         // ===== Residual Readings Functions =====
         function showResidualReadingsMenu() {
           console.log('showResidualReadingsMenu called');
           
           // Create a completely new, simple modal that we know will work
           const existingModal = document.getElementById('residualReadingsMenuModal');
           if (existingModal) {
             existingModal.remove();
           }
           
           // Create new modal
           const newModal = document.createElement('div');
           newModal.id = 'residualReadingsMenuModal';
           newModal.style.cssText = `
             position: fixed;
             top: 0;
             left: 0;
             width: 100vw;
             height: 100vh;
             background-color: rgba(0, 0, 0, 0.8);
             z-index: 99999;
             display: flex;
             align-items: center;
             justify-content: center;
             padding: 20px;
             box-sizing: border-box;
           `;
           
           // Create modal content
           const modalContent = document.createElement('div');
           modalContent.style.cssText = `
             background-color: #1f2937;
             border-radius: 12px;
             padding: 20px;
             max-width: 90%;
             max-height: 90vh;
             overflow-y: auto;
             color: white;
             width: 100%;
             box-sizing: border-box;
           `;
           
           // Add content
           modalContent.innerHTML = `
             <div style="display: flex; align-items: center; margin-bottom: 20px;">
               <div style="font-size: 24px; margin-right: 12px;">üìä</div>
               <div>
                 <h3 style="margin: 0; color: #f3f4f6; font-size: 18px;">Residual Readings</h3>
                 <p style="margin: 4px 0 0 0; color: #9ca3af; font-size: 14px;">Track residual readings at different locations</p>
               </div>
             </div>
             
             <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 20px;">
               <div id="openResidualReadingsEntry" style="
                 background: linear-gradient(135deg, #374151 0%, #4b5563 100%);
                 border: 1px solid #4b5563;
                 border-radius: 8px;
                 padding: 16px;
                 text-align: center;
                 cursor: pointer;
                 transition: all 0.2s ease;
               " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 8px rgba(0, 0, 0, 0.2)'" 
                 onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'">
                 <div style="font-size: 24px; margin-bottom: 8px;">üìù</div>
                 <div style="color: #f3f4f6; font-weight: 600; font-size: 14px;">Add Residual Reading</div>
               </div>
               
               <div id="openResidualReadingsHistory" style="
                 background: linear-gradient(135deg, #374151 0%, #4b5563 100%);
                 border: 1px solid #4b5563;
                 border-radius: 8px;
                 padding: 16px;
                 text-align: center;
                 cursor: pointer;
                 transition: all 0.2s ease;
               " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 8px rgba(0, 0, 0, 0.2)'" 
                 onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'">
                 <div style="font-size: 24px; margin-bottom: 8px;">üìã</div>
                 <div style="color: #f3f4f6; font-weight: 600; font-size: 14px;">View History</div>
               </div>
             </div>
             
             <div style="text-align: center;">
               <button id="closeResidualReadingsMenu" class="ghost">Close</button>
             </div>
           `;
           
           newModal.appendChild(modalContent);
           document.body.appendChild(newModal);
           
           // Add event listeners
           document.getElementById('openResidualReadingsEntry').addEventListener('click', showResidualReadingsModal);
           document.getElementById('openResidualReadingsHistory').addEventListener('click', showResidualReadingsHistoryModal);
           document.getElementById('closeResidualReadingsMenu').addEventListener('click', hideResidualReadingsMenu);
           
           console.log('New residual readings menu modal created and should be visible');
         }

         function hideResidualReadingsMenu() {
           const residualReadingsMenuModal = document.getElementById('residualReadingsMenuModal');
           if (residualReadingsMenuModal) {
             residualReadingsMenuModal.remove();
           }
         }

         function showResidualReadingsModal() {
           console.log('showResidualReadingsModal called');
           hideResidualReadingsMenu();
           
           // Create a completely new, simple modal that we know will work
           const existingModal = document.getElementById('residualReadingsModal');
           if (existingModal) {
             existingModal.remove();
           }
           
           // Create new modal
           const newModal = document.createElement('div');
           newModal.id = 'residualReadingsModal';
           newModal.style.cssText = `
             position: fixed;
             top: 0;
             left: 0;
             width: 100vw;
             height: 100vh;
             background-color: rgba(0, 0, 0, 0.8);
             z-index: 99999;
             display: flex;
             align-items: center;
             justify-content: center;
             padding: 20px;
             box-sizing: border-box;
           `;
           
           // Create modal content
           const modalContent = document.createElement('div');
           modalContent.style.cssText = `
             background-color: #1f2937;
             border-radius: 12px;
             padding: 20px;
             max-width: 90%;
             max-height: 90vh;
             overflow-y: auto;
             color: white;
             width: 100%;
             box-sizing: border-box;
           `;
           
           // Add content
           modalContent.innerHTML = `
             <div style="display: flex; align-items: center; margin-bottom: 20px;">
               <div style="font-size: 24px; margin-right: 12px;">üìä</div>
               <div>
                 <h3 style="margin: 0; color: #f3f4f6; font-size: 18px;">Add Residual Reading</h3>
                 <p style="margin: 4px 0 0 0; color: #9ca3af; font-size: 14px;">Log a new residual reading entry</p>
               </div>
             </div>
             
             <div style="margin-bottom: 20px;">
               <label style="display: block; color: #d1d5db; font-size: 14px; margin-bottom: 8px;">Location</label>
               <select id="residualReadingsLocation" style="
                 width: 100%;
                 padding: 12px;
                 background: #374151;
                 border: 1px solid #4b5563;
                 border-radius: 6px;
                 color: #f9fafb;
                 font-size: 14px;
                 box-sizing: border-box;
               ">
                 <option value="">Select location...</option>
                 <option value="custom">Custom Location</option>
               </select>
             </div>
             
             <div id="customResidualReadingsLocationField" style="margin-bottom: 20px; display: none;">
               <label style="display: block; color: #d1d5db; font-size: 14px; margin-bottom: 8px;">Custom Location Name</label>
               <input id="customResidualReadingsLocationName" type="text" placeholder="Enter custom location name" style="
                 width: 100%;
                 padding: 12px;
                 background: #374151;
                 border: 1px solid #4b5563;
                 border-radius: 6px;
                 color: #f9fafb;
                 font-size: 14px;
                 box-sizing: border-box;
               " />
             </div>
             
             <div style="margin-bottom: 20px;">
               <label style="display: block; color: #d1d5db; font-size: 14px; margin-bottom: 8px;">Residual Reading (ft)</label>
               <input id="residualReadingsValue" type="number" step="0.01" placeholder="Enter residual reading" style="
                 width: 100%;
                 padding: 12px;
                 background: #374151;
                 border: 1px solid #4b5563;
                 border-radius: 6px;
                 color: #f9fafb;
                 font-size: 14px;
                 box-sizing: border-box;
               " />
             </div>
             
             <div style="margin-bottom: 20px;">
               <label style="display: block; color: #d1d5db; font-size: 14px; margin-bottom: 8px;">Date</label>
               <input id="residualReadingsDate" type="date" style="
                 width: 100%;
                 padding: 10px 12px;
                 background: #374151;
                 border: 1px solid #4b5563;
                 border-radius: 6px;
                 color: #f9fafb;
                 font-size: 14px;
                 box-sizing: border-box;
                 -webkit-appearance: none;
                 -moz-appearance: none;
                 appearance: none;
               " />
             </div>
             
             <div id="residualReadingsResult" style="margin-bottom: 16px;"></div>
             
             <div style="display: flex; flex-direction: column; gap: 12px;">
               <button id="residualReadingsCalc" class="primary" style="width: 100%;">Log Residual Reading</button>
               <button id="closeResidualReadings" class="ghost" style="width: 100%;">Close</button>
             </div>
           `;
           
           newModal.appendChild(modalContent);
           document.body.appendChild(newModal);
           
           // Set default date to today
           document.getElementById('residualReadingsDate').value = todayStr();
           
           // Populate location dropdown with custom locations
           const locationDropdown = document.getElementById('residualReadingsLocation');
           customResidualReadingsLocations.forEach(location => {
             const option = document.createElement('option');
             option.value = location;
             option.textContent = location;
             option.setAttribute('data-custom', 'true');
             locationDropdown.appendChild(option);
           });
           
           // Add event listeners
           document.getElementById('closeResidualReadings').addEventListener('click', hideResidualReadingsModal);
           document.getElementById('residualReadingsCalc').addEventListener('click', function() {
             const { location, customLocation, value, date } = residualReadingsInputs();
             if (!location || !value || !date) {
               document.getElementById('residualReadingsResult').innerHTML = '<p style="color: #ef4444;">Please enter all values</p>';
               return;
             }
             if (location === 'custom' && !customLocation) {
               document.getElementById('residualReadingsResult').innerHTML = '<p style="color: #ef4444;">Please enter custom location name</p>';
               return;
             }
             renderResidualReadings(location, customLocation, value, date);
             // Close both the entry modal and the menu after logging
             hideResidualReadingsModal();
             hideResidualReadingsMenu();
           });
           
           // Location dropdown change listener
           document.getElementById('residualReadingsLocation').addEventListener('change', function() {
             const customField = document.getElementById('customResidualReadingsLocationField');
             if (this.value === 'custom') {
               customField.style.display = 'block';
             } else {
               customField.style.display = 'none';
             }
           });
           
           console.log('New residual readings entry modal created and should be visible');
         }

         function hideResidualReadingsModal() {
           const residualReadingsModal = document.getElementById('residualReadingsModal');
           if (residualReadingsModal) {
             residualReadingsModal.remove();
           }
         }

         function residualReadingsInputs() {
           const location = document.getElementById('residualReadingsLocation').value;
           const customLocation = document.getElementById('customResidualReadingsLocationName').value;
           const value = document.getElementById('residualReadingsValue').value;
           const date = document.getElementById('residualReadingsDate').value;
           return { location, customLocation, value, date };
         }

         function renderResidualReadings(location, customLocation, value, date) {
           const locationName = location === 'custom' ? customLocation : location;
           document.getElementById('residualReadingsResult').innerHTML = `<div class='math'>Logged: ${locationName} - ${value} ft on ${date}</div>`;
           
           // If it's a custom location, add it to the custom locations list
           if (location === 'custom' && customLocation && !customResidualReadingsLocations.includes(customLocation)) {
             customResidualReadingsLocations.push(customLocation);
             updateResidualReadingsLocationDropdowns();
           }
           
           // Save residual readings data to Firebase
           if (!residualReadingsDataByDate[date]) {
             residualReadingsDataByDate[date] = {};
           }
           
           // Store residual readings data by location (use locationName as key to avoid duplicates)
           residualReadingsDataByDate[date][locationName] = {
             value: value,
             locationName: locationName,
             timestamp: new Date().toISOString()
           };
           
           saveUserData();
           
           // Update residual readings chart
           loadResidualReadingsChart();
         }

         function loadResidualReadingsChart() {
           updateResidualReadingsCharts();
         }

         function updateResidualReadingsCharts() {
           const dates = Object.keys(residualReadingsDataByDate).sort();
           
           // First check if there's any data at all
           if (dates.length === 0) {
             // Show "no data" message for desktop chart
             if (typeof residualReadingsChart !== 'undefined') {
               residualReadingsChart.data.labels = ['No data to display yet'];
               residualReadingsChart.data.datasets = [{
                 label: 'No Data',
                 data: [0],
                 borderColor: 'transparent',
                 backgroundColor: 'transparent',
                 pointRadius: 0,
                 pointHoverRadius: 0
               }];
               residualReadingsChart.update();
             }
             
             // Show "no data" message for mobile chart
             if (typeof mobileResidualReadingsChart !== 'undefined') {
               mobileResidualReadingsChart.data.labels = ['No data to display yet'];
               mobileResidualReadingsChart.data.datasets = [{
                 label: 'No Data',
                 data: [0],
                 borderColor: 'transparent',
                 backgroundColor: 'transparent',
                 pointRadius: 0,
                 pointHoverRadius: 0
               }];
               mobileResidualReadingsChart.update();
             }
             return;
           }
           
           const twoMonthsAgo = new Date();
           twoMonthsAgo.setMonth(twoMonthsAgo.getMonth() - 2);
           const twoMonthsAgoStr = twoMonthsAgo.toISOString().split('T')[0];
           
           const filteredDates = dates.filter(date => date >= twoMonthsAgoStr);
           const filteredLabels = filteredDates.map(date => {
             const d = new Date(date + 'T00:00:00'); // Add time to avoid timezone issues
             return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
           });
           
           // Group data by location
           const locationData = {};
           filteredDates.forEach(date => {
             const dayData = residualReadingsDataByDate[date];
             Object.keys(dayData).forEach(locationName => {
               if (dayData[locationName] && dayData[locationName].value) {
                 if (!locationData[locationName]) {
                   locationData[locationName] = {
                     label: dayData[locationName].locationName,
                     data: [],
                     borderColor: getLocationColor(Object.keys(locationData).length),
                     backgroundColor: getLocationColor(Object.keys(locationData).length, 0.1),
                     tension: 0.25,
                 pointRadius: 6,
                 pointHoverRadius: 9
                   };
                 }
                 locationData[locationName].data.push(dayData[locationName].value);
               }
             });
           });
           
           const datasets = Object.values(locationData);
           
           // Check if there's no data
           if (datasets.length === 0) {
             // Show "no data" message for desktop chart
             if (typeof residualReadingsChart !== 'undefined') {
               residualReadingsChart.data.labels = ['No data to display yet'];
               residualReadingsChart.data.datasets = [{
                 label: 'No Data',
                 data: [0],
                 borderColor: 'transparent',
                 backgroundColor: 'transparent',
                 pointRadius: 0,
                 pointHoverRadius: 0
               }];
               residualReadingsChart.update();
             }
             
             // Show "no data" message for mobile chart
             if (typeof mobileResidualReadingsChart !== 'undefined') {
               mobileResidualReadingsChart.data.labels = ['No data to display yet'];
               mobileResidualReadingsChart.data.datasets = [{
                 label: 'No Data',
                 data: [0],
                 borderColor: 'transparent',
                 backgroundColor: 'transparent',
                 pointRadius: 0,
                 pointHoverRadius: 0
               }];
               mobileResidualReadingsChart.update();
             }
           } else {
             // Update desktop chart with data
             if (typeof residualReadingsChart !== 'undefined') {
               residualReadingsChart.data.labels = filteredLabels;
               residualReadingsChart.data.datasets = datasets;
               residualReadingsChart.update();
             }
             
             // Update mobile chart with data
             if (typeof mobileResidualReadingsChart !== 'undefined') {
               mobileResidualReadingsChart.data.labels = filteredLabels;
               mobileResidualReadingsChart.data.datasets = datasets;
               mobileResidualReadingsChart.update();
             }
           }
         }

         function updateResidualReadingsLocationDropdowns() {
           // This function will be implemented later
           console.log('updateResidualReadingsLocationDropdowns called');
         }

         function updateResidualReadingsChartsFullYear() {
           const dates = Object.keys(residualReadingsDataByDate).sort();
           const filteredLabels = dates.map(date => {
             const d = new Date(date + 'T00:00:00'); // Add time to avoid timezone issues
             return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
           });
           
           // Group data by location
           const locationData = {};
           dates.forEach(date => {
             const dayData = residualReadingsDataByDate[date];
             Object.keys(dayData).forEach(locationName => {
               if (dayData[locationName] && dayData[locationName].value) {
                 if (!locationData[locationName]) {
                   locationData[locationName] = {
                     label: dayData[locationName].locationName,
                     data: [],
                     borderColor: getLocationColor(Object.keys(locationData).length),
                     backgroundColor: getLocationColor(Object.keys(locationData).length, 0.1),
                     tension: 0.25,
                 pointRadius: 6,
                 pointHoverRadius: 9
                   };
                 }
                 locationData[locationName].data.push(dayData[locationName].value);
               }
             });
           });
           
           const datasets = Object.values(locationData);
           
           // Check if there's no data
           if (datasets.length === 0) {
             // Show "no data" message for desktop chart
             if (typeof residualReadingsChart !== 'undefined') {
               residualReadingsChart.data.labels = ['No data to display yet'];
               residualReadingsChart.data.datasets = [{
                 label: 'No Data',
                 data: [0],
                 borderColor: 'transparent',
                 backgroundColor: 'transparent',
                 pointRadius: 0,
                 pointHoverRadius: 0
               }];
               residualReadingsChart.update();
             }
             
             // Show "no data" message for mobile chart
             if (typeof mobileResidualReadingsChart !== 'undefined') {
               mobileResidualReadingsChart.data.labels = ['No data to display yet'];
               mobileResidualReadingsChart.data.datasets = [{
                 label: 'No Data',
                 data: [0],
                 borderColor: 'transparent',
                 backgroundColor: 'transparent',
                 pointRadius: 0,
                 pointHoverRadius: 0
               }];
               mobileResidualReadingsChart.update();
             }
           } else {
             // Update desktop chart with data
             if (typeof residualReadingsChart !== 'undefined') {
               residualReadingsChart.data.labels = filteredLabels;
               residualReadingsChart.data.datasets = datasets;
               residualReadingsChart.update();
             }
             
             // Update mobile chart with data
             if (typeof mobileResidualReadingsChart !== 'undefined') {
               mobileResidualReadingsChart.data.labels = filteredLabels;
               mobileResidualReadingsChart.data.datasets = datasets;
               mobileResidualReadingsChart.update();
             }
           }
         }

         function showResidualReadingsHistoryModal() {
           console.log('showResidualReadingsHistoryModal called');
           hideResidualReadingsMenu();
           
           // Create a completely new, simple modal that we know will work
           const existingModal = document.getElementById('residualReadingsHistoryModal');
           if (existingModal) {
             existingModal.remove();
           }
           
           // Create new modal
           const newModal = document.createElement('div');
           newModal.id = 'residualReadingsHistoryModal';
           newModal.style.cssText = `
             position: fixed;
             top: 0;
             left: 0;
             width: 100vw;
             height: 100vh;
             background-color: rgba(0, 0, 0, 0.8);
             z-index: 99999;
             display: flex;
             align-items: center;
             justify-content: center;
             padding: 20px;
             box-sizing: border-box;
           `;
           
           // Create modal content
           const modalContent = document.createElement('div');
           modalContent.style.cssText = `
             background-color: #1f2937;
             border-radius: 12px;
             padding: 20px;
             max-width: 90%;
             max-height: 90vh;
             overflow-y: auto;
             color: white;
             width: 100%;
             box-sizing: border-box;
           `;
           
           // Add content
           modalContent.innerHTML = `
             <div style="display: flex; align-items: center; margin-bottom: 20px;">
               <div style="font-size: 24px; margin-right: 12px;">üìä</div>
               <div>
                 <h3 style="margin: 0; color: #f3f4f6; font-size: 18px;">Residual Readings History</h3>
                 <p style="margin: 4px 0 0 0; color: #9ca3af; font-size: 14px;">View recorded residual reading data</p>
               </div>
             </div>
             
             <div style="margin-bottom: 20px;">
               <label style="display: block; color: #d1d5db; font-size: 14px; margin-bottom: 8px;">Filter by Location</label>
               <select id="residualReadingsHistoryLocation" style="
                 width: 100%;
                 padding: 12px;
                 background: #374151;
                 border: 1px solid #4b5563;
                 border-radius: 6px;
                 color: #f9fafb;
                 font-size: 14px;
                 box-sizing: border-box;
               ">
                 <option value="">All Locations</option>
               </select>
             </div>
             
             <div style="margin-bottom: 20px;">
               <label style="display: block; color: #d1d5db; font-size: 14px; margin-bottom: 8px;">Date Range</label>
               <select id="residualReadingsHistoryDateRange" style="
                 width: 100%;
                 padding: 12px;
                 background: #374151;
                 border: 1px solid #4b5563;
                 border-radius: 6px;
                 color: #f9fafb;
                 font-size: 14px;
                 box-sizing: border-box;
               ">
                 <option value="all">All Time</option>
                 <option value="30">Last 30 days</option>
                 <option value="90">Last 90 days</option>
                 <option value="365">Last Year</option>
               </select>
             </div>
             
             <div id="residualReadingsHistoryContent" style="margin-bottom: 20px;">
               <!-- History content will be loaded here -->
             </div>
             
             <div style="display: flex; flex-direction: column; gap: 12px;">
               <button id="exportResidualReadingsHistoryBtn" class="primary" style="width: 100%;">üìä Export to Excel</button>
               <button id="closeResidualReadingsHistory" class="ghost" style="width: 100%;">Close</button>
             </div>
           `;
           
           newModal.appendChild(modalContent);
           document.body.appendChild(newModal);
           
           // Load history data
           loadResidualReadingsHistory();
           
           // Add event listeners
           document.getElementById('closeResidualReadingsHistory').addEventListener('click', hideResidualReadingsHistoryModal);
           document.getElementById('exportResidualReadingsHistoryBtn').addEventListener('click', exportResidualReadingsDataToExcel);
           document.getElementById('residualReadingsHistoryLocation').addEventListener('change', loadResidualReadingsHistory);
           document.getElementById('residualReadingsHistoryDateRange').addEventListener('change', loadResidualReadingsHistory);
           
           console.log('New residual readings history modal created and should be visible');
         }

         function hideResidualReadingsHistoryModal() {
           const residualReadingsHistoryModal = document.getElementById('residualReadingsHistoryModal');
           if (residualReadingsHistoryModal) {
             residualReadingsHistoryModal.remove();
           }
         }

         function loadResidualReadingsHistory() {
           const locationFilter = document.getElementById('residualReadingsHistoryLocation')?.value || '';
           const dateRangeFilter = document.getElementById('residualReadingsHistoryDateRange')?.value || 'all';
           
           const dates = Object.keys(residualReadingsDataByDate).sort();
           
           // Apply date filter
           if (dateRangeFilter !== 'all') {
             const cutoffDays = parseInt(dateRangeFilter);
             const cutoffDate = new Date();
             cutoffDate.setDate(cutoffDate.getDate() - cutoffDays);
             const cutoffDateStr = cutoffDate.toISOString().split('T')[0];
             dates = dates.filter(date => date >= cutoffDateStr);
           }
           
           // Apply location filter
           let filteredData = [];
           dates.forEach(date => {
             const dayData = residualReadingsDataByDate[date];
             Object.keys(dayData).forEach(locationName => {
               if (dayData[locationName] && dayData[locationName].value) {
                 // Check location filter
                 if (!locationFilter || locationName === locationFilter) {
                   filteredData.push({
                     date,
                     location: locationName,
                     data: dayData[locationName]
                   });
                 }
               }
             });
           });
           
           if (filteredData.length === 0) {
             const noDataMessage = locationFilter || dateRangeFilter !== 'all' 
               ? 'No data found for the selected filters'
               : 'No residual readings data recorded yet';
             document.getElementById('residualReadingsHistoryContent').innerHTML = `
               <div style="text-align: center; padding: 40px; color: #9ca3af;">
                 <div style="font-size: 48px; margin-bottom: 16px;">üìä</div>
                 <p style="margin: 0; font-size: 16px;">${noDataMessage}</p>
               </div>
             `;
             return;
           }
           
           // Sort by date (newest first)
           filteredData.sort((a, b) => new Date(b.date) - new Date(a.date));
           
           let historyHTML = `
             <div style="margin-bottom: 16px;">
               <h4 style="color: #f3f4f6; margin: 0 0 12px 0;">Recent Residual Reading Entries</h4>
             </div>
             <div style="display: flex; flex-direction: column; gap: 12px;">
           `;
           
           filteredData.forEach(entry => {
             const formattedDate = new Date(entry.date).toLocaleDateString('en-US', { 
               month: 'short', 
               day: 'numeric', 
               year: 'numeric' 
             });
             
             historyHTML += `
               <div style="
                 background: linear-gradient(135deg, #1f2937 0%, #374151 100%);
                 border: 1px solid #4b5563;
                 border-radius: 12px;
                 padding: 16px;
                 display: flex;
                 justify-content: space-between;
                 align-items: center;
                 transition: all 0.2s ease;
                 box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
               " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 8px rgba(0, 0, 0, 0.2)'" 
                 onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 4px rgba(0, 0, 0, 0.1)'">
                 <div style="display: flex; flex-direction: column; gap: 4px;">
                   <div style="font-weight: 600; color: #f3f4f6; font-size: 16px;">${entry.data.locationName}</div>
                   <div style="color: #9ca3af; font-size: 14px;">${formattedDate}</div>
                 </div>
                 <div style="display: flex; align-items: center; gap: 12px;">
                   <div style="
                     background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
                     color: white;
                     padding: 8px 16px;
                     border-radius: 20px;
                     font-weight: 600;
                     font-size: 14px;
                     min-width: 80px;
                     text-align: center;
                   ">${entry.data.value} ft</div>
                   <button onclick="deleteResidualReadingsEntry('${entry.date}', '${entry.data.locationName}')" style="
                     background: #dc2626;
                     color: white;
                     border: none;
                     border-radius: 6px;
                     padding: 8px 12px;
                     font-size: 12px;
                     cursor: pointer;
                     transition: all 0.2s ease;
                   " onmouseover="this.style.background='#b91c1c'" onmouseout="this.style.background='#dc2626'">
                     üóëÔ∏è Delete
                   </button>
                 </div>
               </div>
             `;
           });
           
           historyHTML += `
               </div>
             </div>
           `;
           
           document.getElementById('residualReadingsHistoryContent').innerHTML = historyHTML;
         }

         function deleteResidualReadingsEntry(date, locationName) {
           if (confirm('Are you sure you want to delete this residual reading entry?')) {
             // Remove the entry from the data
             if (residualReadingsDataByDate[date] && residualReadingsDataByDate[date][locationName]) {
               delete residualReadingsDataByDate[date][locationName];
               
               // If no more entries for this date, remove the date entirely
               if (Object.keys(residualReadingsDataByDate[date]).length === 0) {
                 delete residualReadingsDataByDate[date];
               }
               
               // Save to Firebase
               saveUserData();
               
               // Reload the history to reflect changes
               loadResidualReadingsHistory();
               
               // Update charts
               updateResidualReadingsCharts();
             }
           }
         }

         function exportResidualReadingsDataToExcel() {
           // Download the file immediately
           downloadResidualReadingsCSV();
           
           // Also show email modal
           showResidualReadingsEmailModal();
         }

         function downloadResidualReadingsCSV() {
           const dates = Object.keys(residualReadingsDataByDate).sort();
           const allData = [];
           
           // Add header row
           allData.push(['Date', 'Location', 'Residual Reading (ft)', 'Timestamp']);
           
           // Add data rows
           dates.forEach(date => {
             const dayData = residualReadingsDataByDate[date];
             Object.keys(dayData).forEach(locationName => {
               if (dayData[locationName] && dayData[locationName].value) {
                 allData.push([
                   date,
                   dayData[locationName].locationName,
                   dayData[locationName].value,
                   dayData[locationName].timestamp || ''
                 ]);
               }
             });
           });
           
           // Convert to CSV format
           const csvContent = allData.map(row => 
             row.map(cell => `"${cell}"`).join(',')
           ).join('\n');
           
           // Create and download file
           const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
           const link = document.createElement('a');
           const url = URL.createObjectURL(blob);
           link.setAttribute('href', url);
           link.setAttribute('download', `residual_readings_data_${todayStr()}.csv`);
           link.style.visibility = 'hidden';
           document.body.appendChild(link);
           link.click();
           document.body.removeChild(link);
         }

         function showResidualReadingsEmailModal() {
           console.log('showResidualReadingsEmailModal called');
           
           // Create a completely new, simple modal that we know will work
           const existingModal = document.getElementById('residualReadingsEmailModal');
           if (existingModal) {
             existingModal.remove();
           }
           
           // Create new modal
           const newModal = document.createElement('div');
           newModal.id = 'residualReadingsEmailModal';
           newModal.style.cssText = `
             position: fixed;
             top: 0;
             left: 0;
             width: 100vw;
             height: 100vh;
             background-color: rgba(0, 0, 0, 0.8);
             z-index: 99999;
             display: flex;
             align-items: center;
             justify-content: center;
             padding: 20px;
             box-sizing: border-box;
           `;
           
           // Create modal content
           const modalContent = document.createElement('div');
           modalContent.style.cssText = `
             background-color: #1f2937;
             border-radius: 12px;
             padding: 20px;
             max-width: 90%;
             max-height: 90vh;
             overflow-y: auto;
             color: white;
             width: 100%;
             box-sizing: border-box;
           `;
           
           // Add content
           modalContent.innerHTML = `
             <div style="display: flex; align-items: center; margin-bottom: 20px;">
               <div style="font-size: 24px; margin-right: 12px;">üìß</div>
               <div>
                 <h3 style="margin: 0; color: #f3f4f6; font-size: 18px;">Send Data via Email</h3>
                 <p style="margin: 4px 0 0 0; color: #9ca3af; font-size: 14px;">Enter email address to receive your residual readings data</p>
               </div>
             </div>
             
             <div style="margin-bottom: 20px;">
               <label style="display: block; color: #d1d5db; font-size: 14px; margin-bottom: 8px;">Email Address</label>
               <input id="residualReadingsEmailAddress" type="email" placeholder="Enter email address" style="
                 width: 100%;
                 padding: 12px;
                 background: #374151;
                 border: 1px solid #4b5563;
                 border-radius: 6px;
                 color: #f9fafb;
                 font-size: 14px;
                 box-sizing: border-box;
               " />
             </div>
             
             <div id="residualReadingsEmailResult" style="margin-bottom: 16px;"></div>
             
             <div style="display: flex; flex-direction: column; gap: 12px;">
               <button id="sendResidualReadingsEmailBtn" class="primary" style="width: 100%;">üìß Send Data</button>
               <button id="closeResidualReadingsEmailModal" class="ghost" style="width: 100%;">Close</button>
             </div>
           `;
           
           newModal.appendChild(modalContent);
           document.body.appendChild(newModal);
           
           // Add event listeners
           document.getElementById('closeResidualReadingsEmailModal').addEventListener('click', hideResidualReadingsEmailModal);
           document.getElementById('sendResidualReadingsEmailBtn').addEventListener('click', sendResidualReadingsDataViaEmail);
           
           console.log('New residual readings email modal created and should be visible');
         }

         function hideResidualReadingsEmailModal() {
           const residualReadingsEmailModal = document.getElementById('residualReadingsEmailModal');
           if (residualReadingsEmailModal) {
             residualReadingsEmailModal.remove();
           }
         }

         function sendResidualReadingsDataViaEmail() {
           const emailAddress = document.getElementById('residualReadingsEmailAddress').value.trim();
           const resultDiv = document.getElementById('residualReadingsEmailResult');
           
           if (!emailAddress) {
             resultDiv.innerHTML = '<p style="color: #ef4444; margin: 0;">Please enter an email address</p>';
             return;
           }
           
           if (!emailAddress.includes('@')) {
             resultDiv.innerHTML = '<p style="color: #ef4444; margin: 0;">Please enter a valid email address</p>';
             return;
           }
           
           // Show loading state
           resultDiv.innerHTML = '<p style="color: #3b82f6; margin: 0;">Sending email...</p>';
           document.getElementById('sendResidualReadingsEmailBtn').disabled = true;
           document.getElementById('sendResidualReadingsEmailBtn').textContent = 'Sending...';
           
           // Prepare data
           const dates = Object.keys(residualReadingsDataByDate).sort();
           const allData = [];
           
           // Add header row
           allData.push(['Date', 'Location', 'Residual Reading (ft)', 'Timestamp']);
           
           // Add data rows
           dates.forEach(date => {
             const dayData = residualReadingsDataByDate[date];
             Object.keys(dayData).forEach(locationName => {
               if (dayData[locationName] && dayData[locationName].value) {
                 allData.push([
                   date,
                   dayData[locationName].locationName,
                   dayData[locationName].value,
                   dayData[locationName].timestamp || ''
                 ]);
               }
             });
           });
           
           // Convert to CSV format
           const csvContent = allData.map(row => 
             row.map(cell => `"${cell}"`).join(',')
           ).join('\n');
           
           // Create HTML table for email body - using more email-friendly HTML
           let tableHTML = `
             <table border="1" cellpadding="8" cellspacing="0" style="border-collapse: collapse; width: 100%; font-family: Arial, sans-serif; margin: 20px 0;">
               <tr style="background-color: #f2f2f2;">
                 <th style="border: 1px solid #ddd; padding: 8px; text-align: left;">Date</th>
                 <th style="border: 1px solid #ddd; padding: 8px; text-align: left;">Location</th>
                 <th style="border: 1px solid #ddd; padding: 8px; text-align: left;">Residual Reading (ft)</th>
                 <th style="border: 1px solid #ddd; padding: 8px; text-align: left;">Timestamp</th>
               </tr>
           `;
           
           // Add data rows
           dates.forEach(date => {
             const dayData = residualReadingsDataByDate[date];
             Object.keys(dayData).forEach(locationName => {
               if (dayData[locationName] && dayData[locationName].value) {
                 const timestamp = dayData[locationName].timestamp ? 
                   new Date(dayData[locationName].timestamp).toLocaleString() : '';
                 tableHTML += `
                   <tr>
                     <td style="border: 1px solid #ddd; padding: 8px;">${date}</td>
                     <td style="border: 1px solid #ddd; padding: 8px;">${dayData[locationName].locationName}</td>
                     <td style="border: 1px solid #ddd; padding: 8px;">${dayData[locationName].value}</td>
                     <td style="border: 1px solid #ddd; padding: 8px;">${timestamp}</td>
                   </tr>
                 `;
               }
             });
           });
           
           tableHTML += `
             </table>
           `;
           
           // Create a simple text table as backup
           let textTable = `
Residual Readings Data
=====================

Date         | Location | Residual Reading (ft) | Timestamp
-------------|----------|----------------------|------------------
           `;
           
           dates.forEach(date => {
             const dayData = residualReadingsDataByDate[date];
             Object.keys(dayData).forEach(locationName => {
               if (dayData[locationName] && dayData[locationName].value) {
                 const timestamp = dayData[locationName].timestamp ? 
                   new Date(dayData[locationName].timestamp).toLocaleString() : '';
                 textTable += `${date.padEnd(12)} | ${locationName.padEnd(8)} | ${dayData[locationName].value.toString().padEnd(20)} | ${timestamp}\n`;
               }
             });
           });
           
           textTable += `
=====================
           `;
           
           // Send email using EmailJS
           const templateParams = {
             user_email: emailAddress,
             to_email: emailAddress,
             email: emailAddress,
             from_name: 'WaterData App',
             subject: `Residual Readings Data - ${todayStr()}`,
             message: `Please find your residual readings data below, exported on ${new Date().toLocaleDateString()}.`,
             table_data: tableHTML,
             text_table: textTable,
             csv_content: csvContent,
             export_date: new Date().toLocaleDateString()
           };
           
           console.log('Sending residual readings email with params:', templateParams);
           console.log('Email address being sent:', emailAddress);
           console.log('Table HTML being sent:', tableHTML);
           
           emailjs.send('service_tr7srcd', 'template_6er1sgu', templateParams)
             .then(function(response) {
               console.log('Email sent successfully:', response);
               resultDiv.innerHTML = '<p style="color: #10b981; margin: 0;">‚úÖ Email sent successfully!</p>';
               document.getElementById('sendResidualReadingsEmailBtn').textContent = 'Email Sent!';
               
               // Close modal after 2 seconds
               setTimeout(() => {
                 hideResidualReadingsEmailModal();
               }, 2000);
             })
             .catch(function(error) {
               console.error('Email sending failed:', error);
               resultDiv.innerHTML = '<p style="color: #ef4444; margin: 0;">‚ùå Failed to send email. Please try again.</p>';
               document.getElementById('sendResidualReadingsEmailBtn').disabled = false;
               document.getElementById('sendResidualReadingsEmailBtn').textContent = 'üìß Send Data';
             });
         }

         // ===== Charts =====
     let totalCtx=document.getElementById('totalChart').getContext('2d');
     let totalChart=new Chart(totalCtx,{
       type:'line',
       data:{labels:[],datasets:[
         {label:'Calorie Deficit',data:[],borderColor:'#6ee7b7',backgroundColor:'rgba(110,231,183,.3)',fill:true,tension:0.25,pointRadius:6,pointHoverRadius:9}
       ]},
       options:{responsive:true,scales:{y:{beginAtZero:true,title:{display:true,text:'Calories'}}}}
     });

     // Mobile Charts
     let mobileTotalCtx=document.getElementById('mobileTotalChart').getContext('2d');
     let mobileTotalChart=new Chart(mobileTotalCtx,{
       type:'line',
       data:{labels:[],datasets:[
         {label:'Calorie Deficit',data:[],borderColor:'#6ee7b7',backgroundColor:'rgba(110,231,183,.3)',fill:true,tension:0.25,pointRadius:6,pointHoverRadius:9}
       ]},
       options:{responsive:true,scales:{y:{beginAtZero:true,title:{display:true,text:'Calories'}}}}
     });

         // Weight charts removed - weight module replaced with meter reads module
     // let weightCtx=document.getElementById('weightChart').getContext('2d');
     // let weightChart=new Chart(weightCtx,{...});
     // let mobileWeightCtx=document.getElementById('mobileWeightChart').getContext('2d');
     // let mobileWeightChart=new Chart(mobileWeightCtx,{...});

     let waterLevelCtx=document.getElementById('waterLevelChart').getContext('2d');
     let waterLevelChart=new Chart(waterLevelCtx,{
       type:'line',
       data:{labels:[],datasets:[
         {label:'Water Level (ft)',data:[],borderColor:'#3b82f6',backgroundColor:'rgba(59,130,246,.3)',fill:true,tension:0.25,pointRadius:6,pointHoverRadius:9}
       ]},
       options:{responsive:true,scales:{y:{beginAtZero:true,title:{display:true,text:'Water Level (ft)'}}}}
     });

     let mobileWaterLevelCtx=document.getElementById('mobileWaterLevelChart').getContext('2d');
     let mobileWaterLevelChart=new Chart(mobileWaterLevelCtx,{
       type:'line',
       data:{labels:[],datasets:[
         {label:'Water Level (ft)',data:[],borderColor:'#3b82f6',backgroundColor:'rgba(59,130,246,.3)',fill:true,tension:0.25,pointRadius:6,pointHoverRadius:9}
       ]},
       options:{responsive:true,scales:{y:{beginAtZero:true,title:{display:true,text:'Water Level (ft)'}}}}
     });

     // Meter Reads Charts
     let meterReadsCtx=document.getElementById('meterReadsChart').getContext('2d');
     let meterReadsChart=new Chart(meterReadsCtx,{
       type:'line',
       data:{labels:[],datasets:[
         {label:'Meter Reads (ft)',data:[],borderColor:'#10b981',backgroundColor:'rgba(16,185,129,.3)',fill:true,tension:0.25,pointRadius:6,pointHoverRadius:9}
       ]},
       options:{responsive:true,scales:{y:{beginAtZero:true,title:{display:true,text:'Meter Reads (ft)'}}}}
     });

     let mobileMeterReadsCtx=document.getElementById('mobileMeterReadsChart').getContext('2d');
     let mobileMeterReadsChart=new Chart(mobileMeterReadsCtx,{
       type:'line',
       data:{labels:[],datasets:[
         {label:'Meter Reads (ft)',data:[],borderColor:'#10b981',backgroundColor:'rgba(16,185,129,.3)',fill:true,tension:0.25,pointRadius:6,pointHoverRadius:9}
       ]},
       options:{responsive:true,scales:{y:{beginAtZero:true,title:{display:true,text:'Meter Reads (ft)'}}}}
     });

     // Residual Readings Charts
     let residualReadingsCtx=document.getElementById('residualReadingsChart').getContext('2d');
     let residualReadingsChart=new Chart(residualReadingsCtx,{
       type:'line',
       data:{labels:[],datasets:[
         {label:'Residual Readings (ft)',data:[],borderColor:'#f59e0b',backgroundColor:'rgba(245,158,11,.3)',fill:true,tension:0.25,pointRadius:6,pointHoverRadius:9}
       ]},
       options:{responsive:true,scales:{y:{beginAtZero:true,title:{display:true,text:'Residual Readings (ft)'}}}}
     });

     let mobileResidualReadingsCtx=document.getElementById('mobileResidualReadingsChart').getContext('2d');
     let mobileResidualReadingsChart=new Chart(mobileResidualReadingsCtx,{
       type:'line',
       data:{labels:[],datasets:[
         {label:'Residual Readings (ft)',data:[],borderColor:'#f59e0b',backgroundColor:'rgba(245,158,11,.3)',fill:true,tension:0.25,pointRadius:6,pointHoverRadius:9}
       ]},
       options:{responsive:true,scales:{y:{beginAtZero:true,title:{display:true,text:'Residual Readings (ft)'}}}}
     });

     // Mobile Food Chart
     let mobileFoodCtx=document.getElementById('mobileFoodChart').getContext('2d');
     let mobileFoodChart=new Chart(mobileFoodCtx,{
       type:'line',
       data:{labels:[],datasets:[
         {label:'Food Calories',data:[],borderColor:'#f59e0b',backgroundColor:'rgba(245,158,11,.3)',fill:true,tension:0.25,pointRadius:6,pointHoverRadius:9}
       ]},
       options:{responsive:true,scales:{y:{beginAtZero:true,title:{display:true,text:'Calories'}}}}
     });

                  function getAllDates(){
           const set = new Set([
             ...Object.keys(basalByDate || {}),
             ...Object.keys(activityByDate || {}),
             ...Object.keys(foodDataByDate || {}),
             ...Object.keys(waterLevelDataByDate || {})
           ]);
           return Array.from(set).sort();
         }

         function computeFoodCaloriesForDate(d){
           const day = foodDataByDate?.[d] || {};
           let total = 0;
           for (const k of Object.keys(day)) {
             const item = day[k] || {};
             const qty = Number(item.quantity ?? 1);
             const fromTotal = Number(item.totalCalories);
             const fromParts = Number(item.calories) * qty;
             const add = !isNaN(fromTotal) ? fromTotal : (!isNaN(fromParts) ? fromParts : 0);
             total += add;
           }
           return Math.round(total);
         }

     // ===== Mobile Swipe Navigation =====
     const totalSlides = 4;
     let currentSlide = 0;
     let startX = 0;
     let currentX = 0;
     let isDragging = false;
     let swipeCount = 0;

     function showSlide(slideIndex) {
       // Hide all slides first
       for (let i = 0; i < totalSlides; i++) {
         const slide = document.getElementById(`mobile-slide-${i + 1}`);
         const indicator = document.querySelectorAll('.mobile-indicator')[i];
         
         slide.classList.remove('active', 'prev', 'next');
         slide.style.display = 'none';
         slide.style.transform = '';
         slide.style.opacity = '';
         indicator.classList.remove('active');
       }

       // Show current slide
       const currentSlideElement = document.getElementById(`mobile-slide-${slideIndex + 1}`);
       const currentIndicator = document.querySelectorAll('.mobile-indicator')[slideIndex];
       
       currentSlideElement.style.display = 'flex';
       currentSlideElement.classList.add('active');
       currentIndicator.classList.add('active');

       // Set previous slide for swipe animation
       const prevIndex = slideIndex === 0 ? totalSlides - 1 : slideIndex - 1;
       const prevSlide = document.getElementById(`mobile-slide-${prevIndex + 1}`);
       prevSlide.style.display = 'flex';
       prevSlide.classList.add('prev');

       // Set next slide for swipe animation
       const nextIndex = slideIndex === totalSlides - 1 ? 0 : slideIndex + 1;
       const nextSlide = document.getElementById(`mobile-slide-${nextIndex + 1}`);
       nextSlide.style.display = 'flex';
       nextSlide.classList.add('next');
     }

     function nextSlide() {
       currentSlide = (currentSlide + 1) % totalSlides;
       showSlide(currentSlide);
       incrementSwipeCount();
     }

     function prevSlide() {
       currentSlide = currentSlide === 0 ? totalSlides - 1 : currentSlide - 1;
       showSlide(currentSlide);
       incrementSwipeCount();
     }
     
     function incrementSwipeCount() {
       swipeCount++;
       if (swipeCount >= 3) {
         const swipeHint = document.querySelector('.swipe-hint');
         if (swipeHint) {
           swipeHint.style.display = 'none';
         }
       }
     }

     // Touch event handlers with improved sensitivity
     let startY = 0;
     let isVerticalScroll = false;
     let hasMoved = false;
     let startTime = 0;
     let velocity = 0;
     let lastMoveTime = 0;

     function handleTouchStart(e) {
       // Don't start swipe detection if touching a button or interactive element
       if (e.target.tagName === 'BUTTON' || e.target.closest('button') || 
           e.target.tagName === 'INPUT' || e.target.closest('input') ||
           e.target.tagName === 'SELECT' || e.target.closest('select') ||
           e.target.closest('.modal-overlay')) {
         return;
       }
       
       startX = e.touches[0].clientX;
       startY = e.touches[0].clientY;
       startTime = Date.now();
       isDragging = true;
       isVerticalScroll = false;
       hasMoved = false;
       velocity = 0;
     }

     function handleTouchMove(e) {
       if (!isDragging) return;
       
       currentX = e.touches[0].clientX;
       const currentY = e.touches[0].clientY;
       const diffX = startX - currentX;
       const diffY = startY - currentY;
       const currentTime = Date.now();
       
       // Calculate velocity for momentum-based swiping
       if (currentTime - lastMoveTime > 0) {
         velocity = Math.abs(diffX) / (currentTime - lastMoveTime);
       }
       lastMoveTime = currentTime;
       
       // Check if we've moved enough to consider it a gesture (reduced threshold)
       if (Math.abs(diffX) > 3 || Math.abs(diffY) > 3) {
         hasMoved = true;
       }
       
       // Determine if this is a vertical scroll or horizontal swipe
       if (!isVerticalScroll && Math.abs(diffY) > Math.abs(diffX) && Math.abs(diffY) > 8) {
         isVerticalScroll = true;
         return; // Allow normal scrolling
       }
       
       // Handle horizontal swipes with reduced threshold
       if (Math.abs(diffX) > Math.abs(diffY) && Math.abs(diffX) > 8) {
         e.preventDefault(); // Prevent scrolling during horizontal swipe
         
         // Add visual feedback for all swipes (reduced threshold)
         const activeSlide = document.querySelector('.mobile-slide.active');
         if (Math.abs(diffX) > 5) {
           // Add smooth transition during swipe
           activeSlide.style.transition = 'none';
           activeSlide.style.transform = `translateX(${-diffX}px)`;
           
           // Add opacity effect for better visual feedback
           const opacity = Math.max(0.7, 1 - Math.abs(diffX) / 200);
           activeSlide.style.opacity = opacity;
         }
       }
     }

     function handleTouchEnd(e) {
       if (!isDragging || isVerticalScroll || !hasMoved) {
         // Reset any transforms
         const activeSlide = document.querySelector('.mobile-slide.active');
         if (activeSlide) {
           activeSlide.style.transform = '';
           activeSlide.style.opacity = '';
           activeSlide.style.transition = 'transform 0.3s ease-in-out, opacity 0.3s ease-in-out';
         }
         
         isDragging = false;
         isVerticalScroll = false;
         hasMoved = false;
         return;
       }
       
       isDragging = false;
       const diff = startX - currentX;
       const timeDiff = Date.now() - startTime;
       
       // Dynamic threshold based on velocity and distance
       let threshold = 50; // Reduced base threshold
       
       // If swipe is fast (high velocity), reduce threshold
       if (velocity > 0.5) {
         threshold = 30;
       }
       
       // If swipe is very fast, make it even more sensitive
       if (velocity > 1.0) {
         threshold = 20;
       }
       
       // Reset transform with smooth transition
       const activeSlide = document.querySelector('.mobile-slide.active');
       if (activeSlide) {
         activeSlide.style.transition = 'transform 0.3s ease-in-out, opacity 0.3s ease-in-out';
         activeSlide.style.transform = '';
         activeSlide.style.opacity = '';
       }
       
       // Check if swipe meets threshold or has high velocity
       if (Math.abs(diff) > threshold || velocity > 0.8) {
         if (diff > 0) {
           // Swipe left - next slide
           nextSlide();
         } else {
           // Swipe right - previous slide
           prevSlide();
         }
       }
       
       hasMoved = false;
       velocity = 0;
     }

     // Keyboard shortcut handler
     function handleKeyboardShortcuts(e) {
       // Arrow keys for navigation
       if (e.key === 'ArrowLeft') {
         e.preventDefault();
         prevSlide();
       } else if (e.key === 'ArrowRight') {
         e.preventDefault();
         nextSlide();
       }
       // Ctrl+Shift for quick navigation
       else if (e.ctrlKey && e.shiftKey) {
         e.preventDefault();
         nextSlide();
       }
     }

     // Initialize mobile swipe with improved event handling
     function initMobileSwipe() {
       const mobileContainer = document.querySelector('.mobile-container');
       if (mobileContainer) {
         // Use passive: false for better control over touch events
         mobileContainer.addEventListener('touchstart', handleTouchStart, { passive: false });
         mobileContainer.addEventListener('touchmove', handleTouchMove, { passive: false });
         mobileContainer.addEventListener('touchend', handleTouchEnd, { passive: false });
         
         // Add mouse events for desktop testing
         mobileContainer.addEventListener('mousedown', (e) => {
           if (e.button === 0) { // Left mouse button only
             startX = e.clientX;
             startY = e.clientY;
             startTime = Date.now();
             isDragging = true;
             isVerticalScroll = false;
             hasMoved = false;
             velocity = 0;
           }
         });
         
         mobileContainer.addEventListener('mousemove', (e) => {
           if (!isDragging) return;
           
           currentX = e.clientX;
           const currentY = e.clientY;
           const diffX = startX - currentX;
           const diffY = startY - currentY;
           const currentTime = Date.now();
           
           if (currentTime - lastMoveTime > 0) {
             velocity = Math.abs(diffX) / (currentTime - lastMoveTime);
           }
           lastMoveTime = currentTime;
           
           if (Math.abs(diffX) > 3 || Math.abs(diffY) > 3) {
             hasMoved = true;
           }
           
           if (!isVerticalScroll && Math.abs(diffY) > Math.abs(diffX) && Math.abs(diffY) > 8) {
             isVerticalScroll = true;
             return;
           }
           
           if (Math.abs(diffX) > Math.abs(diffY) && Math.abs(diffX) > 8) {
             const activeSlide = document.querySelector('.mobile-slide.active');
             if (Math.abs(diffX) > 5) {
               activeSlide.style.transition = 'none';
               activeSlide.style.transform = `translateX(${-diffX}px)`;
               const opacity = Math.max(0.7, 1 - Math.abs(diffX) / 200);
               activeSlide.style.opacity = opacity;
             }
           }
         });
         
         mobileContainer.addEventListener('mouseup', (e) => {
           if (isDragging) {
             handleTouchEnd(e);
           }
         });
         
         mobileContainer.addEventListener('mouseleave', (e) => {
           if (isDragging) {
             handleTouchEnd(e);
           }
         });
       }
       
       // Add click functionality to indicators
       const indicators = document.querySelectorAll('.mobile-indicator');
       indicators.forEach((indicator, index) => {
         indicator.addEventListener('click', () => {
           currentSlide = index;
           showSlide(index);
           incrementSwipeCount();
         });
       });
       
       // Add keyboard event listener
       document.addEventListener('keydown', handleKeyboardShortcuts);
       
       // Fix mobile viewport height issues
       fixMobileViewport();
     }
     
     function fixMobileViewport() {
       // Set CSS custom property for real viewport height
       const setVH = () => {
         const vh = window.innerHeight * 0.01;
         document.documentElement.style.setProperty('--vh', `${vh}px`);
       };
       
       // Set initial value
       setVH();
       
       // Update on resize and orientation change
       window.addEventListener('resize', () => {
         setVH();
         fixMobileSlideCentering(); // Fix centering on resize
         fixStreakModulePositioning(); // Fix streak positioning on resize
       });
       window.addEventListener('orientationchange', () => {
         setTimeout(() => {
           setVH();
           fixMobileSlideCentering(); // Fix centering on orientation change
           fixStreakModulePositioning(); // Fix streak positioning on orientation change
         }, 100); // Delay to ensure proper height calculation
       });
     }

     // Fix mobile slide centering issues
     function fixMobileSlideCentering() {
       const mobileSlides = document.querySelectorAll('.mobile-slide');
       mobileSlides.forEach(slide => {
         // Reset any existing transforms that might cause centering issues
         slide.style.left = '0';
         slide.style.right = '0';
         slide.style.marginLeft = 'auto';
         slide.style.marginRight = 'auto';
         slide.style.transform = slide.classList.contains('active') ? 'translateX(0)' : 
                                 slide.classList.contains('prev') ? 'translateX(-100%)' : 
                                 slide.classList.contains('next') ? 'translateX(100%)' : 'translateX(0)';
         
         // Ensure proper centering for slide content
         const slideContent = slide.querySelector('.mobile-slide-content');
         if (slideContent) {
           slideContent.style.marginLeft = 'auto';
           slideContent.style.marginRight = 'auto';
           slideContent.style.maxWidth = '100%';
         }
       });
       
       //console.log('Mobile slide centering fixed');
     }

     // Aggressive centering fix for users with cached centering issues
     function forceMobileSlideCentering() {
       const mobileSlides = document.querySelectorAll('.mobile-slide');
       const mobileContainer = document.querySelector('.mobile-container');
       
       // Reset container
       if (mobileContainer) {
         mobileContainer.style.left = '0';
         mobileContainer.style.right = '0';
         mobileContainer.style.marginLeft = 'auto';
         mobileContainer.style.marginRight = 'auto';
         mobileContainer.style.transform = '';
       }
       
       // Reset all slides
       mobileSlides.forEach(slide => {
         slide.style.left = '0';
         slide.style.right = '0';
         slide.style.marginLeft = 'auto';
         slide.style.marginRight = 'auto';
         slide.style.position = 'absolute';
         slide.style.width = '100%';
         
         // Reset transforms based on current state
         if (slide.classList.contains('active')) {
           slide.style.transform = 'translateX(0)';
         } else if (slide.classList.contains('prev')) {
           slide.style.transform = 'translateX(-100%)';
         } else if (slide.classList.contains('next')) {
           slide.style.transform = 'translateX(100%)';
         } else {
           slide.style.transform = 'translateX(0)';
         }
         
         // Reset slide content
         const slideContent = slide.querySelector('.mobile-slide-content');
         if (slideContent) {
           slideContent.style.marginLeft = 'auto';
           slideContent.style.marginRight = 'auto';
           slideContent.style.maxWidth = '100%';
           slideContent.style.width = '100%';
         }
       });
       
       //console.log('Forced mobile slide centering reset completed');
     }

    // Reinitialize mobile layout after settings changes
    function reinitializeMobileLayout() {
      try {
        // Force reset all mobile slides
        forceMobileSlideCentering();
        
        // Reinitialize mobile slides
        showSlide(0);
        
        // Fix streak module positioning
        fixStreakModulePositioning();
        
        // Reset mobile container
        resetMobileContainer();
        
        console.log('Mobile layout reinitialized after settings save');
      } catch (error) {
        console.error('Error reinitializing mobile layout:', error);
        // Fallback: try basic reset
        try {
          const mobileSlides = document.querySelectorAll('.mobile-slide');
          mobileSlides.forEach(slide => {
            slide.style.left = '0';
            slide.style.right = '0';
            slide.style.marginLeft = 'auto';
            slide.style.marginRight = 'auto';
            slide.style.transform = slide.classList.contains('active') ? 'translateX(0)' : 'translateX(0)';
          });
          showSlide(0);
        } catch (fallbackError) {
          console.error('Fallback mobile layout reset failed:', fallbackError);
        }
      }
    }

    // Detect and automatically fix broken layouts
    function detectAndFixBrokenLayout() {
      try {
        const mobileSlides = document.querySelectorAll('.mobile-slide');
        const mobileContainer = document.querySelector('.mobile-container');
        
        // Check if slides are misaligned (not centered)
        let needsFix = false;
        
        mobileSlides.forEach(slide => {
          const rect = slide.getBoundingClientRect();
          const containerRect = mobileContainer ? mobileContainer.getBoundingClientRect() : { left: 0, width: window.innerWidth };
          
          // Check if slide is not properly centered
          if (rect.left < containerRect.left - 50 || rect.right > containerRect.left + containerRect.width + 50) {
            needsFix = true;
          }
        });
        
        if (needsFix) {
          console.log('Broken layout detected, applying automatic fix...');
          emergencyLayoutFix();
        }
      } catch (error) {
        console.error('Error detecting broken layout:', error);
      }
    }

    // Auto-fix layout on page reload for users with broken layouts
    function autoFixLayoutOnReload() {
      try {
        console.log('Checking for layout issues on page load...');
        
        // Wait a bit for the page to fully load, then check for layout issues
        setTimeout(() => {
          const mobileSlides = document.querySelectorAll('.mobile-slide');
          const mobileContainer = document.querySelector('.mobile-container');
          
          if (mobileSlides.length > 0 && mobileContainer) {
            // Check if any slides are misaligned
            let needsFix = false;
            
            mobileSlides.forEach(slide => {
              const rect = slide.getBoundingClientRect();
              const containerRect = mobileContainer.getBoundingClientRect();
              
              // Check if slide is not properly centered or has unusual positioning
              if (rect.left < containerRect.left - 100 || 
                  rect.right > containerRect.left + containerRect.width + 100 ||
                  rect.width < containerRect.width * 0.8) {
                needsFix = true;
              }
            });
            
            if (needsFix) {
              console.log('Layout issues detected, applying automatic fix...');
              emergencyLayoutFix();
            } else {
              console.log('Layout looks good');
            }
          }
        }, 500); // Wait 500ms for page to fully load
      } catch (error) {
        console.error('Error in auto-fix layout on reload:', error);
      }
    }

    // Emergency layout fix for users with broken layouts
    function emergencyLayoutFix() {
      try {
        console.log('Running emergency layout fix...');
        
        // Reset all mobile slides
        const mobileSlides = document.querySelectorAll('.mobile-slide');
        mobileSlides.forEach(slide => {
          slide.style.left = '0';
          slide.style.right = '0';
          slide.style.marginLeft = 'auto';
          slide.style.marginRight = 'auto';
          slide.style.position = 'absolute';
          slide.style.width = '100%';
          slide.style.transform = '';
          slide.style.opacity = '';
          slide.style.display = 'none';
        });
        
        // Reset mobile container
        const mobileContainer = document.querySelector('.mobile-container');
        if (mobileContainer) {
          mobileContainer.style.left = '0';
          mobileContainer.style.right = '0';
          mobileContainer.style.marginLeft = 'auto';
          mobileContainer.style.marginRight = 'auto';
          mobileContainer.style.transform = '';
        }
        
        // Reinitialize slides
        showSlide(0);
        
        console.log('Emergency layout fix completed');
        //alert('Layout has been fixed! If you still see issues, please refresh the page.');
      } catch (error) {
        console.error('Emergency layout fix failed:', error);
        //alert('Layout fix failed. Please refresh the page.');
      }
    }

    // Make centering fix available globally for manual use
    window.fixCentering = forceMobileSlideCentering;
    window.fixStreakPositioning = fixStreakModulePositioning;
    window.reinitializeMobileLayout = reinitializeMobileLayout;
    window.emergencyLayoutFix = emergencyLayoutFix;

     // Fix streak module positioning for consistent spacing
     function fixStreakModulePositioning() {
       const streakModule = document.querySelector('.streak-module');
       const streakContainer = document.querySelector('.mobile-slide-content');
       
       if (streakModule && streakContainer) {
         // Reset streak module positioning - it's now inside mobile-slide-content
         streakModule.style.margin = '0';
         streakModule.style.position = 'relative';
         streakModule.style.top = '0px';
         
         // Ensure the container has proper positioning
         streakContainer.style.margin = '16px auto';
         
         //console.log('Streak module positioned consistently with other modules');
       }
     }
     
     function resetMobileContainer() {
       // Reset mobile container positioning to prevent "pushed up" state
       const mobileContainer = document.querySelector('.mobile-container');
       if (mobileContainer) {
         mobileContainer.style.top = '';
         mobileContainer.style.transform = '';
         mobileContainer.style.position = '';
       }
       
       // Reset all mobile slides positioning
       const mobileSlides = document.querySelectorAll('.mobile-slide');
       mobileSlides.forEach(slide => {
         slide.style.top = '';
         slide.style.transform = '';
         slide.style.position = '';
       });
       
       // Force reflow to ensure changes take effect
       mobileContainer?.offsetHeight;
     }

         // Food icon mapping
         const FOOD_MAP = new Map([
           // drinks
           ["milk","ü•õ"], ["glass of milk","ü•õ"], ["oat milk","ü•õ"], ["soy milk","ü•õ"], ["milk tea","üßã"],
           ["water","üíß"], ["juice","üßÉ"], ["apple juice","üßÉ"], ["orange juice","üßÉ"],
           ["soda","ü•§"], ["cola","ü•§"], ["soft drink","ü•§"], ["milkshake","ü•§"],
           ["coffee","‚òï"], ["latte","‚òï"], ["espresso","‚òï"], ["tea","üçµ"], ["green tea","üçµ"], ["teapot","ü´ñ"],
           ["boba","üßã"], ["bubble tea","üßã"], ["smoothie","ü•§"],
           ["beer","üç∫"], ["beers","üçª"], ["wine","üç∑"], ["champagne","üçæ"], ["sake","üç∂"], ["cocktail","üç∏"], ["tropical drink","üçπ"], ["mate","üßâ"],

           // mains and fast food
           ["burger","üçî"], ["hamburger","üçî"], ["cheeseburger","üçî"],
           ["pizza","üçï"], ["slice","üçï"],
           ["hot dog","üå≠"], ["hotdog","üå≠"],
           ["taco","üåÆ"], ["burrito","üåØ"], ["tamale","ü´î"],
           ["sandwich","ü•™"], ["wrap","üåØ"], ["flatbread","ü´ì"],
           ["fries","üçü"], ["french fries","üçü"], ["pizza fries","üçü"],
           ["dumpling","ü•ü"], ["gyoza","ü•ü"], ["bao","ü•ü"], ["bento","üç±"], ["takeout","ü•°"],
           ["sushi","üç£"], ["ramen","üçú"], ["noodles","üçú"], ["pho","üçú"], ["spaghetti","üçù"], ["pasta","üçù"],
           ["curry","üçõ"], ["curry rice","üçõ"], ["rice","üçö"], ["rice ball","üçô"], ["rice cracker","üçò"],
           ["soup","üç≤"], ["stew","üç≤"], ["bowl","ü•£"], ["fondue","ü´ï"],
           ["bbq","üçñ"], ["steak","ü•©"], ["meat","ü•©"], ["bacon","ü•ì"], ["chicken","üçó"], ["drumstick","üçó"], ["wings","üçó"],
           ["fried shrimp","üç§"], ["shrimp","üç§"], ["lobster","ü¶û"], ["crab","ü¶Ä"], ["oyster","ü¶™"], ["canned food","ü•´"],
           ["egg","ü•ö"], ["omelet","üç≥"], ["omelette","üç≥"],
           ["salad","ü•ó"], ["taco salad","ü•ó"],

           // breads and breakfast
           ["bread","üçû"], ["baguette","ü•ñ"], ["croissant","ü•ê"], ["bagel","ü•Ø"], ["pancakes","ü•û"], ["waffle","üßá"],

           // sweets
           ["donut","üç©"], ["doughnut","üç©"], ["ice cream","üç®"], ["soft serve","üç¶"], ["shaved ice","üçß"],
           ["cake","üç∞"], ["birthday cake","üéÇ"], ["cupcake","üßÅ"], ["pie","ü•ß"],
           ["cookie","üç™"], ["candy","üç¨"], ["lollipop","üç≠"], ["chocolate","üç´"], ["honey","üçØ"],

           // cheese and pantry
           ["cheese","üßÄ"], ["butter","üßà"], ["salt","üßÇ"], ["jar","ü´ô"],

           // produce
           ["apple","üçé"], ["green apple","üçè"], ["banana","üçå"], ["strawberry","üçì"], ["blueberries","ü´ê"],
           ["grapes","üçá"], ["orange","üçä"], ["lemon","üçã"], ["pear","üçê"], ["peach","üçë"], ["mango","ü•≠"],
           ["pineapple","üçç"], ["melon","üçà"], ["watermelon","üçâ"], ["kiwi","ü•ù"], ["coconut","ü••"],
           ["avocado","ü•ë"], ["tomato","üçÖ"], ["corn","üåΩ"], ["carrot","ü•ï"], ["potato","ü•î"], ["sweet potato","üç†"],
           ["mushroom","üçÑ"], ["eggplant","üçÜ"], ["cucumber","ü•í"], ["pickle","ü•í"], ["broccoli","ü•¶"], ["leafy greens","ü•¨"], ["lettuce","ü•¨"],
           ["bell pepper","ü´ë"], ["pepper","üå∂Ô∏è"], ["garlic","üßÑ"], ["onion","üßÖ"], ["beans","ü´ò"], ["peanuts","ü•ú"], ["chestnut","üå∞"], ["olive","ü´í"],

           // misc
           ["popcorn","üçø"], ["coffee beans","‚òï"], ["bento box","üç±"], ["takeout box","ü•°"]
         ]);

         // Food icon helper functions
         function normalizeTerm(s) {
           return s.toLowerCase().replace(/[-_]+/g, ' ').replace(/\s+/g, ' ').trim();
         }

         function pickEmoji(input) {
           const hasEmoji = /\p{Extended_Pictographic}/u.test(input);
           if (hasEmoji) {
             // Return the first emoji char
             const match = input.match(/\p{Extended_Pictographic}(\uFE0F\u20E3|\uFE0F|\u200D\p{Extended_Pictographic})*/u);
             if (match) return match[0];
           }
           const t = normalizeTerm(input);
           if (FOOD_MAP.has(t)) return FOOD_MAP.get(t);
           // Try simple plural trim
           if (t.endsWith('es') && FOOD_MAP.has(t.slice(0, -2))) return FOOD_MAP.get(t.slice(0, -2));
           if (t.endsWith('s') && FOOD_MAP.has(t.slice(0, -1))) return FOOD_MAP.get(t.slice(0, -1));
           // Try removing common words
           const simplified = t.replace(/^(a|an|the)\s+/g, '').replace(/\s+emoji$/g, '');
           if (FOOD_MAP.has(simplified)) return FOOD_MAP.get(simplified);
           // Light fuzzy fallback
           const keys = Array.from(FOOD_MAP.keys()).sort((a,b)=>b.length - a.length);
           for (const k of keys) {
             if (simplified.includes(k) || k.includes(simplified)) return FOOD_MAP.get(k);
           }
           return 'üçΩÔ∏è'; // Default food emoji
         }

         // Put this helper above updateCharts()
         function computeWeightSeries(weightByDate, futureDays = 3) {
           // Collect actual points, sorted
           const actualDates = Object.keys(weightByDate)
             .filter(d => typeof weightByDate[d] === 'number' && !isNaN(weightByDate[d]))
             .sort();

           if (actualDates.length === 0) {
             return { labels: [], actual: [], projected: [] };
           }

          // Build recent slice for trend (up to last 7 actual points)
          const recentDates = actualDates.slice(-7);
           const recentPoints = recentDates.map(d => ({
             date: d,
             ts: new Date(d).getTime(),
             w: weightByDate[d]
           }));

           // Average daily change
           let slopePerDay = 0;
           if (recentPoints.length >= 2) {
             const first = recentPoints[0];
             const last = recentPoints[recentPoints.length - 1];
             const days = Math.max(1, Math.round((last.ts - first.ts) / (1000 * 60 * 60 * 24)));
             slopePerDay = (last.w - first.w) / days;
           } // if only one point, slope remains 0

           // Labels = all actual dates + next N future dates
           const lastDate = new Date(actualDates[actualDates.length - 1]);
           const futureLabels = [];
           for (let i = 1; i <= futureDays; i++) {
             const d = new Date(lastDate.getTime() + i * 24 * 60 * 60 * 1000);
             futureLabels.push(d.toISOString().split('T')[0]);
           }
           const labels = [...actualDates, ...futureLabels];

           // Actual values align to labels, null for future
           const actual = labels.map(d => (weightByDate[d] ?? null));

           // Projected values: null for all past labels except the last actual index,
           // then extend using slope for future labels
           const projected = new Array(labels.length).fill(null);
           const lastIdx = actualDates.length - 1;
           const lastWeight = weightByDate[actualDates[lastIdx]];
           projected[lastIdx] = lastWeight; // anchor so the dotted line starts here
           for (let i = 1; i <= futureDays; i++) {
             projected[lastIdx + i] = lastWeight + slopePerDay * i;
           }

           return { labels, actual, projected };
     }

         function updateCharts(){
           const labels = getAllDates();

           // calories burned per day
           const burned = labels.map(d => (basalByDate[d] || 0) + (activityByDate[d] || 0));

           // calories eaten per day, now includes ALL foods
           const foodCalories = labels.map(d => computeFoodCaloriesForDate(d));

           // deficit = burned minus eaten
           const deficit = labels.map((_, i) => burned[i] - foodCalories[i]);

           // ----- Total chart (desktop) -----
           totalChart.data.labels = labels;
           const isDetailed = totalChart.data.datasets.length > 1;
           if (isDetailed) {
             totalChart.data.datasets[0].data = burned;       // Calories Burned
             totalChart.data.datasets[1].data = foodCalories; // Calories Eaten
           } else {
             totalChart.data.datasets[0].data = deficit;      // Calorie Deficit
           }
           totalChart.update();

           // ----- Total chart (mobile) -----
           mobileTotalChart.data.labels = labels;
           const isMobileDetailed = mobileTotalChart.data.datasets.length > 1;
           if (isMobileDetailed) {
             mobileTotalChart.data.datasets[0].data = burned;
             mobileTotalChart.data.datasets[1].data = foodCalories;
           } else {
             mobileTotalChart.data.datasets[0].data = deficit;
           }
           mobileTotalChart.update();

           // ----- Water Level charts -----
           // Get only water level dates, sorted
           const waterLevelDates = Object.keys(waterLevelDataByDate).sort();
           
           // Filter to last 2 months by default
           const twoMonthsAgo = new Date();
           twoMonthsAgo.setMonth(twoMonthsAgo.getMonth() - 2);
           const twoMonthsAgoStr = twoMonthsAgo.toISOString().split('T')[0];
           
           const filteredLabels = waterLevelDates.filter(date => date >= twoMonthsAgoStr);
           
           // Group by locationName for better visualization
           const locationData = {};
           const allLocations = new Set();
           
           filteredLabels.forEach(date => {
             const dayData = waterLevelDataByDate[date];
             if (dayData) {
               Object.keys(dayData).forEach(location => {
                 if (dayData[location] && dayData[location].level) {
                   const locationName = dayData[location].locationName;
                   allLocations.add(locationName);
                   if (!locationData[locationName]) {
                     locationData[locationName] = [];
                   }
                   locationData[locationName].push({
                     date: date,
                     level: dayData[location].level,
                     locationName: dayData[location].locationName
                   });
                 }
               });
             }
           });
           
           // Create datasets for each location
           const colors = ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#06b6d4', '#84cc16', '#f97316'];
           const datasets = Array.from(allLocations).map((location, index) => {
             const locationPoints = locationData[location] || [];
             const dataPoints = filteredLabels.map(date => {
               const point = locationPoints.find(p => p.date === date);
               return point ? point.level : undefined;
             });
             
             return {
               label: locationData[location]?.[0]?.locationName || location,
               data: dataPoints,
               borderColor: colors[index % colors.length],
               backgroundColor: colors[index % colors.length] + '20',
               fill: false,
               tension: 0.25,
               pointRadius: 6,
               pointHoverRadius: 9,
               spanGaps: true
             };
           });

           waterLevelChart.data.labels = filteredLabels;
           waterLevelChart.data.datasets = datasets;
           waterLevelChart.update();

           mobileWaterLevelChart.data.labels = filteredLabels;
           mobileWaterLevelChart.data.datasets = datasets;
           mobileWaterLevelChart.update();

           // ----- Food chart (mobile) -----
           mobileFoodChart.data.labels = labels;
           const isMobileFoodFat = mobileFoodChart.options.scales.y.title?.text === 'Fat Loss (lbs)';
           mobileFoodChart.data.datasets[0].data = isMobileFoodFat ? foodCalories.map(v => v/3500) : foodCalories;
           mobileFoodChart.update();

           // ----- Weight charts -----
           if (userProfile) {
             const { labels: wLabels, actual: wActual, projected: wProjected } =
               computeWeightSeries(weightByDate, 3);

             // Weight charts removed - weight module replaced with meter reads module
             // weightChart.data.labels = wLabels;
             // mobileWeightChart.data.labels = wLabels;
             // weightChart.update();
             // mobileWeightChart.update();
           }
         }

    // ===== Water Level =====
    let wctx=document.getElementById('waterChart').getContext('2d');
    let wchart=new Chart(wctx,{type:'line',data:{labels:[],datasets:[{label:'Water Level (ft)',data:[],borderColor:'#3b82f6',fill:false,tension:0.25,pointRadius:6,pointHoverRadius:9}]},options:{scales:{y:{beginAtZero:true}}}});

         function waterLevelInputs(){
       return {location: waterLocation.value, customLocation: customLocationName.value, level: +waterLevel.value, date: waterDate.value};
     }

     function saveWaterLevelInputs() {
       const inputs = waterLevelInputs();
       const today = todayStr();
       if (!waterLevelDataByDate[today]) {
         waterLevelDataByDate[today] = {};
       }
       waterLevelDataByDate[today].waterLevel = inputs;
       saveUserData();
     }

     function loadWaterLevelInputs() {
       const today = todayStr();
       if (waterLevelDataByDate[today] && waterLevelDataByDate[today].waterLevel) {
         const data = waterLevelDataByDate[today].waterLevel;
         waterLocation.value = data.location || '';
         customLocationName.value = data.customLocation || '';
         waterLevel.value = data.level || '';
         waterDate.value = data.date || today;
         previewWaterLevel();
       } else {
         // Set default values if no saved data
         waterLocation.value = '';
         customLocationName.value = '';
         waterLevel.value = '';
         waterDate.value = today;
         previewWaterLevel();
       }
     }

     function loadWaterLevelChart() {
       // This function is now handled by updateCharts() which includes the new multi-dataset structure
       // Just call updateCharts to ensure the chart is properly loaded
       updateCharts();
     }

     function loadWaterLevelHistoryChart() {
       // Clear existing chart data
       const historyChart = document.getElementById('waterHistoryChart');
       if (!historyChart) return;
       
       const hctx = historyChart.getContext('2d');
       const hchart = new Chart(hctx, {
         type: 'line',
         data: {labels: [], datasets: [{label: 'Water Level (ft)', data: [], borderColor: '#3b82f6', fill: false, tension: 0.25, pointRadius: 6, pointHoverRadius: 9}]},
         options: {scales: {y: {beginAtZero: true}}}
       });
       
       // Load water level data from Firebase - shows daily averages
       const dates = Object.keys(waterLevelDataByDate).sort();
       dates.forEach(date => {
         const dayData = waterLevelDataByDate[date];
         if (dayData) {
           let totalLevel = 0;
           let count = 0;
           Object.keys(dayData).forEach(location => {
             if (dayData[location] && dayData[location].level) {
               totalLevel += dayData[location].level;
               count++;
             }
           });
           if (count > 0) {
             hchart.data.labels.push(date);
             hchart.data.datasets[0].data.push(totalLevel / count);
           }
         }
       });
       hchart.update();
     }
    function previewWaterLevel(){
      const {location, customLocation, level, date} = waterLevelInputs();
      if(location && level > 0 && date){
        const locationName = location === 'custom' ? customLocation : location;
        waterResult.innerHTML=`<div class='math'>Preview: ${locationName} - ${level} ft on ${date}</div>`;
      } else {
        waterResult.innerHTML='';
      }
    }
         function renderWaterLevel(location, customLocation, level, date){
       const locationName = location === 'custom' ? customLocation : location;
       waterResult.innerHTML=`<div class='math'>Logged: ${locationName} - ${level} ft on ${date}</div>`;
       
       // If it's a custom location, add it to the custom locations list
       if (location === 'custom' && customLocation && !customLocations.includes(customLocation)) {
         customLocations.push(customLocation);
         updateLocationDropdowns();
       }
       
       // Save water level data to Firebase for graphs
       if (!waterLevelDataByDate[date]) {
         waterLevelDataByDate[date] = {};
       }
       
       // Store water level data by location
       waterLevelDataByDate[date][location] = {
         level: level,
         locationName: locationName,
         timestamp: new Date().toISOString()
       };
       
       saveUserData();
       
       // Update water level chart
       loadWaterLevelChart();
       
       // Update overall water level chart
       updateCharts();
       
       // Update streaks
       calculateStreaks();
       updateStreakDisplay();
       
       // Hide swipe hint if this is the user's first water level entry
       checkAndHideSwipeHint();
     }
         ['input','change'].forEach(evt=>{
       waterLocation.addEventListener(evt,()=>{
         const isCustom = waterLocation.value === 'custom';
         document.getElementById('customLocationField').classList.toggle('hidden', !isCustom);
         previewWaterLevel();
         saveWaterLevelInputs();
       });
       customLocationName.addEventListener(evt,()=>{
         previewWaterLevel();
         saveWaterLevelInputs();
       });
       waterLevel.addEventListener(evt,()=>{
         previewWaterLevel();
         saveWaterLevelInputs();
       });
       waterDate.addEventListener(evt,()=>{
         previewWaterLevel();
         saveWaterLevelInputs();
       });
     });
         waterCalc.addEventListener('click',()=>{
       const {location, customLocation, level, date} = waterLevelInputs();
       if(!location || !level || !date){waterResult.innerHTML='<p>Please enter all values</p>';return;}
       if(location === 'custom' && !customLocation){waterResult.innerHTML='<p>Please enter custom location name</p>';return;}
       renderWaterLevel(location, customLocation, level, date);
     });

    // ===== Water Level History =====
    // Chart initialization moved to loadWaterLevelHistoryChart function
    // Old renderStairs function removed - replaced with water level functionality
    // Old scalc event listener removed - replaced with water level functionality

    // ===== Workouts Menu Show/Hide =====
    const workoutMenu=document.getElementById('workoutMenu');
    const showBtn=document.getElementById('showWaterLevels');
    const toggleSection=document.getElementById('waterLevelToggleSection');

    function setShowBtnVisible(vis){ toggleSection.style.display = vis ? '' : 'none'; }
    function setMenuVisible(vis){ workoutMenu.classList.toggle('hidden', !vis); }

         showBtn.addEventListener('click',()=>{
       const willShow = workoutMenu.classList.contains('hidden');
       setMenuVisible(willShow);
       showBtn.textContent = willShow ? 'Hide Water Levels' : 'Show Water Levels';
       // Hide the toggle button when water levels are shown
       setShowBtnVisible(!willShow);
     });

         document.getElementById('hideWorkouts').addEventListener('click',()=>{
       setMenuVisible(false);
       showBtn.textContent = 'Show Water Levels';
       // Show the toggle button when water levels are hidden
       setShowBtnVisible(true);
     });

         document.getElementById('openTreadmill').addEventListener('click',()=>{
       setMenuVisible(false);
       document.getElementById('waterLevelSection').classList.remove('hidden');
       setShowBtnVisible(false);
       loadWaterLevelInputs();
       loadWaterLevelChart();
     });
         document.getElementById('openStairs').addEventListener('click',()=>{
       setMenuVisible(false);
       document.getElementById('waterHistorySection').classList.remove('hidden');
       setShowBtnVisible(false);
       loadWaterLevelHistoryChart();
     });
         document.getElementById('backFromWater').addEventListener('click',()=>{
       document.getElementById('waterLevelSection').classList.add('hidden');
       setMenuVisible(true);
       setShowBtnVisible(false);
       showBtn.textContent='Hide Water Levels';
     });
     document.getElementById('backFromWaterHistory').addEventListener('click',()=>{
       document.getElementById('waterHistorySection').classList.add('hidden');
       setMenuVisible(true);
       setShowBtnVisible(false);
       showBtn.textContent='Hide Water Levels';
     });

         // ===== Full Year Chart Update =====
     function updateChartsFullYear() {
       // Get only water level dates, sorted
       const labels = Object.keys(waterLevelDataByDate).sort();
       
       // Group by locationName for full year visualization
       const locationData = {};
       const allLocations = new Set();
       
       labels.forEach(date => {
         const dayData = waterLevelDataByDate[date];
         if (dayData) {
           Object.keys(dayData).forEach(location => {
             if (dayData[location] && dayData[location].level) {
               const locationName = dayData[location].locationName;
               allLocations.add(locationName);
               if (!locationData[locationName]) {
                 locationData[locationName] = [];
               }
               locationData[locationName].push({
                 date: date,
                 level: dayData[location].level,
                 locationName: dayData[location].locationName
               });
             }
           });
         }
       });
       
       // Create datasets for each location
       const colors = ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#06b6d4', '#84cc16', '#f97316'];
       const datasets = Array.from(allLocations).map((location, index) => {
         const locationPoints = locationData[location] || [];
         const dataPoints = labels.map(date => {
           const point = locationPoints.find(p => p.date === date);
           return point ? point.level : undefined;
         });
         
         return {
           label: locationData[location]?.[0]?.locationName || location,
           data: dataPoints,
           borderColor: colors[index % colors.length],
           backgroundColor: colors[index % colors.length] + '20',
           fill: false,
           tension: 0.25,
           pointRadius: 6,
           pointHoverRadius: 9,
           spanGaps: true
         };
       });

       waterLevelChart.data.labels = labels;
       waterLevelChart.data.datasets = datasets;
       waterLevelChart.update();

       mobileWaterLevelChart.data.labels = labels;
       mobileWaterLevelChart.data.datasets = datasets;
       mobileWaterLevelChart.update();
     }

         // ===== Show More Toggle =====
     document.getElementById('toggleFat').addEventListener('click',()=>{
       const isDetailed = totalChart.data.datasets.length > 1;
       if (isDetailed) {
         // Switch back to deficit view
         totalChart.data.datasets = [{
           label: 'Calorie Deficit',
           data: [],
           borderColor: '#6ee7b7',
           backgroundColor: 'rgba(110,231,183,.3)',
           fill: true,
           tension: 0.25
         }];
         document.getElementById('toggleFat').textContent = 'Show More';
       } else {
         // Switch to detailed view
         totalChart.data.datasets = [
           {
             label: 'Calories Burned',
             data: [],
             borderColor: '#6ee7b7',
             backgroundColor: 'rgba(110,231,183,.3)',
             fill: true,
             tension: 0.25
           },
           {
             label: 'Calories Eaten',
             data: [],
             borderColor: '#f59e0b',
             backgroundColor: 'rgba(245,158,11,.3)',
             fill: true,
             tension: 0.25
           }
         ];
         document.getElementById('toggleFat').textContent = 'Show Deficit';
       }
       updateCharts();
     });

     // Mobile show more toggles
     document.getElementById('mobileToggleFat').addEventListener('click',()=>{
       const isDetailed = mobileTotalChart.data.datasets.length > 1;
       if (isDetailed) {
         // Switch back to deficit view
         mobileTotalChart.data.datasets = [{
           label: 'Calorie Deficit',
           data: [],
           borderColor: '#6ee7b7',
           backgroundColor: 'rgba(110,231,183,.3)',
           fill: true,
           tension: 0.25
         }];
         document.getElementById('mobileToggleFat').textContent = 'Show More';
       } else {
         // Switch to detailed view
         mobileTotalChart.data.datasets = [
           {
             label: 'Calories Burned',
             data: [],
             borderColor: '#6ee7b7',
             backgroundColor: 'rgba(110,231,183,.3)',
             fill: true,
             tension: 0.25
           },
           {
             label: 'Calories Eaten',
             data: [],
             borderColor: '#f59e0b',
             backgroundColor: 'rgba(245,158,11,.3)',
             fill: true,
             tension: 0.25
           }
         ];
         document.getElementById('mobileToggleFat').textContent = 'Show Deficit';
       }
       updateCharts();
     });

     // document.getElementById('mobileToggleWeightFat').addEventListener('click',()=>{ // Removed - weight module replaced
     //   const isFat=mobileWeightChart.options.scales.y.title?.text==='Fat Loss (lbs)';
     //   mobileWeightChart.options.scales.y.title={display:true,text: isFat ? 'Weight (lbs)' : 'Fat Loss (lbs)'};
     //   updateCharts();
     // });

     document.getElementById('mobileToggleWaterLevelLocation').addEventListener('click',()=>{
       const button = document.getElementById('mobileToggleWaterLevelLocation');
       const isShowingMore = button.textContent === 'Show Less';
       
       if (isShowingMore) {
         // Switch back to 2 months view
         button.textContent = 'Show More';
         // Update chart to show 2 months
       updateCharts();
       } else {
         // Switch to full year view
         button.textContent = 'Show Less';
         // Update chart to show full year
         updateChartsFullYear();
       }
     });

     document.getElementById('mobileToggleFoodDetail').addEventListener('click',()=>{
       const isDetailed = mobileFoodChart.data.datasets.length > 1;
       if (isDetailed) {
         // Switch back to total view
         mobileFoodChart.data.datasets = [{
           label: 'Food Calories',
           data: [],
           borderColor: '#f59e0b',
           backgroundColor: 'rgba(245,158,11,.3)',
           fill: true,
           tension: 0.25
         }];
         document.getElementById('mobileToggleFoodDetail').textContent = 'Show More';
       } else {
         // Switch to detailed view showing individual foods
         const labels = getAllDates();
         const foodNames = new Set();
         
         // Collect all unique food names
         labels.forEach(date => {
           const day = foodDataByDate[date] || {};
           Object.values(day).forEach(food => {
             if (food.name) foodNames.add(food.name);
           });
         });
         
         const datasets = [];
         const colors = ['#f59e0b', '#ef4444', '#10b981', '#3b82f6', '#8b5cf6', '#f97316', '#06b6d4', '#84cc16'];
         
         Array.from(foodNames).forEach((foodName, index) => {
           const foodData = labels.map(date => {
             const day = foodDataByDate[date] || {};
             const food = Object.values(day).find(f => f.name === foodName);
             return food ? food.totalCalories : 0;
           });
           
           datasets.push({
             label: foodName,
             data: foodData,
             borderColor: colors[index % colors.length],
             backgroundColor: colors[index % colors.length] + '40',
             fill: false,
             tension: 0.25,
             pointRadius: 6,
             pointHoverRadius: 9
           });
         });
         
         mobileFoodChart.data.datasets = datasets;
         document.getElementById('mobileToggleFoodDetail').textContent = 'Show Total';
       }
       updateCharts();
     });

     document.getElementById('toggleWaterLevelLocation').addEventListener('click',()=>{
       const button = document.getElementById('toggleWaterLevelLocation');
       const isShowingMore = button.textContent === 'Show Less';
       
       if (isShowingMore) {
         // Switch back to 2 months view
         button.textContent = 'Show More';
         // Update chart to show 2 months
       updateCharts();
       } else {
         // Switch to full year view
         button.textContent = 'Show Less';
         // Update chart to show full year
         updateChartsFullYear();
       }
     });

     // document.getElementById('toggleWeightFat').addEventListener('click',()=>{ // Removed - weight module replaced
     //   const isFat=weightChart.options.scales.y.title?.text==='Fat Loss (lbs)';
     //   weightChart.options.scales.y.title={display:true,text: isFat ? 'Weight (lbs)' : 'Fat Loss (lbs)'};
     //   updateCharts();
     // });

    // Old toggle event listeners removed - replaced with water level functionality

         // ===== Manual Add Calories =====
     document.getElementById('addCaloriesBtn').addEventListener('click', showAddCaloriesModal);
     
     // Mobile button event listeners
     document.getElementById('mobileAddCaloriesBtn').addEventListener('click', showAddCaloriesModal);
     // document.getElementById('mobileAddWeightBtn').addEventListener('click', showAddWeightModal); // Removed - weight module replaced
     document.getElementById('mobileShowWaterLevels').addEventListener('click', () => {
       // Show mobile water level menu modal
       showMobileWaterLevelMenu();
     });
     document.getElementById('mobileShowFoods').addEventListener('click', () => {
       // Show mobile food menu modal
       showMobileFoodMenu();
     });
     document.getElementById('mobileOpenSettings').addEventListener('click', showSettings);
     document.getElementById('mobileDeleteAccountBtn').addEventListener('click', async () => {
       if (confirm('Are you sure you want to delete your account? This action cannot be undone.')) {
         try {
           await db.collection('users').doc(currentUser.uid).delete();
           await currentUser.delete();
           auth.signOut();
         } catch (error) {
           console.error('Error deleting account:', error);
           alert('Error deleting account. Please try again.');
         }
       }
     });
     document.getElementById('mobileLogoutBtn').addEventListener('click', () => {
       auth.signOut();
     });
     
     // Mobile water level menu event listeners
     document.getElementById('closeMobileWaterLevelMenu').addEventListener('click', hideMobileWaterLevelMenu);
     document.getElementById('mobileOpenTreadmill').addEventListener('click', () => {
       hideMobileWaterLevelMenu();
       showMobileWaterLevelModal();
     });
     document.getElementById('mobileOpenStairs').addEventListener('click', () => {
       hideMobileWaterLevelMenu();
       showMobileWaterHistoryModal();
     });
     
     // Mobile food menu event listeners
     document.getElementById('closeMobileFoodMenu').addEventListener('click', hideMobileFoodMenu);
     document.getElementById('mobileAddCustomFood').addEventListener('click', () => {
       hideMobileFoodMenu();
       showMobileCustomFoodModal();
     });
     
     // Mobile water level event listeners
     document.getElementById('closeMobileWaterLevel').addEventListener('click', hideMobileWaterLevelModal);
     
     // Mobile water level input event listeners
     document.getElementById('mobileWaterLocation').addEventListener('change', () => {
       const isCustom = document.getElementById('mobileWaterLocation').value === 'custom';
       document.getElementById('mobileCustomLocationField').classList.toggle('hidden', !isCustom);
       previewMobileWaterLevel();
     });
     
     ['input', 'change'].forEach(evt => {
       document.getElementById('mobileCustomLocationName').addEventListener(evt, previewMobileWaterLevel);
       document.getElementById('mobileWaterLevel').addEventListener(evt, previewMobileWaterLevel);
       document.getElementById('mobileWaterDate').addEventListener(evt, previewMobileWaterLevel);
     });
     document.getElementById('mobileWaterCalc').addEventListener('click', () => {
       const location = document.getElementById('mobileWaterLocation').value;
       const customLocation = document.getElementById('mobileCustomLocationName').value;
       const level = +document.getElementById('mobileWaterLevel').value;
       const date = document.getElementById('mobileWaterDate').value;
       
       if (!location || !level || !date) {
         document.getElementById('mobileWaterResult').innerHTML = '<p>Please enter all values</p>';
         return;
       }
       
       if (location === 'custom' && !customLocation) {
         document.getElementById('mobileWaterResult').innerHTML = '<p>Please enter custom location name</p>';
         return;
       }
       
       // If it's a custom location, add it to the custom locations list
       if (location === 'custom' && customLocation && !customLocations.includes(customLocation)) {
         customLocations.push(customLocation);
         updateLocationDropdowns();
       }
       
       // Save water level data to Firebase
       if (!waterLevelDataByDate[date]) {
         waterLevelDataByDate[date] = {};
       }
       
       const locationName = location === 'custom' ? customLocation : location;
       waterLevelDataByDate[date][location] = {
         level: level,
         locationName: locationName,
         timestamp: new Date().toISOString()
       };
       
       saveUserData();
       
       // Update water level chart
       loadWaterLevelChart();
       
       // Update overall water level chart
       updateCharts();
       
       // Update streak data
       calculateStreaks();
       updateStreakDisplay();
       
       // Hide swipe hint if user has logged any water levels
       checkAndHideSwipeHint();
       
       // Show success message
       document.getElementById('mobileWaterResult').innerHTML = `<div class='math'>Logged: ${locationName} - ${level} ft on ${date}</div>`;
       
       // Auto-close modal after 2 seconds
       setTimeout(() => {
         hideMobileWaterLevelModal();
       }, 2000);
     });
     
     // Mobile water history event listeners
     document.getElementById('closeMobileWaterHistory').addEventListener('click', hideMobileWaterHistoryModal);
     document.getElementById('exportWaterHistoryBtn').addEventListener('click', exportWaterLevelDataToExcel);
     document.getElementById('mobileHistoryLocation').addEventListener('change', loadMobileWaterLevelHistory);
     document.getElementById('mobileHistoryDateRange').addEventListener('change', loadMobileWaterLevelHistory);
     
    // Old mobile stairs event listener removed - replaced with water level functionality
     
    // Old mobile treadmill event listeners removed - replaced with water level functionality
     
    // Old mobile stairs intensity change listener removed - replaced with water level functionality
     

     
     // Mobile custom food event listeners
     document.getElementById('mobileCustomFoodCalc').addEventListener('click', () => {
       const name = document.getElementById('mobileCustomFoodName').value;
       const calories = +document.getElementById('mobileCustomFoodCalories').value;
       
       if (!name || !calories) {
         document.getElementById('mobileCustomFoodResult').innerHTML = '<p>Please enter both name and calories</p>';
         return;
       }
       
       if (calories <= 0) {
         document.getElementById('mobileCustomFoodResult').innerHTML = '<p>Please enter a valid calorie amount</p>';
         return;
       }
       
       const isUpdate = document.getElementById('mobileCustomFoodCalc').textContent === 'Add Food Calories';
       
       // Save custom food to Firebase
       const icon = pickEmoji(name);
       customFoods[name] = {
         name: name,
         calories: calories,
         icon: icon
       };
       
       // Also save to food data for today's tracking
       const today = todayStr();
       if (!foodDataByDate[today]) {
         foodDataByDate[today] = {};
       }
       
       // For updates, we need to find and update the existing entry
       if (isUpdate) {
         const originalName = document.getElementById('mobileCustomFoodModal').dataset.originalName;
         
         // Find the existing food entry and add to it
         Object.keys(foodDataByDate[today]).forEach(key => {
           if (foodDataByDate[today][key].name === originalName) {
             // Add to the existing calories instead of replacing
             const existingCalories = foodDataByDate[today][key].totalCalories || 0;
             const newTotalCalories = existingCalories + calories;
             
             foodDataByDate[today][key] = {
               name: name,
               calories: calories,
               quantity: 1,
               totalCalories: newTotalCalories
             };
           }
         });
       } else {
         // For new foods, add to today's data
         foodDataByDate[today][name.toLowerCase().replace(/\s+/g, '_')] = {
           name: name,
           calories: calories,
           quantity: 1,
           totalCalories: calories
         };
       }
       
       saveUserData();
       
       // Update food menu to show new custom food
       updateFoodMenu();
       
       // Update charts to show the new food calories
       updateCharts();
       
       document.getElementById('mobileCustomFoodResult').innerHTML = `<div class='math'>${isUpdate ? 'Logged' : 'Added'}: ${name} (${calories} kcal)</div>`;
       
       // Close modal after a short delay
       setTimeout(() => {
         hideMobileCustomFoodModal();
       }, 2000);
     });
     
     // Mobile custom food input event listeners
     document.getElementById('mobileCustomFoodName').addEventListener('input', updateCustomFoodIcon);
     
     // Mobile delete custom food event listener
     document.getElementById('mobileDeleteCustomFood').addEventListener('click', () => {
       const name = document.getElementById('mobileCustomFoodName').value;
       
       if (!name) {
         document.getElementById('mobileCustomFoodResult').innerHTML = '<p>Please enter a food name to delete</p>';
         return;
       }
       
       // Remove from custom foods
       delete customFoods[name];
       
       // Remove from today's food data
       const today = todayStr();
       if (foodDataByDate[today]) {
         Object.keys(foodDataByDate[today]).forEach(key => {
           if (foodDataByDate[today][key].name === name) {
             delete foodDataByDate[today][key];
           }
         });
       }
       
       saveUserData();
       updateFoodMenu();
       updateCharts();
       
       document.getElementById('mobileCustomFoodResult').innerHTML = `<div class='math'>Deleted: ${name}</div>`;
       
       // Close modal after a short delay
       setTimeout(() => {
         hideMobileCustomFoodModal();
       }, 2000);
     });
     
     // Mobile food modal close event listeners
     document.getElementById('closeMobileCustomFood').addEventListener('click', hideMobileCustomFoodModal);
     
     // Add Calories Modal Event Listeners
     document.getElementById('cancelAddCalories').addEventListener('click', hideAddCaloriesModal);
     document.getElementById('submitAddCalories').addEventListener('click', () => {
       const calories = Number(document.getElementById('caloriesAmount').value);
       const date = document.getElementById('caloriesDate').value;
       const errorDiv = document.getElementById('addCaloriesError');
       const successDiv = document.getElementById('addCaloriesSuccess');
       
       if (!calories || !date) {
         errorDiv.textContent = 'Please fill in all fields';
         errorDiv.classList.remove('hidden');
         successDiv.classList.add('hidden');
         return;
       }
       
       if (isNaN(calories)) {
         errorDiv.textContent = 'Please enter a valid number';
         errorDiv.classList.remove('hidden');
         successDiv.classList.add('hidden');
         return;
       }
       
       try {
         // Add calories for the specific date
         const d = date;
         if (!activityByDate[d]) activityByDate[d] = 0;
         activityByDate[d] += Math.round(calories);
         updateCharts();
         saveUserData();
         
         errorDiv.classList.add('hidden');
         successDiv.textContent = 'Calories updated successfully!';
         successDiv.classList.remove('hidden');
         
         setTimeout(() => {
           hideAddCaloriesModal();
         }, 1500);
       } catch (error) {
         errorDiv.textContent = error.message;
         errorDiv.classList.remove('hidden');
         successDiv.classList.add('hidden');
       }
     });

         // Initialize app
     window.addEventListener('DOMContentLoaded',()=>{
       console.log('DOM loaded, initializing app...');
       
       liftModalsToBody(); // <-- make modals visible on mobile
       
       // Prefill example values for profile setup
       document.getElementById('setupAge').value=22;
       document.getElementById('setupHeightFt').value=5;
       document.getElementById('setupHeightIn').value=9;
       document.getElementById('setupWeight').value=170;
       
       // Prefill water level form with defaults
       waterLocation.value=''; waterLevel.value=''; waterDate.value=todayStr(); previewWaterLevel();
       
       // Locations management event listeners
       document.getElementById('manageLocations').addEventListener('click', showLocationsModal);
       document.getElementById('mobileManageLocations').addEventListener('click', function() {
         console.log('Mobile manage locations button clicked');
         showLocationsModal();
       });
       document.getElementById('closeLocationsModal').addEventListener('click', hideLocationsModal);
       document.getElementById('addLocationBtn').addEventListener('click', addLocation);
       document.getElementById('newLocationName').addEventListener('keypress', function(e) {
         if (e.key === 'Enter') {
           addLocation();
         }
       });
       
       // Meter reads event listeners
       document.getElementById('showMeterReads').addEventListener('click', showMeterReadsMenu);
       document.getElementById('mobileShowMeterReads').addEventListener('click', showMeterReadsMenu);
       document.getElementById('showResidualReadings').addEventListener('click', showResidualReadingsMenu);
       document.getElementById('mobileShowResidualReadings').addEventListener('click', showResidualReadingsMenu);
       // closeMeterReadsMenu, openMeterReadsEntry, openMeterReadsHistory are created dynamically
       // closeMeterReads, meterReadsCalc, manageMeterReadsLocations are created dynamically
       // closeMeterReadsHistory, exportMeterReadsHistoryBtn, meterReadsHistoryLocation, meterReadsHistoryDateRange are created dynamically
       document.getElementById('toggleMeterReadsLocation').addEventListener('click', function() {
         const button = document.getElementById('toggleMeterReadsLocation');
         if (button.textContent === 'Show More') {
           updateMeterReadsChartsFullYear();
           button.textContent = 'Show Less';
         } else {
           updateMeterReadsCharts();
           button.textContent = 'Show More';
         }
       });
       document.getElementById('mobileToggleMeterReadsLocation').addEventListener('click', function() {
         const button = document.getElementById('mobileToggleMeterReadsLocation');
         if (button.textContent === 'Show More') {
           updateMeterReadsChartsFullYear();
           button.textContent = 'Show Less';
         } else {
           updateMeterReadsCharts();
           button.textContent = 'Show More';
         }
       });
       
       // Residual readings toggle buttons
       document.getElementById('toggleResidualReadingsLocation').addEventListener('click', function() {
         const button = document.getElementById('toggleResidualReadingsLocation');
         if (button.textContent === 'Show More') {
           updateResidualReadingsChartsFullYear();
           button.textContent = 'Show Less';
         } else {
           updateResidualReadingsCharts();
           button.textContent = 'Show More';
         }
       });
       document.getElementById('mobileToggleResidualReadingsLocation').addEventListener('click', function() {
         const button = document.getElementById('mobileToggleResidualReadingsLocation');
         if (button.textContent === 'Show More') {
           updateResidualReadingsChartsFullYear();
           button.textContent = 'Show Less';
         } else {
           updateResidualReadingsCharts();
           button.textContent = 'Show More';
         }
       });
       
       // Meter reads input change listeners are added dynamically when modal is created
       
       
                // Initialize mobile swipe functionality
       initMobileSwipe();
       
       // Initialize mobile slides
       showSlide(0);
       
       // Fix centering issues for all mobile slides
       fixMobileSlideCentering();
       
       // Force centering reset for users with cached issues
       setTimeout(() => {
         forceMobileSlideCentering();
         fixStreakModulePositioning();
       }, 100);
       
       // Reset mobile container to fix any existing "pushed up" state
       resetMobileContainer();
       
       // Initialize food menu
       updateFoodMenu();
       
       // Ensure auth modal shows for new users
       if (!currentUser) {
         setTimeout(() => {
           showAuthModal();
         }, 300);
       }
       
                // Force show auth modal initially, then let Firebase auth state take over
       setTimeout(() => {
         console.log('Initial timeout - authStateInitialized:', authStateInitialized);
         if (!authStateInitialized) {
           console.log('Showing auth modal initially');
           showAuthModal();
         }
       }, 200);
     });
  </script>
</body>
</html>